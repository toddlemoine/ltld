var Compiler,LocalLayer;Compiler=function(){class c{constructor(t){var n,o,a,h,u;for(this.program=t,this.code_saves=[],this.code="",this.code=[this.code],this.routine=new Routine,this.locals=new Locals(this),this.count=0,h=this.program.statements,n=o=0,a=h.length;o<a;n=++o)u=h[n],this.compile(u),n<this.program.statements.length-1&&this.routine.POP(u);this.routine.optimize(),this.routine.resolveLabels(),this.count+=this.routine.opcodes.length,this.routine.locals_size=this.locals.max_index}compile(t){if(t instanceof Program.Value)return this.compileValue(t);if(t instanceof Program.Operation)return this.compileOperation(t);if(t instanceof Program.Assignment)return this.compileAssignment(t);if(t instanceof Program.Variable)return this.compileVariable(t);if(t instanceof Program.Function)return this.compileFunction(t);if(t instanceof Program.FunctionCall)return this.compileFunctionCall(t);if(t instanceof Program.While)return this.compileWhile(t);if(t instanceof Program.SelfAssignment)return this.compileSelfAssignment(t);if(t instanceof Program.Braced)return this.compileBraced(t);if(t instanceof Program.CreateObject)return this.compileCreateObject(t);if(t instanceof Program.Field)return this.compileField(t);if(t instanceof Program.Negate)return this.compileNegate(t);if(t instanceof Program.For)return this.compileFor(t);if(t instanceof Program.ForIn)return this.compileForIn(t);if(t instanceof Program.Not)return this.compileNot(t);if(t instanceof Program.Return)return this.compileReturn(t);if(t instanceof Program.Condition)return this.compileCondition(t);if(t instanceof Program.Break)return this.compileBreak(t);if(t instanceof Program.Continue)return this.compileContinue(t);if(t instanceof Program.CreateClass)return this.compileCreateClass(t);if(t instanceof Program.NewCall)return this.compileNewCall(t);if(t instanceof Program.After)return this.compileAfter(t);if(t instanceof Program.Every)return this.compileEvery(t);if(t instanceof Program.Do)return this.compileDo(t);if(t instanceof Program.Sleep)return this.compileSleep(t);if(t instanceof Program.Delete)return this.compileDelete(t);throw console.info(t),"Not implemented"}compileAssignment(t){var n,o,a,h,u,p;if(t.local){if(t.field instanceof Program.Variable)return t.expression instanceof Program.Function?(h=this.locals.register(t.field.identifier),this.compile(t.expression),this.routine.arg1[this.routine.arg1.length-1].import_self=h,this.routine.STORE_LOCAL(h,t)):t.expression instanceof Program.After||t.expression instanceof Program.Do||t.expression instanceof Program.Every?(h=this.locals.register(t.field.identifier),n=this.routine.arg1.length,this.compile(t.expression),this.routine.arg1[n].import_self=h,this.routine.STORE_LOCAL(h,t)):(this.compile(t.expression),h=this.locals.register(t.field.identifier),this.routine.STORE_LOCAL(h,t));throw"illegal"}else if(t.field instanceof Program.Variable)if(this.locals.get(t.field.identifier)!=null)this.compile(t.expression),h=this.locals.get(t.field.identifier),this.routine.STORE_LOCAL(h,t);else{if(t.expression instanceof Program.CreateClass)return this.compileUpdateClass(t.expression,t.field.identifier);this.compile(t.expression),this.routine.STORE_VARIABLE(t.field.identifier,t)}else{for(o=t.field,o.expression instanceof Program.Variable?o.expression.identifier==="this"?this.routine.LOAD_THIS(o):this.locals.get(o.expression.identifier)!=null?(h=this.locals.get(o.expression.identifier),this.routine.LOAD_LOCAL_OBJECT(h,o.expression)):o.expression.identifier==="global"?this.routine.LOAD_GLOBAL(o):this.routine.LOAD_VARIABLE_OBJECT(o.expression.identifier,t):(this.compile(o.expression),this.routine.MAKE_OBJECT(t)),a=u=0,p=o.chain.length-2;u<=p;a=u+=1)this.compile(o.chain[a]),this.routine.LOAD_PROPERTY_OBJECT(o.chain[a]);return this.compile(o.chain[o.chain.length-1]),this.compile(t.expression),this.routine.STORE_PROPERTY(t)}}compileSelfAssignment(t){var n,o,a,h,u,p,d;switch(t.operation){case Token.TYPE_PLUS_EQUALS:p="ADD";break;case Token.TYPE_MINUS_EQUALS:p="SUB";break;case Token.TYPE_MULTIPLY_EQUALS:p="MUL";break;case Token.TYPE_DIVIDE_EQUALS:p="DIV";break;case Token.TYPE_MODULO_EQUALS:p="MODULO";break;case Token.TYPE_AND_EQUALS:p="BINARY_AND";break;case Token.TYPE_OR_EQUALS:p="BINARY_OR"}if(t.field instanceof Program.Variable)this.locals.get(t.field.identifier)!=null?(h=this.locals.get(t.field.identifier),this.routine.LOAD_LOCAL(h,t),this.compile(t.expression),this.routine[p](t,1),this.routine.STORE_LOCAL(h,t)):(this.routine.LOAD_VARIABLE(t.field.identifier,t),this.compile(t.expression),this.routine[p](t,1),this.routine.STORE_VARIABLE(t.field.identifier,t));else{for(o=t.field,o.expression instanceof Program.Variable?o.expression.identifier==="this"?this.routine.LOAD_THIS(o):this.locals.get(o.expression.identifier)!=null?(h=this.locals.get(o.expression.identifier),this.routine.LOAD_LOCAL_OBJECT(h,t)):o.expression.identifier==="global"?this.routine.LOAD_GLOBAL(o):this.routine.LOAD_VARIABLE_OBJECT(o.expression.identifier,t):(this.compile(o.expression),this.routine.MAKE_OBJECT(t)),a=u=0,d=o.chain.length-2;u<=d;a=u+=1)this.compile(o.chain[a]),this.routine.LOAD_PROPERTY_OBJECT(o.chain[a]);return n=o.chain[o.chain.length-1],this.compile(o.chain[o.chain.length-1]),this.routine.LOAD_PROPERTY_ATOP(t),this.compile(t.expression),this.routine[p](t,1),this.routine.STORE_PROPERTY(t)}}compileOperation(t){var n,o,a;if((o=t.operation)==="+"||o==="-"||o==="*"||o==="/"||o==="%"||o==="&"||o==="|"||o==="<<"||o===">>")switch(this.compile(t.term1),this.compile(t.term2),t.operation){case"+":this.routine.ADD(t);break;case"-":this.routine.SUB(t);break;case"*":this.routine.MUL(t);break;case"/":this.routine.DIV(t);break;case"%":this.routine.MODULO(t);break;case"&":this.routine.BINARY_AND(t);break;case"|":this.routine.BINARY_OR(t);break;case"<<":this.routine.SHIFT_LEFT(t);break;case">>":this.routine.SHIFT_RIGHT(t)}else if((a=t.operation)==="=="||a==="!="||a==="<"||a===">"||a==="<="||a===">=")switch(this.compile(t.term1),this.compile(t.term2),t.operation){case"==":this.routine.EQ(t);break;case"!=":this.routine.NEQ(t);break;case"<":this.routine.LT(t);break;case">":this.routine.GT(t);break;case"<=":this.routine.LTE(t);break;case">=":this.routine.GTE(t)}else return t.operation==="and"?(n=this.routine.createLabel("and"),this.compile(t.term1),this.routine.JUMPN_NOPOP(n,t),this.routine.POP(t),this.compile(t.term2),this.routine.setLabel(n)):t.operation==="or"?(n=this.routine.createLabel("or"),this.compile(t.term1),this.routine.JUMPY_NOPOP(n,t),this.routine.POP(t),this.compile(t.term2),this.routine.setLabel(n)):t.operation==="^"?(this.compile(t.term1),this.compile(t.term2),this.routine.BINARY_OP(c.predefined_binary_functions.pow,t)):""}compileBraced(t){this.compile(t.expression)}compileNegate(t){return t.expression instanceof Program.Value&&t.expression.type===Program.Value.TYPE_NUMBER?this.routine.LOAD_VALUE(-t.expression.value,t):(this.compile(t.expression),this.routine.NEGATE(t))}compileNot(t){return this.compile(t.expression),this.routine.NOT(t)}compileValue(t){var n,o,a;switch(t.type){case Program.Value.TYPE_NUMBER:this.routine.LOAD_VALUE(t.value,t);break;case Program.Value.TYPE_STRING:this.routine.LOAD_VALUE(t.value,t);break;case Program.Value.TYPE_ARRAY:for(this.routine.CREATE_ARRAY(t),n=o=0,a=t.value.length-1;o<=a;n=o+=1)this.routine.LOAD_VALUE(n,t),this.compile(t.value[n]),this.routine.CREATE_PROPERTY(t)}}compileVariable(t){var n,o;return o=t.identifier,o==="this"?this.routine.LOAD_THIS(t):o==="global"?this.routine.LOAD_GLOBAL(t):c.predefined_values[o]!=null?this.routine.LOAD_VALUE(c.predefined_values[o],t):this.locals.get(o)!=null?(n=this.locals.get(o),this.routine.LOAD_LOCAL(n,t)):this.routine.LOAD_VARIABLE(o,t)}compileField(t){var n,o,a,h,u,p,d,g,P;if(n=t.chain[t.chain.length-1],n instanceof Program.Value&&n.value==="type")if(t.chain.length===1)t.expression instanceof Program.Variable?(a=t.expression.identifier,this.locals.get(a)!=null?(h=this.locals.get(a),this.routine.LOAD_LOCAL(h,t),this.routine.TYPE(t)):c.predefined_values[a]!=null?this.routine.LOAD_VALUE("number",t):c.predefined_unary_functions[a]!=null||c.predefined_binary_functions[a]?this.routine.LOAD_VALUE("function",t):this.routine.VARIABLE_TYPE(a,t.expression)):(this.compile(t.expression),this.routine.TYPE(t));else{for(this.compile(t.expression),o=u=0,g=t.chain.length-3;u<=g;o=u+=1)this.compile(t.chain[o]),this.routine.LOAD_PROPERTY(t);this.compile(t.chain[t.chain.length-2]),this.routine.PROPERTY_TYPE(t.expression)}else for(this.compile(t.expression),P=t.chain,p=0,d=P.length;p<d;p++)n=P[p],this.compile(n),this.routine.LOAD_PROPERTY(t)}compileFieldParent(t){var n,o,a,h;for(this.compile(t.expression),o=a=0,h=t.chain.length-2;a<=h;o=a+=1)n=t.chain[o],this.compile(n),this.routine.LOAD_PROPERTY(t)}compileFunctionCall(t){var n,o,a,h,u,p,d,g,P,v,O,y,x,A,I,S,C,G,Y;if(t.expression instanceof Program.Field){for(I=t.args,a=u=0,g=I.length;u<g;a=++u)n=I[a],this.compile(n);return this.compileFieldParent(t.expression),this.compile(t.expression.chain[t.expression.chain.length-1]),this.routine.FUNCTION_APPLY_PROPERTY(t.args.length,t)}else if(t.expression instanceof Program.Variable){if(c.predefined_unary_functions[t.expression.identifier]!=null)return o=c.predefined_unary_functions[t.expression.identifier],t.args.length>0?this.compile(t.args[0]):this.routine.LOAD_VALUE(0,t),this.routine.UNARY_OP(o,t);if(c.predefined_binary_functions[t.expression.identifier]!=null)return o=c.predefined_binary_functions[t.expression.identifier],t.args.length>0?this.compile(t.args[0]):this.routine.LOAD_VALUE(0,t),t.args.length>1?this.compile(t.args[1]):this.routine.LOAD_VALUE(0,t),this.routine.BINARY_OP(o,t);if(t.expression.identifier==="super"){for(S=t.args,a=p=0,P=S.length;p<P;a=++p)n=S[a],this.compile(n);return this.routine.SUPER_CALL(t.args.length,t)}else if(this.locals.get(t.expression.identifier)!=null){for(C=t.args,a=d=0,v=C.length;d<v;a=++d)n=C[a],this.compile(n);return h=this.locals.get(t.expression.identifier),this.routine.LOAD_LOCAL(h,t),this.routine.FUNCTION_CALL(t.args.length,t)}else{for(G=t.args,a=x=0,O=G.length;x<O;a=++x)n=G[a],this.compile(n);return this.routine.LOAD_VALUE(t.expression.identifier,t),this.routine.FUNCTION_APPLY_VARIABLE(t.args.length,t)}}else{for(Y=t.args,A=0,y=Y.length;A<y;A++)n=Y[A],this.compile(n);return this.compile(t.expression),this.routine.FUNCTION_CALL(t.args.length,t)}}compileFor(t){var n,o,a,h,u,p;return h=this.locals.register(t.iterator),this.locals.allocate(),this.locals.allocate(),this.compile(t.range_from),this.routine.STORE_LOCAL(h,t),this.routine.POP(t),this.compile(t.range_to),t.range_by!==0?this.compile(t.range_by):this.routine.LOAD_VALUE(0,t),a=this.routine.createLabel("for_start"),n=this.routine.createLabel("for_continue"),o=this.routine.createLabel("for_end"),this.routine.FORLOOP_INIT([h,o],t),this.routine.setLabel(a),this.locals.push(),u=this.break_label,p=this.continue_label,this.break_label=o,this.continue_label=n,this.compileSequence(t.sequence),this.break_label=u,this.continue_label=p,this.routine.setLabel(n),this.routine.FORLOOP_CONTROL([h,a],t),this.routine.setLabel(o),this.locals.pop()}compileForIn(t){var n,o,a,h,u,p;return h=this.locals.register(t.iterator),this.locals.allocate(),this.locals.allocate(),this.compile(t.list),a=this.routine.createLabel("for_start"),n=this.routine.createLabel("for_continue"),o=this.routine.createLabel("for_end"),this.routine.FORIN_INIT([h,o],t),this.routine.setLabel(a),this.locals.push(),u=this.break_label,p=this.continue_label,this.break_label=o,this.continue_label=n,this.compileSequence(t.sequence),this.break_label=u,this.continue_label=p,this.routine.setLabel(n),this.routine.FORIN_CONTROL([h,a],t),this.routine.setLabel(o),this.locals.pop()}compileSequence(t){var n,o,a;for(n=o=0,a=t.length-1;o<=a;n=o+=1)t[n].nopop||this.routine.POP(t[n]),this.compile(t[n])}compileWhile(t){var n,o,a,h;return this.locals.push(),h=this.routine.createLabel("while_start"),n=this.routine.createLabel("while_end"),this.routine.LOAD_VALUE(0,t),this.routine.setLabel(h),this.compile(t.condition),this.routine.JUMPN(n),o=this.break_label,a=this.continue_label,this.break_label=n,this.continue_label=h,this.compileSequence(t.sequence),this.routine.JUMP(h,t),this.break_label=o,this.continue_label=a,this.routine.setLabel(n),this.locals.pop()}compileBreak(t){if(this.break_label!=null)return this.routine.JUMP(this.break_label)}compileContinue(t){if(this.continue_label!=null)return this.routine.JUMP(this.continue_label)}compileFunction(t){var n;return n=this.compileFunctionBody(t),this.routine.LOAD_ROUTINE(n,t)}compileFunctionBody(t){var n,o,a,h,u,p,d,g,P,v,O,y,x,A,I,S,C,G,Y;if(Y=this.routine,O=this.locals,this.routine=new Routine(t.args!=null?t.args.length:0),this.locals=new Locals(this,O),v=this.locals.index,this.routine.uses_arguments=!0,t.args!=null){for(this.routine.uses_arguments&&(o=this.locals.register("arguments"),this.routine.STORE_LOCAL(o,t),this.routine.POP(t)),x=this.locals.register("+numargs"),this.routine.STORE_LOCAL(x,t),this.routine.POP(t),a=u=I=t.args.length-1;u>=0;a=u+=-1)n=t.args[a],h=this.locals.register(n.name),this.routine.STORE_LOCAL(h,t),this.routine.POP(t);for(a=p=0,S=t.args.length-1;p<=S;a=p+=1)n=t.args[a],n.default!=null&&(h=this.locals.get(n.name),g=this.routine.createLabel("default_arg"),this.routine.LOAD_VALUE(a,t),this.routine.LOAD_LOCAL(x,t),this.routine.LT(t),this.routine.JUMPY(g,t),this.compile(n.default),this.routine.STORE_LOCAL(h,t),this.routine.POP(t),this.routine.setLabel(g))}if(t.sequence.length>0)for(a=d=0,C=t.sequence.length-1;d<=C;a=d+=1)this.compile(t.sequence[a]),a<t.sequence.length-1?this.routine.POP(t.sequence[a]):this.routine.RETURN(t.sequence[a]);else this.routine.LOAD_VALUE(0,t),this.routine.RETURN(t);for(t.args!=null&&!this.locals.arguments_used&&(this.routine.uses_arguments=!1,this.routine.remove(0),this.routine.remove(0)),h=0,G=this.locals.imports,y=0,P=G.length;y<P;y++)a=G[y],this.routine.OP_INSERT(OPCODES.LOAD_IMPORT,t,h,h*3),this.routine.OP_INSERT(OPCODES.STORE_LOCAL,t,a.index,h*3+1),this.routine.OP_INSERT(OPCODES.POP,t,0,h*3+2),this.routine.import_refs.push(a.source),h+=1;return this.routine.optimize(),this.routine.resolveLabels(),this.count+=this.routine.opcodes.length,A=this.routine,this.routine.locals_size=this.locals.max_index,this.routine=Y,this.locals=O,A}compileReturn(t){return t.expression!=null?(this.compile(t.expression),this.routine.RETURN(t)):(this.routine.LOAD_VALUE(0,t),this.routine.RETURN(t))}compileCondition(t){var n,o,a,h,u,p,d;for(o=t.chain,this.routine.LOAD_VALUE(0,t),a=this.routine.createLabel("condition_end"),u=p=0,d=o.length-1;p<=d;u=p+=1)h=this.routine.createLabel("condition_next"),n=o[u],this.compile(n.condition),this.routine.JUMPN(h),this.locals.push(),this.compileSequence(n.sequence),this.locals.pop(),this.routine.JUMP(a,t),this.routine.setLabel(h),u===o.length-1&&n.else!=null&&(this.locals.push(),this.compileSequence(n.else),this.locals.pop());this.routine.setLabel(a)}formatField(t){return t==="constructor"&&(t="_constructor"),t.toString().replace(/"/g,'\\"')}compileCreateObject(t){var n,o,a,h;for(this.routine.CREATE_OBJECT(t),h=t.fields,o=0,a=h.length;o<a;o++)n=h[o],this.routine.LOAD_VALUE(n.field,t),this.compile(n.value),this.routine.CREATE_PROPERTY(t)}compileCreateClass(t){var n,o,a,h,u;for(t.ext!=null?(t.ext.nowarning=!0,this.compile(t.ext)):this.routine.LOAD_VALUE(0,t),u=t.ext!=null&&t.ext instanceof Program.Variable?t.ext.identifier:0,this.routine.CREATE_CLASS(u,t),h=t.fields,o=0,a=h.length;o<a;o++)n=h[o],this.routine.LOAD_VALUE(n.field,t),this.compile(n.value),this.routine.CREATE_PROPERTY(t)}compileUpdateClass(t,n){return this.compileCreateClass(t),this.routine.UPDATE_CLASS(n,t)}compileNewCall(t){var n,o,a,h,u,p;for(o=t.expression,this.routine.LOAD_VALUE(0,t),p=o.args,a=h=0,u=p.length;h<u;a=++h)n=p[a],this.compile(n);return this.compile(o.expression),this.routine.NEW_CALL(o.args.length,t),this.routine.POP(t)}compileAfter(t){var n;return n=this.compileFunctionBody(t),this.routine.LOAD_ROUTINE(n,t),this.compile(t.delay),t.multiplier!=null&&t.multiplier!==1&&(this.routine.LOAD_VALUE(t.multiplier,t),this.routine.MUL(t)),this.routine.AFTER(t)}compileEvery(t){var n;return n=this.compileFunctionBody(t),this.routine.LOAD_ROUTINE(n,t),this.compile(t.delay),t.multiplier!=null&&t.multiplier!==1&&(this.routine.LOAD_VALUE(t.multiplier,t),this.routine.MUL(t)),this.routine.EVERY(t)}compileDo(t){var n;return n=this.compileFunctionBody(t),this.routine.LOAD_ROUTINE(n,t),this.routine.DO(t)}compileSleep(t){return this.compile(t.delay),t.multiplier!=null&&t.multiplier!==1&&(this.routine.LOAD_VALUE(t.multiplier,t),this.routine.MUL(t)),this.routine.SLEEP(t)}compileDelete(t){var n,o,a,h;if(t.field instanceof Program.Variable)this.routine.LOAD_THIS(t),this.routine.LOAD_VALUE(t.field.identifier,t),this.routine.DELETE(t);else{for(this.compile(t.field.expression),n=t.field.chain,o=a=0,h=n.length-1;a<=h;o=a+=1)this.compile(n[o]),o<n.length-1&&this.routine.LOAD_PROPERTY(t);this.routine.DELETE(t)}}exec(t){return this.processor=new Processor,this.processor.load(this.routine),this.processor.run(t)}}return c.predefined_unary_functions={round:Math.round,floor:Math.floor,ceil:Math.ceil,abs:Math.abs,sqrt:Math.sqrt,sin:Math.sin,cos:Math.cos,tan:Math.tan,acos:Math.acos,asin:Math.asin,atan:Math.atan,sind:function(e){return Math.sin(e*Math.PI/180)},cosd:function(e){return Math.cos(e*Math.PI/180)},tand:function(e){return Math.tan(e*Math.PI/180)},asind:function(e){return Math.asin(e)/Math.PI*180},acosd:function(e){return Math.acos(e)/Math.PI*180},atand:function(e){return Math.atan(e)/Math.PI*180},log:Math.log,exp:Math.exp},c.predefined_binary_functions={min:Math.min,max:Math.max,pow:Math.pow,atan2:Math.atan2,atan2d:function(e,t){return Math.atan2(e,t)/Math.PI*180}},c.predefined_values={PI:Math.PI,true:1,false:0},c}.call(this),this.Locals=class{constructor(e,t=null){this.compiler=e,this.parent=t,this.layers=[],this.index=0,this.max_index=0,this.push(),this.imports=[]}increment(){var e;return e=this.index++,this.max_index=Math.max(this.index,this.max_index),e}push(){return this.layers.push(new LocalLayer(this))}pop(){return this.layers.splice(this.layers.length-1,1)}register(e){return this.layers[this.layers.length-1].register(e)}allocate(){return this.layers[this.layers.length-1].allocate()}get(e){var t,n,o,a,h;for(e==="arguments"&&(this.arguments_used=!0),t=o=a=this.layers.length-1;o>=0;t=o+=-1)if(h=this.layers[t].get(e),h!=null)return h;return this.parent!=null&&(h=this.parent.get(e),h!=null)?(n=this.register(e),this.imports.push({name:e,index:n,source:h}),n):null}},LocalLayer=class{constructor(e){this.locals=e,this.start_index=this.locals.index,this.registered={}}register(e){return this.registered[e]=this.locals.increment()}allocate(){return this.locals.increment()}get(e){return this.registered[e]!=null?this.registered[e]:null}},this.Parser=function(){class c{constructor(t,n=""){this.input=t,this.filename=n,/^\s*\/\/\s*javascript\s*\n/.test(this.input)&&(this.input=`system.javascript("""

`+this.input.replace(/\\/g,"\\\\")+`

""")`),this.tokenizer=new Tokenizer(this.input,this.filename),this.program=new Program,this.current_block=[],this.current={line:1,column:1},this.verbose=!1,this.nesting=0,this.object_nesting=0,this.not_terminated=[],this.api_reserved={screen:!0,audio:!0,keyboard:!0,gamepad:!0,sprites:!0,sounds:!0,music:!0,assets:!0,asset_manager:!0,maps:!0,touch:!0,mouse:!0,fonts:!0,Sound:!0,Image:!0,Sprite:!0,Map:!0,system:!0,storage:!0,print:!0,random:!0,Function:!0,List:!0,Object:!0,String:!0,Number:!0}}nextToken(){var t;if(t=this.tokenizer.next(),t==null)throw this.unexpected_eof=!0,"Unexpected end of file";return this.current=t}nextTokenOptional(){var t;return t=this.tokenizer.next(),t!=null&&(this.current=t),t}parse(){var t,n,o,a;try{for(this.warnings=[];n=this.parseLine(),n==null&&!this.tokenizer.finished()&&(a=this.tokenizer.next(),a!=null&&a.reserved_keyword?a.value==="end"?this.error("Too many 'end'"):this.error(`Misuse of reserved keyword: '${a.value}'`):this.error("Unexpected data")),n!==null;)this.current_block.push(n),this.program.add(n),this.verbose&&console.info(n);return this}catch(h){return t=h,this.not_terminated.length>0&&t==="Unexpected end of file"?(o=this.not_terminated[this.not_terminated.length-1],this.error_info={error:`Unterminated '${o.value}' ; no matching 'end' found`,line:o.line,column:o.column}):this.error_info={error:t,line:this.current.line,column:this.current.column}}}parseLine(){var t;if(t=this.nextTokenOptional(),t==null)return null;switch(t.type){case Token.TYPE_RETURN:return new Program.Return(t,this.parseExpression());case Token.TYPE_BREAK:return new Program.Break(t);case Token.TYPE_CONTINUE:return new Program.Continue(t);case Token.TYPE_LOCAL:return this.parseLocalAssignment(t);default:return this.tokenizer.pushBack(t),this.parseExpression()}}parseExpression(t,n=!1){var o,a;if(a=this.parseExpressionStart(),a==null)return null;for(;;){if(o=this.parseExpressionSuffix(a,t),o==null)return a;if(n&&o instanceof Program.FunctionCall)return o;a=o}}assertExpression(t,n=!1){var o;if(o=this.parseExpression(t,n),o==null)throw"Expression expected";return o}parseExpressionSuffix(t,n){var o,a,h;if(h=this.nextTokenOptional(),h==null)return n==="self"?t:null;switch(h.type){case Token.TYPE_DOT:return t instanceof Program.Value&&t.type===Program.Value.TYPE_NUMBER?(this.tokenizer.pushBack(h),null):(this.tokenizer.changeNumberToIdentifier(),a=this.assertBroadIdentifier("Expected identifier"),Program.CreateFieldAccess(h,t,new Program.Value(a,Program.Value.TYPE_STRING,a.value)));case Token.TYPE_OPEN_BRACKET:return o=this.assertExpression(),this.assert(Token.TYPE_CLOSED_BRACKET,"Expected ']'"),Program.CreateFieldAccess(h,t,o);case Token.TYPE_OPEN_BRACE:return this.parseFunctionCall(h,t);case Token.TYPE_EQUALS:return this.parseAssignment(h,t);case Token.TYPE_PLUS_EQUALS:return this.parseSelfAssignment(h,t,h.type);case Token.TYPE_MINUS_EQUALS:return this.parseSelfAssignment(h,t,h.type);case Token.TYPE_MULTIPLY_EQUALS:return this.parseSelfAssignment(h,t,h.type);case Token.TYPE_DIVIDE_EQUALS:return this.parseSelfAssignment(h,t,h.type);case Token.TYPE_MODULO_EQUALS:case Token.TYPE_AND_EQUALS:case Token.TYPE_OR_EQUALS:return this.parseSelfAssignment(h,t,h.type);default:return n==="self"?(this.tokenizer.pushBack(h),t):h.is_binary_operator&&n!=="noop"?this.parseBinaryOperation(h,t):(this.tokenizer.pushBack(h),null)}}parseExpressionStart(){var t,n;if(n=this.nextTokenOptional(),n==null)return null;switch(n.type){case Token.TYPE_IDENTIFIER:return new Program.Variable(n,n.value);case Token.TYPE_NUMBER:return this.parseNumberExpression(n);case Token.TYPE_PLUS:return this.assertExpression();case Token.TYPE_MINUS:return this.parseExpressionSuffix(new Program.Negate(n,this.assertExpression("noop")),"self");case Token.TYPE_NOT:return this.parseExpressionSuffix(new Program.Not(n,this.assertExpression("noop")),"self");case Token.TYPE_STRING:return this.parseStringExpression(n);case Token.TYPE_IF:return this.parseIf(n);case Token.TYPE_FOR:return this.parseFor(n);case Token.TYPE_WHILE:return this.parseWhile(n);case Token.TYPE_OPEN_BRACE:return this.parseBracedExpression(n);case Token.TYPE_OPEN_BRACKET:return this.parseArray(n);case Token.TYPE_FUNCTION:return this.parseFunction(n);case Token.TYPE_OBJECT:return this.parseObject(n);case Token.TYPE_CLASS:return this.parseClass(n);case Token.TYPE_NEW:return this.parseNew(n);case Token.TYPE_DOT:if(t=this.assert(Token.TYPE_NUMBER,"malformed number"),!Number.isInteger(t.value))throw"malformed number";return new Program.Value(n,Program.Value.TYPE_NUMBER,Number.parseFloat(`.${t.string_value}`));case Token.TYPE_AFTER:return this.parseAfter(n);case Token.TYPE_EVERY:return this.parseEvery(n);case Token.TYPE_DO:return this.parseDo(n);case Token.TYPE_SLEEP:return this.parseSleep(n);case Token.TYPE_DELETE:return this.parseDelete(n);default:return this.tokenizer.pushBack(n),null}}parseNumberExpression(t){return new Program.Value(t,Program.Value.TYPE_NUMBER,t.value)}parseStringExpression(t){var n;return n=this.nextTokenOptional(),n==null?new Program.Value(t,Program.Value.TYPE_STRING,t.value):(this.tokenizer.pushBack(n),new Program.Value(t,Program.Value.TYPE_STRING,t.value))}parseArray(t){var n,o;for(n=[];;){if(o=this.nextToken(),o.type===Token.TYPE_CLOSED_BRACKET)return new Program.Value(t,Program.Value.TYPE_ARRAY,n);if(o.type===Token.TYPE_COMMA)continue;this.tokenizer.pushBack(o),n.push(this.assertExpression())}}parseBinaryOperation(t,n){var o,a,h;for(o=[new Program.Operation(t,t.value)],a=[n],a.push(this.assertExpression("noop"));h=this.nextTokenOptional(),h!=null;){if(!h.is_binary_operator){this.tokenizer.pushBack(h);break}o.push(new Program.Operation(h,h.value)),a.push(this.assertExpression("noop"))}return Program.BuildOperations(o,a)}parseAssignment(t,n){var o;if(!(n instanceof Program.Variable)&&!(n instanceof Program.Field))throw"Expected variable identifier or property";return this.object_nesting===0&&n instanceof Program.Variable&&this.api_reserved[n.identifier]&&this.warnings.push({type:"assigning_api_variable",identifier:n.identifier,line:t.line,column:t.column}),n instanceof Program.Field?(this.object_nesting+=1,o=new Program.Assignment(t,n,this.assertExpression()),this.object_nesting-=1):o=new Program.Assignment(t,n,this.assertExpression()),o}parseSelfAssignment(t,n,o){if(!(n instanceof Program.Variable)&&!(n instanceof Program.Field))throw"Expected variable identifier or property";return new Program.SelfAssignment(t,n,o,this.assertExpression())}parseLocalAssignment(t){var n;return n=this.assert(Token.TYPE_IDENTIFIER,"Expected identifier"),this.assert(Token.TYPE_EQUALS,"Expected '='"),new Program.Assignment(t,new Program.Variable(n,n.value),this.assertExpression(),!0)}parseBracedExpression(t){var n,o;return n=this.assertExpression(),o=this.nextToken(),o.type===Token.TYPE_CLOSED_BRACE?new Program.Braced(t,n):this.error("missing closing parenthese")}parseFunctionCall(t,n){var o,a,h;for(o=[],this.last_function_call=new Program.FunctionCall(t,n,o),this.last_function_call.argslimits=[];;){if(h=this.nextTokenOptional(),h==null)return this.error("missing closing parenthese");if(h.type===Token.TYPE_CLOSED_BRACE)return new Program.FunctionCall(h,n,o);if(h.type===Token.TYPE_COMMA)continue;this.tokenizer.pushBack(h),a=h.start,o.push(this.assertExpression()),this.last_function_call.argslimits.push({start:a,end:this.tokenizer.index-1})}}addTerminable(t){return this.not_terminated.push(t)}endTerminable(){this.not_terminated.length>0&&this.not_terminated.splice(this.not_terminated.length-1,1)}parseFunction(t){var n,o,a,h;for(this.nesting+=1,this.addTerminable(t),n=this.parseFunctionArgs(),a=[];;){if(h=this.nextToken(),h.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),new Program.Function(t,n,a,h);this.tokenizer.pushBack(h),o=this.parseLine(),o!=null?a.push(o):this.error("Unexpected data while parsing function")}}parseFunctionArgs(){var t,n,o,a;if(a=this.nextToken(),t=[],o=null,a.type!==Token.TYPE_OPEN_BRACE)return this.error("Expected opening parenthese");for(;;){if(a=this.nextToken(),a.type===Token.TYPE_CLOSED_BRACE)return t;if(a.type===Token.TYPE_COMMA){o=null;continue}else if(a.type===Token.TYPE_EQUALS&&o==="argument")n=this.assertExpression(),t[t.length-1].default=n;else if(a.type===Token.TYPE_IDENTIFIER)o="argument",t.push({name:a.value});else return this.error("Unexpected token")}}warningAssignmentCondition(t){if(t instanceof Program.Assignment)return this.warnings.push({type:"assignment_as_condition",line:t.token.line,column:t.token.column})}parseIf(t){var n,o,a,h;if(this.addTerminable(t),o={condition:this.assertExpression(),sequence:[]},this.warningAssignmentCondition(o.condition),n=[],h=this.nextToken(),h.type!==Token.TYPE_THEN)return this.error("Expected 'then'");for(;;)if(h=this.nextToken(),h.type===Token.TYPE_ELSIF)n.push(o),o={condition:this.assertExpression(),sequence:[]},this.warningAssignmentCondition(o.condition),this.assert(Token.TYPE_THEN,"Expected 'then'");else if(h.type===Token.TYPE_ELSE)o.else=[];else{if(h.type===Token.TYPE_END)return n.push(o),this.endTerminable(),new Program.Condition(t,n);if(this.tokenizer.pushBack(h),a=this.parseLine(),a==null)throw Error("Unexpected data while parsing if");o.else!=null?o.else.push(a):o.sequence.push(a)}}assert(t,n){var o;if(o=this.nextToken(),o.type!==t)throw n;return o}assertBroadIdentifier(t){var n;if(n=this.nextToken(),n.type!==Token.TYPE_IDENTIFIER&&n.reserved_keyword&&(n.type=Token.TYPE_IDENTIFIER),n.type!==Token.TYPE_IDENTIFIER)throw t;return n}error(t){throw t}parseFor(t){var n,o,a,h,u,p;return n=this.assertExpression(),n instanceof Program.Assignment?(h=n.expression,n=n.field,p=this.nextToken(),p.type!==Token.TYPE_TO?this.error("Expected 'to'"):(u=this.assertExpression(),p=this.nextToken(),p.type===Token.TYPE_BY?a=this.assertExpression():(a=0,this.tokenizer.pushBack(p)),new Program.For(t,n.identifier,h,u,a,this.parseSequence(t)))):n instanceof Program.Variable?(this.assert(Token.TYPE_IN,"Error expected keyword 'in'"),o=this.assertExpression(),new Program.ForIn(t,n.identifier,o,this.parseSequence(t))):this.error("Malformed for loop")}parseWhile(t){var n;return n=this.assertExpression(),new Program.While(t,n,this.parseSequence(t))}parseSequence(t){var n,o,a;for(t!=null&&this.addTerminable(t),this.nesting+=1,o=[];;){if(a=this.nextToken(),a.type===Token.TYPE_END)return t!=null&&this.endTerminable(),this.nesting-=1,o;this.tokenizer.pushBack(a),n=this.parseLine(),n==null&&this.error("Unexpected data"),o.push(n)}return o}parseObject(t){var n,o,a;for(this.nesting+=1,this.object_nesting+=1,this.addTerminable(t),o=[];;){if(a=this.nextToken(),a.type===Token.TYPE_END)return this.nesting-=1,this.object_nesting-=1,this.endTerminable(),new Program.CreateObject(t,o);if(a.type!==Token.TYPE_IDENTIFIER&&a.reserved_keyword&&(a.type=Token.TYPE_IDENTIFIER),a.type===Token.TYPE_STRING&&(a.type=Token.TYPE_IDENTIFIER),a.type===Token.TYPE_IDENTIFIER)this.assert(Token.TYPE_EQUALS,"Expected '='"),n=this.assertExpression(),o.push({field:a.value,value:n});else return this.error("Malformed object")}}parseClass(t){var n,o,a,h;for(this.nesting+=1,this.object_nesting+=1,this.addTerminable(t),a=[],h=this.nextToken(),h.type===Token.TYPE_EXTENDS&&(o=this.assertExpression(),h=this.nextToken());;){if(h.type===Token.TYPE_END)return this.nesting-=1,this.object_nesting-=1,this.endTerminable(),new Program.CreateClass(t,o,a);if(h.type!==Token.TYPE_IDENTIFIER&&h.reserved_keyword&&(h.type=Token.TYPE_IDENTIFIER),h.type===Token.TYPE_STRING&&(h.type=Token.TYPE_IDENTIFIER),h.type===Token.TYPE_IDENTIFIER)this.assert(Token.TYPE_EQUALS,"Expected '='"),n=this.assertExpression(),a.push({field:h.value,value:n});else return this.error("Malformed object");h=this.nextToken()}}parseNew(t){var n;return n=this.assertExpression(null,!0),new Program.NewCall(t,n)}parseAfter(t){var n,o,a,h,u;for(this.nesting+=1,this.addTerminable(t),n=this.assertExpression(),u=this.nextToken(),a=null,u.type===Token.TYPE_IDENTIFIER&&this.multipliers[u.value]&&(a=this.multipliers[u.value],u=this.nextToken()),(u==null||u.type!==Token.TYPE_DO)&&this.error("Expected keyword 'do'"),h=[];;){if(u=this.nextToken(),u.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),new Program.After(t,n,h,u,a);this.tokenizer.pushBack(u),o=this.parseLine(),o!=null?h.push(o):this.error("Unexpected data while parsing after")}}parseEvery(t){var n,o,a,h,u;for(this.nesting+=1,this.addTerminable(t),n=this.assertExpression(),u=this.nextToken(),a=null,u.type===Token.TYPE_IDENTIFIER&&this.multipliers[u.value]&&(a=this.multipliers[u.value],u=this.nextToken()),(u==null||u.type!==Token.TYPE_DO)&&this.error("Expected keyword 'do'"),h=[];;){if(u=this.nextToken(),u.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),new Program.Every(t,n,h,u,a);this.tokenizer.pushBack(u),o=this.parseLine(),o!=null?h.push(o):this.error("Unexpected data while parsing after")}}parseDo(t){var n,o,a;for(this.nesting+=1,this.addTerminable(t),o=[];;){if(a=this.nextToken(),a.type===Token.TYPE_END)return this.nesting-=1,this.endTerminable(),new Program.Do(t,o,a);this.tokenizer.pushBack(a),n=this.parseLine(),n!=null?o.push(n):this.error("Unexpected data while parsing after")}}parseSleep(t){var n,o,a;return n=this.assertExpression(),a=this.nextToken(),o=null,a!=null&&(a.type===Token.TYPE_IDENTIFIER&&this.multipliers[a.value]?o=this.multipliers[a.value]:this.tokenizer.pushBack(a)),new Program.Sleep(t,n,o)}parseDelete(t){var n;return n=this.parseExpression(),n==null||!(n instanceof Program.Variable)&&!(n instanceof Program.Field)?this.error("expecting variable name or property access after keyword `delete`"):new Program.Delete(t,n)}}return c.prototype.multipliers={millisecond:1,milliseconds:1,second:1e3,seconds:1e3,minute:6e4,minutes:6e4,hour:6e4*60,hours:6e4*60,day:6e4*60*24,days:6e4*60*24},c}.call(this),this.Processor=class yt{constructor(e){this.runner=e,this.locals=[],this.stack=[],this.call_stack=[],this.log=!1,this.time_limit=1/0,this.done=!0}load(e){return this.routine=e,this.resetState()}resetState(){return this.local_index=0,this.stack_index=-1,this.op_index=0,this.call_stack_index=0,this.global=null,this.object=this.routine.object||null,this.locals_offset=0,this.call_super=null,this.call_supername="",this.done=!1}resolveParentClass(e,t){if(e.class!=null&&typeof e.class=="string"){if(t[e.class]!=null)return e.class=t[e.class],this.resolveParentClass(e.class,t)}else if(e.class!=null)return this.resolveParentClass(e.class,t)}applyFunction(e){}routineAsFunction(e,t){var n,o;return o=new yt(this.runner),n=function(){var a,h,u,p,d,g,P;for(h=Math.min(e.num_args,arguments.length),o.load(e),u=p=0,g=h-1;p<=g;u=p+=1)o.stack[++o.stack_index]=arguments[u]||0;if(o.stack[++o.stack_index]=arguments.length,e.uses_arguments){for(a=[...arguments],u=d=0,P=a.length-1;d<=P;u=d+=1)a[u]==null&&(a[u]=0);o.stack[++o.stack_index]=a}return o.run(t)},n}routineAsApplicableFunction(e,t){var n,o;return o=new yt(this.runner),n=function(){var a,h,u,p,d,g,P,v;for(h=e.num_args,o.load(e),o.object=this,u=p=0,g=h-1;p<=g;u=p+=1)o.stack[++o.stack_index]=arguments[u]||0;if(o.stack[++o.stack_index]=arguments.length,e.uses_arguments){for(a=[...arguments],u=d=0,P=a.length-1;d<=P;u=d+=1)a[u]==null&&(a[u]=0);o.stack[++o.stack_index]=a}return o.run(t),v=o.stack[0]},n}argToNative(e,t){return e instanceof Routine?this.routineAsFunction(e,t):e??0}modulo(e,t,n){var o,a;if(Array.isArray(t))a=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t%=n,isFinite(t)?t:0;a=e.global.String}else a=t;for(o=a["%"];o==null&&a.class!=null;)a=a.class,o=a["%"];return o==null&&(o=e.global.Object["%"]),o!=null&&o instanceof Routine?(o.as_function==null&&(o.as_function=this.routineAsApplicableFunction(o,e)),o=o.as_function,o.call(e.global,t,n)):0}add(e,t,n,o){var a,h;for(Array.isArray(t)?h=e.global.List:typeof t=="string"?h=e.global.String:h=t,a=h["+"];a==null&&h.class!=null;)h=h.class,a=h["+"];if(a==null&&(a=e.global.Object["+"]),a!=null){if(a instanceof Routine)return a.as_function==null&&(a.as_function=this.routineAsApplicableFunction(a,e)),a=a.as_function,a.call(e.global,t,n,o);if(typeof a=="function")return a.call(e.global,t,n,o)}else return 0}sub(e,t,n,o){var a,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t-=n,isFinite(t)?t:0;h=e.global.String}else h=t;for(a=h["-"];a==null&&h.class!=null;)h=h.class,a=h["-"];if(a==null&&(a=e.global.Object["-"]),a!=null){if(a instanceof Routine)return a.as_function==null&&(a.as_function=this.routineAsApplicableFunction(a,e)),a=a.as_function,a.call(e.global,t,n,o);if(typeof a=="function")return a.call(e.global,t,n,o)}else return 0}negate(e,t){var n,o;if(Array.isArray(t))o=e.global.List;else if(typeof t=="string"){if(isFinite(t))return-t;o=e.global.String}else o=t;for(n=o["-"];n==null&&o.class!=null;)o=o.class,n=o["-"];if(n==null&&(n=e.global.Object["-"]),n!=null){if(n instanceof Routine)return n.as_function==null&&(n.as_function=this.routineAsApplicableFunction(n,e)),n=n.as_function,n.call(e.global,0,t);if(typeof n=="function")return n.call(e.global,0,t)}else return 0}mul(e,t,n,o){var a,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t*=n,isFinite(t)?t:0;h=e.global.String}else h=t;for(a=h["*"];a==null&&h.class!=null;)h=h.class,a=h["*"];if(a==null&&(a=e.global.Object["*"]),a!=null){if(a instanceof Routine)return a.as_function==null&&(a.as_function=this.routineAsApplicableFunction(a,e)),a=a.as_function,a.call(e.global,t,n,o);if(typeof a=="function")return a.call(e.global,t,n,o)}else return 0}div(e,t,n,o){var a,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t/=n,isFinite(t)?t:0;h=e.global.String}else h=t;for(a=h["/"];a==null&&h.class!=null;)h=h.class,a=h["/"];if(a==null&&(a=e.global.Object["/"]),a!=null){if(a instanceof Routine)return a.as_function==null&&(a.as_function=this.routineAsApplicableFunction(a,e)),a=a.as_function,a.call(e.global,t,n,o);if(typeof a=="function")return a.call(e.global,t,n,o)}else return 0}band(e,t,n,o){var a,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t&=n,isFinite(t)?t:0;h=e.global.String}else h=t;for(a=h["&"];a==null&&h.class!=null;)h=h.class,a=h["&"];if(a==null&&(a=e.global.Object["&"]),a!=null){if(a instanceof Routine)return a.as_function==null&&(a.as_function=this.routineAsApplicableFunction(a,e)),a=a.as_function,a.call(e.global,t,n,o);if(typeof a=="function")return a.call(e.global,t,n,o)}else return 0}bor(e,t,n,o){var a,h;if(Array.isArray(t))h=e.global.List;else if(typeof t=="string"){if(isFinite(t))return t|=n,isFinite(t)?t:0;h=e.global.String}else h=t;for(a=h["|"];a==null&&h.class!=null;)h=h.class,a=h["|"];if(a==null&&(a=e.global.Object["|"]),a!=null){if(a instanceof Routine)return a.as_function==null&&(a.as_function=this.routineAsApplicableFunction(a,e)),a=a.as_function,a.call(e.global,t,n,o);if(typeof a=="function")return a.call(e.global,t,n,o)}else return 0}run(e){var t,n,o,a,h,u,p,d,g,P,v,O,y,x,A,I,S,C,G,Y,L,J,Q,U,N,V,X,lt,st,ht,$,pt,q,B,Z,nt,dt,_t,F,ut,R,W,tt,E,K,mt,gt,Tt,ct,ot,Ot,Yt,Ut,vt,wt,Bt,At,Rt,xt,jt,Lt,St,Vt,Ct,Dt,et,rt,M,Et,It,kt,T,_,H,at,D,bt,w,it,Pt;for(M=this.routine,K=this.routine.opcodes,n=this.routine.arg1,$=K.length,E=this.op_index,T=this.stack,_=this.stack_index,q=this.locals,pt=this.local_index,S=this.global||e.global,W=this.object||S,p=this.call_stack,d=this.call_stack_index,g=this.call_super||S,P=this.call_supername||"",B=this.locals_offset,tt=0,rt=-1;E<$;)switch(K[E]){case 1:switch(w=T[_],typeof w){case"number":T[_]="number";break;case"string":T[_]="string";break;case"function":T[_]="function";break;case"object":Array.isArray(w)?T[_]="list":w instanceof Routine?T[_]="function":T[_]="object"}E++;break;case 2:if(w=W[n[E]],w==null&&(w=S[n[E]]),w==null)T[++_]=0;else switch(typeof w){case"number":T[++_]="number";break;case"string":T[++_]="string";break;case"function":T[++_]="function";break;default:Array.isArray(w)?T[++_]="list":w instanceof Routine?T[++_]="function":T[++_]="object"}E++;break;case 3:if(w=T[_-1][T[_]],w==null)T[--_]=0;else switch(typeof w){case"number":T[--_]="number";break;case"string":T[--_]="string";break;case"function":T[--_]="function";break;default:Array.isArray(w)?T[--_]="list":w instanceof Routine?T[--_]="function":T[--_]="object"}E++;break;case 4:T[++_]=M.import_values[n[E++]];break;case 5:T[++_]=W,E++;break;case 6:T[++_]=S,E++;break;case 10:T[++_]=n[E++];break;case 11:T[++_]=q[B+n[E++]];break;case 12:if(F=n[E],w=W[F],w==null&&W.class!=null)for(R=W;w==null&&R.class!=null;)R=R.class,w=R[F];w==null&&(w=S[F]),w==null&&!M.ref[E].nowarning&&(D=M.ref[E].token,L=D.tokenizer.filename+"-"+D.line+"-"+D.column,e.warnings.using_undefined_variable[L]||(e.warnings.using_undefined_variable[L]={file:D.tokenizer.filename,line:D.line,column:D.column,expression:F})),T[++_]=w??0,E++;break;case 13:ut=q[B+n[E]],typeof ut!="object"&&(ut=q[B+n[E]]={},D=M.ref[E].token,L=D.tokenizer.filename+"-"+D.line+"-"+D.column,e.warnings.assigning_field_to_undefined[L]||(e.warnings.assigning_field_to_undefined[L]={file:D.tokenizer.filename,line:D.line,column:D.column,expression:D.value})),T[++_]=ut,E++;break;case 14:for(F=n[E],R=W,w=R[F];w==null&&R.class!=null;)R=R.class,w=R[F];w==null&&S[F]!=null&&(R=S,w=S[F]),(w==null||typeof w!="object")&&(w=R[F]={},D=M.ref[E].token,L=D.tokenizer.filename+"-"+D.line+"-"+D.column,e.warnings.assigning_field_to_undefined[L]||(e.warnings.assigning_field_to_undefined[L]={file:D.tokenizer.filename,line:D.line,column:D.column,expression:n[E]})),T[++_]=w,E++;break;case 15:_--,E++;break;case 16:for(R=T[_-1],F=T[_],w=R[F];w==null&&R.class!=null;)R=R.class,w=R[F];T[--_]=w??0,E++;break;case 17:w=T[_-1][T[_]],typeof w!="object"&&(w=T[_-1][T[_]]={},D=M.ref[E].token,L=D.tokenizer.filename+"-"+D.line+"-"+D.column,e.warnings.assigning_field_to_undefined[L]||(e.warnings.assigning_field_to_undefined[L]={file:D.tokenizer.filename,line:D.line,column:D.column,expression:T[_]})),T[--_]=w,E++;break;case 18:T[++_]={},E++;break;case 19:typeof T[_]!="object"&&(T[_]={}),E++;break;case 20:T[++_]=[],E++;break;case 21:q[B+n[E]]=T[_],E++;break;case 22:q[B+n[E]]=T[_--],E++;break;case 23:W[n[E++]]=T[_];break;case 24:R=T[_-2],I=T[_-1],R[I]=T[_],_-=2,E++;break;case 25:R=T[_-2],I=T[_-1],T[_-2]=R[I]=T[_],_-=2,E++;break;case 26:R=T[_-1],I=T[_],delete R[I],T[_-=1]=0,E++;break;case 27:if(F=n[E],W[F]!=null&&typeof W[F]=="object"){R=W[F],kt=T[_];for(lt in kt)it=kt[lt],R[lt]=it}else W[F]=T[_];E++;break;case 28:et={},gt=T[_],gt?et.class=gt:n[E]&&(et.class=n[E]),T[_]=et,E++;break;case 29:if(u=T[_],o=n[E],typeof u=="function"){for(t=[],C=V=0,Ot=o-1;V<=Ot;C=V+=1)t.push(T[_-o+C]);_-=o,T[_-1]=new u(...t),E++}else{for(this.resolveParentClass(u,S),et={class:u},v=u.constructor;!v&&u.class!=null;)u=u.class,v=u.constructor;if(v!=null&&v instanceof Routine){if(T[_-o-1]=et,_--,O=p[d]||(p[d]={}),d++,O.routine=M,O.object=W,O.super=g,O.supername=P,O.op_index=E+1,B+=M.locals_size,M=v,K=v.opcodes,n=v.arg1,E=0,$=K.length,W=et,g=u,P="constructor",M.uses_arguments&&(a=T.slice(_-o+1,_+1)),o<v.num_args)for(C=X=Yt=o+1,Rt=v.num_args;X<=Rt;C=X+=1)T[++_]=0;else o>v.num_args&&(_-=o-v.num_args);T[++_]=o,M.uses_arguments&&(T[++_]=a)}else _-=o,T[_-1]=et,E++}break;case 30:h=T[_--],t=T[_],typeof t=="number"?(t+=h,T[_]=isFinite(t)||typeof h=="string"?t:0):T[_]=this.add(e,t,h,n[E]),E++;break;case 31:h=T[_--],t=T[_],typeof t=="number"?(t-=h,T[_]=isFinite(t)?t:0):T[_]=this.sub(e,t,h,n[E]),E++;break;case 32:h=T[_--],t=T[_],typeof t=="number"?(t*=h,T[_]=isFinite(t)?t:0):T[_]=this.mul(e,t,h),E++;break;case 33:h=T[_--],t=T[_],typeof t=="number"?(t/=h,T[_]=isFinite(t)?t:0):T[_]=this.div(e,t,h),E++;break;case 34:h=T[_--],t=T[_],typeof t=="number"&&typeof h=="number"?(t%=h,T[_]=isFinite(t)?t:0):T[_]=this.modulo(e,t,h),E++;break;case 35:h=T[_--],t=T[_],typeof t=="number"?(t&=h,T[_]=isFinite(t)?t:0):T[_]=this.band(e,t,h),E++;break;case 36:h=T[_--],t=T[_],typeof t=="number"?(t|=h,T[_]=isFinite(t)?t:0):T[_]=this.bor(e,t,h),E++;break;case 37:w=T[_-1]<<T[_],T[--_]=isFinite(w)?w:0,E++;break;case 38:w=T[_-1]>>T[_],T[--_]=isFinite(w)?w:0,E++;break;case 39:t=T[_],typeof t=="number"?T[_]=-t:T[_]=this.negate(e,t),E++;break;case 50:T[_]=T[_]?0:1,E++;break;case 68:for(R=T[_-1],F=T[_],w=R[F];w==null&&R.class!=null;)R=R.class,w=R[F];T[++_]=w??0,E++;break;case 40:T[_-1]=T[_]===T[_-1]?1:0,_--,E++;break;case 41:T[_-1]=T[_]!==T[_-1]?1:0,_--,E++;break;case 42:T[_-1]=T[_-1]<T[_]?1:0,_--,E++;break;case 43:T[_-1]=T[_-1]>T[_]?1:0,_--,E++;break;case 44:T[_-1]=T[_-1]<=T[_]?1:0,_--,E++;break;case 45:T[_-1]=T[_-1]>=T[_]?1:0,_--,E++;break;case 95:U=n[E][0],nt=q[B+U+1]=T[_-1],Z=T[_],N=q[B+U],T[--_]=0,Z===0?(q[B+U+2]=nt>N?1:-1,E++):(q[B+U+2]=Z,Z>0&&N>nt||Z<0&&N<nt?E=n[E][1]:E++);break;case 96:U=n[E][0],Z=q[B+U+2],nt=q[B+U+1],N=q[B+U],N+=Z,Z>0&&N>nt||Z<0&&N<nt?E++:(q[B+U]=N,E=n[E][1]),tt++>100&&(tt=0,Date.now()>this.time_limit&&(rt=E,E=$));break;case 97:w=T[_],T[_]=0,N=n[E][0],typeof w=="object"?Array.isArray(w)?q[B+N+1]=w:w=q[B+N+1]=Object.keys(w):typeof w=="string"?w=q[B+N+1]=w.split(""):w=q[B+N+1]=[],w.length===0?E=n[E][1]:(it=w[0],q[B+n[E][0]]=it??0,q[B+N+2]=0,E++);break;case 98:N=n[E][0],J=q[B+N+2]+=1,w=q[B+N+1],J<w.length?(it=w[J],q[B+N]=it??0,E=n[E][1]):E++,tt++>100&&(tt=0,Date.now()>this.time_limit&&(rt=E,E=$));break;case 80:E=n[E],tt++>100&&(tt=0,Date.now()>this.time_limit&&(rt=E,E=$));break;case 81:T[_--]?E=n[E]:E++;break;case 82:T[_--]?E++:E=n[E];break;case 83:T[_]?E=n[E]:E++;break;case 84:T[_]?E++:E=n[E];break;case 89:for(ct=n[E++],ot=ct.clone(),xt=ct.import_refs,st=0,ht=xt.length;st<ht;st++)Q=xt[st],Q===ct.import_self?ot.import_values.push(ot):ot.import_values.push(q[B+Q]);ot.object=W,T[++_]=ot;break;case 90:if(o=n[E],x=T[_],x instanceof Routine){if(_--,O=p[d]||(p[d]={}),d++,O.routine=M,O.object=W,O.super=g,O.supername=P,O.op_index=E+1,B+=M.locals_size,M=x,K=x.opcodes,n=x.arg1,E=0,$=K.length,W=M.object!=null?M.object:S,g=S,P="",M.uses_arguments&&(a=T.slice(_-o+1,_+1)),o<x.num_args)for(C=dt=jt=o+1,Lt=x.num_args;dt<=Lt;C=dt+=1)T[++_]=0;else o>x.num_args&&(_-=o-x.num_args);T[++_]=o,M.uses_arguments&&(T[++_]=a)}else if(typeof x=="function"){switch(o){case 0:try{w=x()}catch(z){y=z,console.error(y),w=0}T[_]=w??0;break;case 1:try{w=x(this.argToNative(T[_-1],e))}catch(z){y=z,console.error(y),w=0}T[_-1]=w??0,_-=1;break;default:for(a=[],_-=o,C=_t=0,St=o-1;_t<=St;C=_t+=1)a[C]=this.argToNative(T[_+C],e);try{w=x.apply(null,a)}catch(z){y=z,console.error(y),w=0}T[_]=w??0}E++}else _-=o,T[_]=x??0,D=M.ref[E].token,L=D.tokenizer.filename+"-"+D.line+"-"+D.column,e.warnings.invoking_non_function[L]||(A=M.ref[E],G=A.expression.token.start,Y=A.token.start+A.token.length,e.warnings.invoking_non_function[L]={file:D.tokenizer.filename,line:D.line,column:D.column,expression:A.token.tokenizer.input.substring(G,Y)}),E++;break;case 91:if(F=T[_],H=R=W,x=R[F],x==null){for(;x==null&&H.class!=null;)H=H.class,x=H[F];x==null&&(x=S.Object[F]),x==null&&(x=S[F],H=S,R=S)}if(o=n[E],x instanceof Routine){if(_-=1,O=p[d]||(p[d]={}),d++,O.routine=M,O.object=W,O.super=g,O.supername=P,O.op_index=E+1,B+=M.locals_size,M=x,K=x.opcodes,n=x.arg1,E=0,$=K.length,W=R,g=H,P=F,M.uses_arguments&&(a=T.slice(_-o+1,_+1)),o<x.num_args)for(C=mt=Vt=o+1,Ct=x.num_args;mt<=Ct;C=mt+=1)T[++_]=0;else o>x.num_args&&(_-=o-x.num_args);T[++_]=o,M.uses_arguments&&(T[++_]=a)}else if(typeof x=="function"){switch(o){case 0:try{w=x.call(R)}catch(z){y=z,console.error(y),w=0}T[_]=w??0;break;case 1:try{w=x.call(R,this.argToNative(T[_-1],e))}catch(z){y=z,console.error(y),w=0}T[--_]=w??0;break;default:for(a=[],_-=o,C=Tt=0,Dt=o-1;Tt<=Dt;C=Tt+=1)a[C]=this.argToNative(T[_+C],e);try{w=x.apply(R,a)}catch(z){y=z,console.error(y),w=0}T[_]=w??0}E++}else _-=o,T[_]=x??0,D=M.ref[E].token,L=D.tokenizer.filename+"-"+D.line+"-"+D.column,e.warnings.invoking_non_function[L]||(A=M.ref[E],G=A.expression.token.start,Y=A.token.start+A.token.length,e.warnings.invoking_non_function[L]={file:D.tokenizer.filename,line:D.line,column:D.column,expression:A.token.tokenizer.input.substring(G,Y)}),E++;break;case 92:for(R=T[_-1],H=R,F=T[_],x=R[F];x==null&&H.class!=null;)H=H.class,x=H[F];if(o=n[E],x==null&&(R instanceof Routine?x=S.Function[F]:typeof R=="string"?x=S.String[F]:typeof R=="number"?x=S.Number[F]:Array.isArray(R)?x=S.List[F]:typeof R=="object"&&(x=S.Object[F])),x instanceof Routine){if(_-=2,O=p[d]||(p[d]={}),d++,O.object=W,O.super=g,O.supername=P,O.routine=M,O.op_index=E+1,B+=M.locals_size,M=x,K=x.opcodes,n=x.arg1,E=0,$=K.length,W=R,g=H,P=F,M.uses_arguments&&(a=T.slice(_-o+1,_+1)),o<x.num_args)for(C=Et=Ut=o+1,vt=x.num_args;Et<=vt;C=Et+=1)T[++_]=0;else o>x.num_args&&(_-=o-x.num_args);T[++_]=o,M.uses_arguments&&(T[++_]=a)}else if(typeof x=="function"){switch(o){case 0:try{w=x.call(R)}catch(z){y=z,console.error(y),w=0}T[--_]=w??0;break;case 1:try{w=x.call(R,this.argToNative(T[_-2],e))}catch(z){y=z,console.error(y),w=0}T[_-2]=w??0,_-=2;break;default:for(a=[],_-=o+1,C=bt=0,wt=o-1;bt<=wt;C=bt+=1)a[C]=this.argToNative(T[_+C],e);try{w=x.apply(R,a)}catch(z){y=z,console.error(y),w=0}T[_]=w??0}E++}else _-=o+1,T[_]=x??0,D=M.ref[E].token,L=D.tokenizer.filename+"-"+D.line+"-"+D.column,e.warnings.invoking_non_function[L]||(A=M.ref[E],G=A.expression.token.start,Y=A.token.start+A.token.length,e.warnings.invoking_non_function[L]={file:D.tokenizer.filename,line:D.line,column:D.column,expression:A.token.tokenizer.input.substring(G,Y)}),E++;break;case 93:if(g!=null&&P!=null){for(H=g,x=null;x==null&&H.class!=null;)H=H.class,x=H[P];if(x!=null&&x instanceof Routine){if(o=n[E],O=p[d]||(p[d]={}),d++,O.object=W,O.super=g,O.supername=P,O.routine=M,O.op_index=E+1,B+=M.locals_size,M=x,K=x.opcodes,n=x.arg1,E=0,$=K.length,g=H,M.uses_arguments&&(a=T.slice(_-o+1,_+1)),o<x.num_args)for(C=Pt=Bt=o+1,At=x.num_args;Pt<=At;C=Pt+=1)T[++_]=0;else o>x.num_args&&(_-=o-x.num_args);T[++_]=o,M.uses_arguments&&(T[++_]=a)}else o=n[E],_-=o,T[++_]=0,E++}else o=n[E],_-=o,T[++_]=0,E++;break;case 94:pt-=n[E],d<=0?E=$:(O=p[--d],W=O.object,g=O.super,P=O.supername,M=O.routine,E=O.op_index,K=M.opcodes,n=M.arg1,B-=M.locals_size,$=K.length);break;case 100:w=n[E](T[_]),T[_]=isFinite(w)?w:0,E++;break;case 101:w=n[E](T[_-1],T[_]),T[--_]=isFinite(w)?w:0,E++;break;case 110:at=this.runner.createThread(T[_-1],T[_],!1),T[--_]=at,E+=1;break;case 111:at=this.runner.createThread(T[_-1],T[_],!0),T[--_]=at,E+=1;break;case 112:at=this.runner.createThread(T[_],0,!1),T[_]=at,E+=1;break;case 113:It=isFinite(T[_])?T[_]:0,this.runner.sleep(It),E+=1,rt=E,E=$;break;case 200:_=n[E](T,_,q,B,W,S),E++;break;default:throw`Unsupported operation: ${K[E]}`}return rt>=0?(this.op_index=rt,this.routine=M,this.stack_index=_,this.local_index=pt,this.object=W,this.call_stack_index=d,this.call_super=g,this.call_supername=P,this.locals_offset=B,this.done=!1):(this.op_index=0,this.done=!0,this.routine.callback!=null&&(this.routine.callback(T[_]),this.routine.callback=null)),this.log&&(console.info("total operations: "+tt),console.info(`stack_index: ${_}`),console.info(`result: ${T[_]}`)),T[_]}},this.Program=class Mt{constructor(){this.statements=[]}add(e){return this.statements.push(e)}isAssignment(){return this.statements.length>0&&this.statements[this.statements.length-1]instanceof Mt.Assignment}},this.Program.Expression=class{constructor(){}},this.Program.Assignment=class{constructor(e,t,n,o){this.token=e,this.field=t,this.expression=n,this.local=o}},this.Program.SelfAssignment=class{constructor(e,t,n,o){this.token=e,this.field=t,this.operation=n,this.expression=o}},this.Program.Value=function(){class c{constructor(t,n,o){this.token=t,this.type=n,this.value=o}}return c.TYPE_NUMBER=1,c.TYPE_STRING=2,c.TYPE_ARRAY=3,c.TYPE_OBJECT=4,c.TYPE_FUNCTION=5,c.TYPE_CLASS=6,c}.call(this),this.Program.CreateFieldAccess=function(c,e,t){return e instanceof Program.Field?(e.appendField(t),e):new Program.Field(c,e,[t])},this.Program.Variable=class{constructor(e,t){this.token=e,this.identifier=t}},this.Program.Field=class{constructor(e,t,n){this.token=e,this.expression=t,this.chain=n,this.token=this.expression.token}appendField(e){return this.chain.push(e)}},this.Program.BuildOperations=function(c,e){for(var t,n,o,a,h,u,p;c.length>1;){for(t=0,h=0;t<c.length-1&&(o=c[t],a=c[t+1],!(Program.Precedence[a.operation]<=Program.Precedence[o.operation]));)t++;u=e[t],p=e[t+1],n=new Program.Operation(c[t].token,c[t].operation,u,p),e.splice(t,2,n),c.splice(t,1)}return new Program.Operation(c[0].token,c[0].operation,e[0],e[1])},this.Program.Operation=class{constructor(e,t,n,o){this.token=e,this.operation=t,this.term1=n,this.term2=o}},this.Program.Negate=class{constructor(e,t){this.token=e,this.expression=t}},this.Program.Not=class{constructor(e,t){this.token=e,this.expression=t}},this.Program.Braced=class{constructor(e,t){this.token=e,this.expression=t}},this.Program.Return=class{constructor(e,t){this.token=e,this.expression=t}},this.Program.Condition=class{constructor(e,t){this.token=e,this.chain=t}},this.Program.For=class{constructor(e,t,n,o,a,h){this.token=e,this.iterator=t,this.range_from=n,this.range_to=o,this.range_by=a,this.sequence=h}},this.Program.ForIn=class{constructor(e,t,n,o){this.token=e,this.iterator=t,this.list=n,this.sequence=o}},this.Program.toString=function(c,e=0){var t,n,o,a,h,u,p,d,g;if(c instanceof Routine)return e===0&&c.source||"[function]";if(typeof c=="function")return"[native function]";if(typeof c=="string")return`"${c}"`;if(Array.isArray(c)){if(e>=1)return"[list]";for(d="[",t=n=0,h=c.length;n<h;t=++n)g=c[t],d+=Program.toString(g,e+1)+(t<c.length-1?",":"");return d+"]"}else if(typeof c=="object"){if(e>=1)return"[object]";for(d=`object
`,u="",t=o=1,p=e;o<=p;t=o+=1)u+="  ";for(a in c)g=c[a],d+=u+`  ${a} = ${Program.toString(g,e+1)}
`;return d+u+"end"}return c||0},this.Program.While=class{constructor(e,t,n){this.token=e,this.condition=t,this.sequence=n}},this.Program.Break=class{constructor(e){this.token=e,this.nopop=!0}},this.Program.Continue=class{constructor(e){this.token=e,this.nopop=!0}},this.Program.Function=class{constructor(e,t,n,o){this.token=e,this.args=t,this.sequence=n,this.source="function"+this.token.tokenizer.input.substring(this.token.index,o.index+2)}},this.Program.FunctionCall=class{constructor(e,t,n){this.token=e,this.expression=t,this.args=n}},this.Program.CreateObject=class{constructor(e,t){this.token=e,this.fields=t}},this.Program.CreateClass=class{constructor(e,t,n){this.token=e,this.ext=t,this.fields=n}},this.Program.NewCall=class{constructor(e,t){this.token=e,this.expression=t,this.expression instanceof Program.FunctionCall||(this.expression=new Program.FunctionCall(this.token,this.expression,[]))}},this.Program.After=class{constructor(e,t,n,o,a){this.token=e,this.delay=t,this.sequence=n,this.multiplier=a,this.source="after "+this.token.tokenizer.input.substring(this.token.index,o.index+2)}},this.Program.Every=class{constructor(e,t,n,o,a){this.token=e,this.delay=t,this.sequence=n,this.multiplier=a,this.source="every "+this.token.tokenizer.input.substring(this.token.index,o.index+2)}},this.Program.Do=class{constructor(e,t,n){this.token=e,this.sequence=t,this.source="do "+this.token.tokenizer.input.substring(this.token.index,n.index+2)}},this.Program.Sleep=class{constructor(e,t,n){this.token=e,this.delay=t,this.multiplier=n}},this.Program.Delete=class{constructor(e,t){this.token=e,this.field=t}},this.Program.Precedence={"^":21,"/":20,"*":19,"%":18,"+":17,"-":17,"<":16,"<=":15,">":14,">=":13,"==":12,"!=":11,"<<":10,">>":9,"&":8,"|":7,and:6,or:5},this.Routine=class Nt{constructor(e){this.num_args=e,this.ops=[],this.opcodes=[],this.arg1=[],this.ref=[],this.table={},this.label_count=0,this.labels={},this.transpile=!1,this.import_refs=[],this.import_values=[],this.import_self=-1}clone(){var e;return e=new Nt(this.num_args),e.opcodes=this.opcodes,e.arg1=this.arg1,e.ref=this.ref,e.locals_size=this.locals_size,e.uses_arguments=this.uses_arguments,e}createLabel(e="label"){var t;return t=":"+e+"_"+this.label_count++}setLabel(e){return this.labels[e]=this.opcodes.length}optimize(){this.transpile&&new Transpiler().transpile(this)}removeable(e){var t,n,o;n=this.labels;for(t in n)if(o=n[t],o===e)return!1;return!0}remove(e){var t,n,o;n=this.labels;for(t in n){if(o=n[t],o===e)return!1;o>e&&(this.labels[t]-=1)}return this.opcodes.splice(e,1),this.arg1.splice(e,1),this.ref.splice(e,1),!0}resolveLabels(){var e,t,n,o,a,h;for(h=[],e=t=0,n=this.opcodes.length-1;0<=n?t<=n:t>=n;e=0<=n?++t:--t)(o=this.opcodes[e])===OPCODES.JUMP||o===OPCODES.JUMPY||o===OPCODES.JUMPN||o===OPCODES.JUMPY_NOPOP||o===OPCODES.JUMPN_NOPOP?this.labels[this.arg1[e]]?h.push(this.arg1[e]=this.labels[this.arg1[e]]):h.push(void 0):((a=this.opcodes[e])===OPCODES.FORLOOP_CONTROL||a===OPCODES.FORLOOP_INIT||a===OPCODES.FORIN_CONTROL||a===OPCODES.FORIN_INIT)&&this.labels[this.arg1[e][1]]?h.push(this.arg1[e][1]=this.labels[this.arg1[e][1]]):h.push(void 0);return h}OP(e,t,n=0){return this.opcodes.push(e),this.arg1.push(n),this.ref.push(t)}OP_INSERT(e,t,n=0,o){var a,h,u;this.opcodes.splice(o,0,e),this.arg1.splice(o,0,n),this.ref.splice(o,0,t),h=this.labels;for(a in h)u=h[a],u>=o&&(this.labels[a]+=1)}TYPE(e){return this.OP(OPCODES.TYPE,e)}VARIABLE_TYPE(e,t){return this.OP(OPCODES.VARIABLE_TYPE,t,e)}PROPERTY_TYPE(e){return this.OP(OPCODES.PROPERTY_TYPE,e)}LOAD_THIS(e){return this.OP(OPCODES.LOAD_THIS,e)}LOAD_GLOBAL(e){return this.OP(OPCODES.LOAD_GLOBAL,e)}LOAD_VALUE(e,t){return this.OP(OPCODES.LOAD_VALUE,t,e)}LOAD_LOCAL(e,t){return this.OP(OPCODES.LOAD_LOCAL,t,e)}LOAD_VARIABLE(e,t){return this.OP(OPCODES.LOAD_VARIABLE,t,e)}LOAD_LOCAL_OBJECT(e,t){return this.OP(OPCODES.LOAD_LOCAL_OBJECT,t,e)}LOAD_VARIABLE_OBJECT(e,t){return this.OP(OPCODES.LOAD_VARIABLE_OBJECT,t,e)}POP(e){return this.OP(OPCODES.POP,e)}LOAD_PROPERTY(e){return this.OP(OPCODES.LOAD_PROPERTY,e)}LOAD_PROPERTY_OBJECT(e){return this.OP(OPCODES.LOAD_PROPERTY_OBJECT,e)}CREATE_OBJECT(e){return this.OP(OPCODES.CREATE_OBJECT,e)}MAKE_OBJECT(e){return this.OP(OPCODES.MAKE_OBJECT,e)}CREATE_ARRAY(e){return this.OP(OPCODES.CREATE_ARRAY,e)}CREATE_CLASS(e,t){return this.OP(OPCODES.CREATE_CLASS,t,e)}UPDATE_CLASS(e,t){return this.OP(OPCODES.UPDATE_CLASS,t,e)}NEW_CALL(e,t){return this.OP(OPCODES.NEW_CALL,t,e)}ADD(e,t=0){return this.OP(OPCODES.ADD,e,t)}SUB(e,t=0){return this.OP(OPCODES.SUB,e,t)}MUL(e){return this.OP(OPCODES.MUL,e)}DIV(e){return this.OP(OPCODES.DIV,e)}MODULO(e){return this.OP(OPCODES.MODULO,e)}BINARY_AND(e){return this.OP(OPCODES.BINARY_AND,e)}BINARY_OR(e){return this.OP(OPCODES.BINARY_OR,e)}SHIFT_LEFT(e){return this.OP(OPCODES.SHIFT_LEFT,e)}SHIFT_RIGHT(e){return this.OP(OPCODES.SHIFT_RIGHT,e)}NEGATE(e){return this.OP(OPCODES.NEGATE,e)}LOAD_PROPERTY_ATOP(e){return this.OP(OPCODES.LOAD_PROPERTY_ATOP,e)}EQ(e){return this.OP(OPCODES.EQ,e)}NEQ(e){return this.OP(OPCODES.NEQ,e)}LT(e){return this.OP(OPCODES.LT,e)}GT(e){return this.OP(OPCODES.GT,e)}LTE(e){return this.OP(OPCODES.LTE,e)}GTE(e){return this.OP(OPCODES.GTE,e)}NOT(e){return this.OP(OPCODES.NOT,e)}FORLOOP_INIT(e,t){return this.OP(OPCODES.FORLOOP_INIT,t,e)}FORLOOP_CONTROL(e,t){return this.OP(OPCODES.FORLOOP_CONTROL,t,e)}FORIN_INIT(e,t){return this.OP(OPCODES.FORIN_INIT,t,e)}FORIN_CONTROL(e,t){return this.OP(OPCODES.FORIN_CONTROL,t,e)}JUMP(e,t){return this.OP(OPCODES.JUMP,t,e)}JUMPY(e,t){return this.OP(OPCODES.JUMPY,t,e)}JUMPN(e,t){return this.OP(OPCODES.JUMPN,t,e)}JUMPY_NOPOP(e,t){return this.OP(OPCODES.JUMPY_NOPOP,t,e)}JUMPN_NOPOP(e,t){return this.OP(OPCODES.JUMPN_NOPOP,t,e)}STORE_LOCAL(e,t){return this.OP(OPCODES.STORE_LOCAL,t,e)}STORE_VARIABLE(e,t){return this.OP(OPCODES.STORE_VARIABLE,t,e)}CREATE_PROPERTY(e){return this.OP(OPCODES.CREATE_PROPERTY,e)}STORE_PROPERTY(e){return this.OP(OPCODES.STORE_PROPERTY,e)}LOAD_ROUTINE(e,t){return this.OP(OPCODES.LOAD_ROUTINE,t,e)}FUNCTION_CALL(e,t){return this.OP(OPCODES.FUNCTION_CALL,t,e)}FUNCTION_APPLY_VARIABLE(e,t){return this.OP(OPCODES.FUNCTION_APPLY_VARIABLE,t,e)}FUNCTION_APPLY_PROPERTY(e,t){return this.OP(OPCODES.FUNCTION_APPLY_PROPERTY,t,e)}SUPER_CALL(e,t){return this.OP(OPCODES.SUPER_CALL,t,e)}RETURN(e){return this.OP(OPCODES.RETURN,e)}AFTER(e){return this.OP(OPCODES.AFTER,e)}EVERY(e){return this.OP(OPCODES.EVERY,e)}DO(e){return this.OP(OPCODES.DO,e)}SLEEP(e){return this.OP(OPCODES.SLEEP,e)}DELETE(e){return this.OP(OPCODES.DELETE,e)}UNARY_OP(e,t){return this.OP(OPCODES.UNARY_OP,t,e)}BINARY_OP(e,t){return this.OP(OPCODES.BINARY_OP,t,e)}toString(){var e,t,n,o,a,h;for(h="",a=this.opcodes,e=t=0,n=a.length;t<n;e=++t)o=a[e],h+=OPCODES[o],this.arg1[e]!=null&&(h+=` ${this.arg1[e]}`),h+=`
`;return h}},this.OPCODES_CLASS=class{constructor(){this.table={},this.set("TYPE",1),this.set("VARIABLE_TYPE",2),this.set("PROPERTY_TYPE",3),this.set("LOAD_IMPORT",4),this.set("LOAD_THIS",5),this.set("LOAD_GLOBAL",6),this.set("LOAD_VALUE",10),this.set("LOAD_LOCAL",11),this.set("LOAD_VARIABLE",12),this.set("LOAD_LOCAL_OBJECT",13),this.set("LOAD_VARIABLE_OBJECT",14),this.set("POP",15),this.set("LOAD_PROPERTY",16),this.set("LOAD_PROPERTY_OBJECT",17),this.set("CREATE_OBJECT",18),this.set("MAKE_OBJECT",19),this.set("CREATE_ARRAY",20),this.set("STORE_LOCAL",21),this.set("STORE_VARIABLE",23),this.set("CREATE_PROPERTY",24),this.set("STORE_PROPERTY",25),this.set("DELETE",26),this.set("UPDATE_CLASS",27),this.set("CREATE_CLASS",28),this.set("NEW_CALL",29),this.set("ADD",30),this.set("SUB",31),this.set("MUL",32),this.set("DIV",33),this.set("MODULO",34),this.set("BINARY_AND",35),this.set("BINARY_OR",36),this.set("SHIFT_LEFT",37),this.set("SHIFT_RIGHT",38),this.set("NEGATE",39),this.set("EQ",40),this.set("NEQ",41),this.set("LT",42),this.set("GT",43),this.set("LTE",44),this.set("GTE",45),this.set("NOT",50),this.set("LOAD_PROPERTY_ATOP",68),this.set("JUMP",80),this.set("JUMPY",81),this.set("JUMPN",82),this.set("JUMPY_NOPOP",83),this.set("JUMPN_NOPOP",84),this.set("LOAD_ROUTINE",89),this.set("FUNCTION_CALL",90),this.set("FUNCTION_APPLY_VARIABLE",91),this.set("FUNCTION_APPLY_PROPERTY",92),this.set("SUPER_CALL",93),this.set("RETURN",94),this.set("FORLOOP_INIT",95),this.set("FORLOOP_CONTROL",96),this.set("FORIN_INIT",97),this.set("FORIN_CONTROL",98),this.set("UNARY_OP",100),this.set("BINARY_OP",101),this.set("COMPILED",200),this.set("AFTER",110),this.set("EVERY",111),this.set("DO",112),this.set("SLEEP",113)}set(e,t){return this[e]=t,this[t]=e}},this.OPCODES=new this.OPCODES_CLASS,this.Runner=class{constructor(e){this.microvm=e}init(){return this.initialized=!0,this.system=this.microvm.context.global.system,this.system.preemptive=1,this.system.threads=[],this.main_thread=new Thread(this),this.threads=[this.main_thread],this.current_thread=this.main_thread,this.thread_index=0,this.microvm.context.global.print=this.microvm.context.meta.print,this.microvm.context.global.random=new Random(0),this.microvm.context.global.Function={bind:function(e){var t;return this instanceof Routine?(t=this.clone(),t.object=e,t):this}},this.microvm.context.global.List={sortList:e=>{var t;return e!=null&&e instanceof Program.Function?t=function(n,o){return e.call(this.microvm.context.global,[n,o],!0)}:e!=null&&typeof e=="function"&&(t=e),this.sort(t)},"+":function(e,t,n){return n||(e=[...e]),Array.isArray(t)?e.concat(t):(e.push(t),e)},"-":function(e,t,n){var o;return n||(e=[...e]),o=e.indexOf(t),o>=0&&e.splice(o,1),e}},this.microvm.context.global.Object={},this.microvm.context.global.String={fromCharCode:function(...e){return String.fromCharCode(...e)},"+":function(e,t){return e+t}},this.microvm.context.global.Number={parse:function(e){var t;return t=Number.parseFloat(e),isFinite(t)?t:0},toString:function(){return this.toString()}},this.fps=60,this.fps_max=60,this.cpu_load=0,this.microvm.context.meta.print("microScript 2.0"),this.triggers_controls_update=!0}run(e,t,n){var o,a,h,u,p,d,g,P,v,O;if(this.initialized||this.init(),d=new Parser(e,t),d.parse(),d.error_info!=null)throw a=d.error_info,a.type="compile",a;if(d.warnings.length>0)for(P=d.warnings,u=0,p=P.length;u<p;u++)switch(O=P[u],h=t+"-"+O.line+"-"+O.column,O.type){case"assigning_api_variable":this.microvm.context.warnings.assigning_api_variable[h]==null&&(this.microvm.context.warnings.assigning_api_variable[h]={file:t,line:O.line,column:O.column,expression:O.identifier});break;case"assignment_as_condition":this.microvm.context.warnings.assignment_as_condition[h]==null&&(this.microvm.context.warnings.assignment_as_condition[h]={file:t,line:O.line,column:O.column})}return g=d.program,o=new Compiler(g),v=null,o.routine.callback=function(y){return n!=null?n(Program.toString(y)):v=y},this.main_thread.addCall(o.routine),this.tick(),v}call(e,t){var n,o;if(e==="draw"||e==="update"||e==="serverUpdate"){this.microvm.context.global[e]!=null&&this.main_thread.addCall(`${e}()`);return}if(this.microvm.context.global[e]!=null){if(t==null||!t.length)return this.main_thread.addCall(`${e}()`);if(o=this.microvm.context.global[e],o instanceof Routine)return n=this.main_thread.processor.routineAsFunction(o,this.microvm.context),n(...t);if(typeof o=="function")return o(...t)}else return 0}toString(e){return Program.toString(e)}process(e,t){var n;return n=e.processor,n.time_limit=t,this.current_thread=e,n.run(this.microvm.context)}tick(){var e,t,n,o,a,h,u,p,d,g,P,v,O,y,x,A,I;for(this.system.fps!=null&&(this.fps=this.fps*.9+this.system.fps*.1),this.fps_max=Math.max(this.fps,this.fps_max),t=Math.min(16,Math.floor(1e3/this.fps_max)),this.fps<59?d=10:d=Math.floor(1e3/this.fps*.8),x=Date.now(),A=x+100,I=this.system.preemptive?A:1/0,P=this.main_thread.processor,P.done||(this.main_thread.sleep_until!=null?Date.now()>=this.main_thread.sleep_until&&(delete this.main_thread.sleep_until,this.process(this.main_thread,I)):this.process(this.main_thread,I));P.done&&Date.now()<I&&this.main_thread.loadNext();)this.process(this.main_thread,I);for(A=x+d,I=this.system.preemptive?A:1/0,g=!0;g;){for(g=!1,v=this.threads,a=0,u=v.length;a<u;a++)if(y=v[a],y!==this.main_thread){if(y.paused||y.terminated)continue;if(P=y.processor,!P.done)y.sleep_until!=null?Date.now()>=y.sleep_until&&(delete y.sleep_until,this.process(y,I),g=!0):(this.process(y,I),g=!0);else if(y.start_time!=null)if(y.repeat)for(;x>=y.start_time&&!(y.paused||y.terminated);)x>=y.start_time+150?y.start_time=x+y.delay:y.start_time+=y.delay,P.load(y.routine),this.process(y,I),g=!0;else x>=y.start_time&&(delete y.start_time,P.load(y.routine),this.process(y,I),g=!0);else y.terminated=!0}if(Date.now()>A)break}for(n=h=O=this.threads.length-1;h>=1;n=h+=-1)y=this.threads[n],y.terminated&&(this.threads.splice(n,1),o=this.system.threads.indexOf(y.interface),o>=0&&this.system.threads.splice(o,1));y=Date.now()-x,e=A-x,p=y/e*100,this.cpu_load=this.cpu_load*.9+p*.1,this.system.cpu_load=Math.min(100,Math.round(this.cpu_load))}createThread(e,t,n){var o,a,h,u;for(u=new Thread(this),u.routine=e,this.threads.push(u),u.start_time=Date.now()+t-1e3/this.fps,n&&(u.repeat=n,u.delay=t),this.system.threads.push(u.interface),o=a=0,h=e.import_values.length-1;a<=h;o=a+=1)e.import_values[o]===e&&(e.import_values[o]=u.interface);return u.interface}sleep(e){if(this.current_thread!=null)return this.current_thread.sleep_until=Date.now()+Math.max(0,e)}},this.Thread=class{constructor(e){this.runner=e,this.loop=!1,this.processor=new Processor(this.runner),this.paused=!1,this.terminated=!1,this.next_calls=[],this.interface={pause:()=>this.pause(),resume:()=>this.resume(),stop:()=>this.stop(),status:"running"}}addCall(e){if(this.next_calls.indexOf(e)<0)return this.next_calls.push(e)}loadNext(){var e,t,n,o;return this.next_calls.length>0?(t=this.next_calls.splice(0,1)[0],t instanceof Routine?this.processor.load(t):(n=new Parser(t,""),n.parse(),o=n.program,e=new Compiler(o),this.processor.load(e.routine),(t==="update()"||t==="serverUpdate()")&&this.runner.updateControls!=null&&this.runner.updateControls()),!0):!1}pause(){return this.interface.status==="running"?(this.interface.status="paused",this.paused=!0,1):0}resume(){return this.interface.status==="paused"?(this.interface.status="running",this.paused=!1,1):0}stop(){return this.interface.status="stopped",this.terminated=!0,1}},this.Token=class ft{constructor(e,t,n,o){this.tokenizer=e,this.type=t,this.value=n,this.string_value=o,this.line=this.tokenizer.line,this.column=this.tokenizer.column,this.start=this.tokenizer.token_start,this.length=this.tokenizer.index-this.start,this.index=this.tokenizer.index,this.type===ft.TYPE_IDENTIFIER&&ft.predefined.hasOwnProperty(this.value)&&(this.type=ft.predefined[this.value],this.reserved_keyword=!0),this.is_binary_operator=this.type>=30&&this.type<=39||this.type>=200&&this.type<=201||this.type>=2&&this.type<=7}toString(){return this.value+" : "+this.type}},this.Token.TYPE_EQUALS=1,this.Token.TYPE_DOUBLE_EQUALS=2,this.Token.TYPE_GREATER=3,this.Token.TYPE_GREATER_OR_EQUALS=4,this.Token.TYPE_LOWER=5,this.Token.TYPE_LOWER_OR_EQUALS=6,this.Token.TYPE_UNEQUALS=7,this.Token.TYPE_IDENTIFIER=10,this.Token.TYPE_NUMBER=11,this.Token.TYPE_STRING=12,this.Token.TYPE_OPEN_BRACE=20,this.Token.TYPE_CLOSED_BRACE=21,this.Token.TYPE_OPEN_BRACKET=24,this.Token.TYPE_CLOSED_BRACKET=25,this.Token.TYPE_COMMA=26,this.Token.TYPE_DOT=27,this.Token.TYPE_PLUS=30,this.Token.TYPE_MINUS=31,this.Token.TYPE_MULTIPLY=32,this.Token.TYPE_DIVIDE=33,this.Token.TYPE_POWER=34,this.Token.TYPE_MODULO=35,this.Token.TYPE_BINARY_AND=36,this.Token.TYPE_BINARY_OR=37,this.Token.TYPE_SHIFT_LEFT=38,this.Token.TYPE_SHIFT_RIGHT=39,this.Token.TYPE_PLUS_EQUALS=40,this.Token.TYPE_MINUS_EQUALS=41,this.Token.TYPE_MULTIPLY_EQUALS=42,this.Token.TYPE_DIVIDE_EQUALS=43,this.Token.TYPE_MODULO_EQUALS=44,this.Token.TYPE_AND_EQUALS=45,this.Token.TYPE_OR_EQUALS=46,this.Token.TYPE_RETURN=50,this.Token.TYPE_BREAK=51,this.Token.TYPE_CONTINUE=52,this.Token.TYPE_FUNCTION=60,this.Token.TYPE_AFTER=61,this.Token.TYPE_EVERY=62,this.Token.TYPE_DO=63,this.Token.TYPE_SLEEP=64,this.Token.TYPE_LOCAL=70,this.Token.TYPE_OBJECT=80,this.Token.TYPE_CLASS=90,this.Token.TYPE_EXTENDS=91,this.Token.TYPE_NEW=92,this.Token.TYPE_FOR=100,this.Token.TYPE_TO=101,this.Token.TYPE_BY=102,this.Token.TYPE_IN=103,this.Token.TYPE_WHILE=104,this.Token.TYPE_IF=105,this.Token.TYPE_THEN=106,this.Token.TYPE_ELSE=107,this.Token.TYPE_ELSIF=108,this.Token.TYPE_END=120,this.Token.TYPE_AND=200,this.Token.TYPE_OR=201,this.Token.TYPE_NOT=202,this.Token.TYPE_ERROR=404,this.Token.predefined={},this.Token.predefined.return=this.Token.TYPE_RETURN,this.Token.predefined.break=this.Token.TYPE_BREAK,this.Token.predefined.continue=this.Token.TYPE_CONTINUE,this.Token.predefined.function=this.Token.TYPE_FUNCTION,this.Token.predefined.for=this.Token.TYPE_FOR,this.Token.predefined.to=this.Token.TYPE_TO,this.Token.predefined.by=this.Token.TYPE_BY,this.Token.predefined.in=this.Token.TYPE_IN,this.Token.predefined.while=this.Token.TYPE_WHILE,this.Token.predefined.if=this.Token.TYPE_IF,this.Token.predefined.then=this.Token.TYPE_THEN,this.Token.predefined.else=this.Token.TYPE_ELSE,this.Token.predefined.elsif=this.Token.TYPE_ELSIF,this.Token.predefined.end=this.Token.TYPE_END,this.Token.predefined.object=this.Token.TYPE_OBJECT,this.Token.predefined.class=this.Token.TYPE_CLASS,this.Token.predefined.extends=this.Token.TYPE_EXTENDS,this.Token.predefined.new=this.Token.TYPE_NEW,this.Token.predefined.and=this.Token.TYPE_AND,this.Token.predefined.or=this.Token.TYPE_OR,this.Token.predefined.not=this.Token.TYPE_NOT,this.Token.predefined.after=this.Token.TYPE_AFTER,this.Token.predefined.every=this.Token.TYPE_EVERY,this.Token.predefined.do=this.Token.TYPE_DO,this.Token.predefined.sleep=this.Token.TYPE_SLEEP,this.Token.predefined.delete=this.Token.TYPE_DELETE,this.Token.predefined.local=this.Token.TYPE_LOCAL,this.Tokenizer=function(){function c(e,t){this.input=e,this.filename=t,this.index=0,this.line=1,this.column=0,this.last_column=0,this.buffer=[],this.chars={},this.chars["("]=Token.TYPE_OPEN_BRACE,this.chars[")"]=Token.TYPE_CLOSED_BRACE,this.chars["["]=Token.TYPE_OPEN_BRACKET,this.chars["]"]=Token.TYPE_CLOSED_BRACKET,this.chars["{"]=Token.TYPE_OPEN_CURLY_BRACE,this.chars["}"]=Token.TYPE_CLOSED_CURLY_BRACE,this.chars["^"]=Token.TYPE_POWER,this.chars[","]=Token.TYPE_COMMA,this.chars["."]=Token.TYPE_DOT,this.doubles={},this.doubles[">"]=[Token.TYPE_GREATER,Token.TYPE_GREATER_OR_EQUALS],this.doubles["<"]=[Token.TYPE_LOWER,Token.TYPE_LOWER_OR_EQUALS],this.doubles["="]=[Token.TYPE_EQUALS,Token.TYPE_DOUBLE_EQUALS],this.doubles["+"]=[Token.TYPE_PLUS,Token.TYPE_PLUS_EQUALS],this.doubles["-"]=[Token.TYPE_MINUS,Token.TYPE_MINUS_EQUALS],this.doubles["*"]=[Token.TYPE_MULTIPLY,Token.TYPE_MULTIPLY_EQUALS],this.doubles["/"]=[Token.TYPE_DIVIDE,Token.TYPE_DIVIDE_EQUALS],this.doubles["%"]=[Token.TYPE_MODULO,Token.TYPE_MODULO_EQUALS],this.doubles["&"]=[Token.TYPE_BINARY_AND,Token.TYPE_AND_EQUALS],this.doubles["|"]=[Token.TYPE_BINARY_OR,Token.TYPE_OR_EQUALS],this.shifts={"<":Token.TYPE_SHIFT_LEFT,">":Token.TYPE_SHIFT_RIGHT},this.letter_regex=RegExp(/^\p{L}/,"u")}return c.prototype.pushBack=function(e){return this.buffer.splice(0,0,e)},c.prototype.finished=function(){return this.index>=this.input.length&&this.buffer.length===0},c.prototype.nextChar=function(e){var t,n;if(e==null&&(e=!1),t=this.input.charAt(this.index++),t===`
`)this.line+=1,this.last_column=this.column,this.column=0;else if(t==="/"&&!e){if(this.input.charAt(this.index)==="/"){for(;t=this.input.charAt(this.index++),!(t===`
`||this.index>=this.input.length););return this.line+=1,this.last_column=this.column,this.column=0,this.nextChar()}else if(this.input.charAt(this.index)==="*"){for(n=0;;){if(t=this.input.charAt(this.index++),t===`
`)this.line+=1,this.last_column=this.column,this.column=0,n=0;else if(t==="*")n=1;else{if(t==="/"&&n===1)break;n=0}if(this.index>=this.input.length)break}return this.nextChar()}}else this.column+=1;return t},c.prototype.rewind=function(){if(this.index-=1,this.column-=1,this.input.charAt(this.index)===`
`)return this.line-=1,this.column=this.last_column},c.prototype.next=function(){var e,t;if(this.buffer.length>0)return this.buffer.splice(0,1)[0];for(;;){if(this.index>=this.input.length)return null;if(e=this.nextChar(),t=e.charCodeAt(0),t>32&&t!==160)break}return this.token_start=this.index-1,this.doubles[e]!=null?this.parseDouble(e,this.doubles[e]):this.chars[e]!=null?new Token(this,this.chars[e],e):e==="!"?this.parseUnequals(e):t>=48&&t<=57?this.parseNumber(e):t>=65&&t<=90||t>=97&&t<=122||t===95||this.letter_regex.test(e)?this.parseIdentifier(e):e==='"'?this.parseString(e,'"'):e==="'"?this.parseString(e,"'"):this.error("Syntax Error")},c.prototype.changeNumberToIdentifier=function(){var e,t,n,o,a,h;if(a=this.next(),a!=null&&a.type===Token.TYPE_NUMBER){for(h=a.string_value.split("."),o=[],e=t=n=h.length-1;t>=0;e=t+=-1)h[e].length>0&&this.pushBack(new Token(this,Token.TYPE_IDENTIFIER,h[e])),e>0?o.push(this.pushBack(new Token(this,Token.TYPE_DOT,"."))):o.push(void 0);return o}else return a!=null&&a.type===Token.TYPE_STRING?this.pushBack(new Token(this,Token.TYPE_IDENTIFIER,a.value)):this.pushBack(a)},c.prototype.parseDouble=function(e,t){return this.shifts[e]!=null&&this.index<this.input.length&&this.input.charAt(this.index)===e?(this.nextChar(),new Token(this,this.shifts[e],e+e)):this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,t[1],e+"=")):new Token(this,t[0],e)},c.prototype.parseEquals=function(e){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_DOUBLE_EQUALS,"==")):new Token(this,Token.TYPE_EQUALS,"=")},c.prototype.parseGreater=function(e){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_GREATER_OR_EQUALS,">=")):new Token(this,Token.TYPE_GREATER_OR_EQUALS,">")},c.prototype.parseLower=function(e){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_LOWER_OR_EQUALS,"<=")):new Token(this,Token.TYPE_LOWER,"<")},c.prototype.parseUnequals=function(e){return this.index<this.input.length&&this.input.charAt(this.index)==="="?(this.nextChar(),new Token(this,Token.TYPE_UNEQUALS,"!=")):this.error("Expected inequality !=")},c.prototype.parseIdentifier=function(e){for(var t,n;;){if(this.index>=this.input.length)return new Token(this,Token.TYPE_IDENTIFIER,e);if(t=this.nextChar(),n=t.charCodeAt(0),n>=65&&n<=90||n>=97&&n<=122||n===95||n>=48&&n<=57||this.letter_regex.test(t))e+=t;else return this.rewind(),new Token(this,Token.TYPE_IDENTIFIER,e)}},c.prototype.parseNumber=function(e){var t,n,o,a;for(a=!1,o=!1;;){if(this.index>=this.input.length)return new Token(this,Token.TYPE_NUMBER,Number.parseFloat(e),e);if(t=this.nextChar(),n=t.charCodeAt(0),t==="."&&!a&&!o)a=!0,e+=t;else if(n>=48&&n<=57)e+=t;else if((t==="e"||t==="E")&&!o&&this.index<this.input.length)o=!0,e+=t,t=this.nextChar(),t==="+"||t==="-"?e+=t:this.rewind();else return(t==="x"||t==="X")&&e==="0"?this.parseHexNumber("0x"):(this.rewind(),new Token(this,Token.TYPE_NUMBER,Number.parseFloat(e),e))}},c.prototype.parseHexNumber=function(e){for(var t;;){if(this.index>=this.input.length)return new Token(this,Token.TYPE_NUMBER,Number.parseInt(e),e);if(t=this.nextChar(),/[a-fA-F0-9]/.test(t))e+=t;else return this.rewind(),new Token(this,Token.TYPE_NUMBER,Number.parseInt(e),e)}},c.prototype.parseString=function(e,t){var n,o,a,h;for(t==null&&(t='"'),t==='"'&&this.input.charAt(this.index)==='"'&&this.input.charAt(this.index+1)==='"'&&this.input.charAt(this.index+2)!=='"'&&(t='"""',this.nextChar(!0),this.nextChar(!0)),a=0;;){if(this.index>=this.input.length)return this.error("Unclosed string value");if(n=this.nextChar(!0),o=n.charCodeAt(0),n==="\\")switch(h=this.nextChar(!0),h){case"n":e+=`
`;break;case"\\":e+="\\";break;case t:e+=t;break;default:e+="\\"+h}else if(n===t)if(h=this.nextChar(!0),h===t)e+=n;else return this.rewind(),e+=n,new Token(this,Token.TYPE_STRING,e.substring(1,e.length-1));else{if(t==='"""'&&n==='"'){if(a+=1,a===3)return new Token(this,Token.TYPE_STRING,e.substring(1,e.length-2))}else a=0;e+=n}}},c.prototype.error=function(e){throw e},c}();var Transpiler;Transpiler=function(){function Transpiler(){}return Transpiler.prototype.transpile=function(c){var e,t,n,o,a,h;for(h=[],e=n=0,a=c.opcodes.length-1;n<=a;e=n+=1)if(o=OPCODES[c.opcodes[e]],this.transpilable(o,c.arg1[e])){for(t=e+1;t<c.opcodes.length&&c.removeable(t)&&this.transpilable(OPCODES[c.opcodes[t]],c.arg1[t]);)t+=1;t-=1,t-e>=2?h.push(this.transpileSegment(c,e,t)):h.push(void 0)}else h.push(void 0);return h},Transpiler.prototype.transpileSegment=function(r,i,j){var comp,err,index,k,l,m,ref,ref1,ref2,ref3,s;for(this.vcount=0,this.stack=new Stack,this.locals={},this.variables={},s=`f = function(stack,stack_index,locals,locals_offset,object,global) {
`,k=l=ref=i,ref1=j;l<=ref1;k=l+=1)console.info(OPCODES[r.opcodes[k]]+" "+r.arg1[k]),comp=this[OPCODES[r.opcodes[k]]](r.arg1[k]),comp&&(s+=comp+`
`);for(index in this.stack.touched)this.stack.touched[index]&&(index<0?s+="stack[stack_index-"+Math.abs(index)+"] = "+this.stack.stack[index]+` ;
`:index>0?s+="stack[stack_index+"+index+"] = "+this.stack.stack[index]+` ;
`:s+="stack[stack_index] = "+this.stack.stack[index]+` ;
`);this.stack.index<0?s+="stack_index -= "+Math.abs(this.stack.index)+` ;
`:this.stack.index>0&&(s+="stack_index += "+this.stack.index+` ;
`),s+=`return stack_index ;
}`,console.info(s);try{eval(s)}catch(c){err=c,console.error(s),console.error(err)}for(r.opcodes[i]=200,r.arg1[i]=f,k=m=ref2=i+1,ref3=j;m<=ref3;k=m+=1)r.remove(i+1)},Transpiler.prototype.createVariable=function(){return"v"+this.vcount++},Transpiler.prototype.transpilable=function(c,e){var t;return c==="LOAD_VALUE"?(t=typeof e)=="string"||t==="number":this[c]!=null},Transpiler.prototype.LOAD_VALUE=function(c){return typeof c=="string"?this.stack.push(' "'+c.replace(/"/g,'\\"')+'" '):typeof c=="number"&&this.stack.push(c+""),""},Transpiler.prototype.LOAD_LOCAL=function(c){var e;return e=this.createVariable(),this.stack.push(e),"let "+e+" = locals[locals_offset+"+c+"] ; // LOAD_LOCAL"},Transpiler.prototype.LOAD_LOCAL_OBJECT=function(c){var e,t;return this.locals[c]!=null?(t=this.locals[c],this.stack.push(t),"if (typeof "+t+' != "object") {\xA0'+t+" = locals[locals_offset+"+c+"] = {} } ;"):(t=this.createVariable(),e="let "+t+" = locals[locals_offset+"+c+`] ;
if (typeof `+t+' != "object") {\xA0'+t+" = locals[locals_offset+"+c+"] = {} } ;",this.stack.push(t),this.locals[c]=t,e)},Transpiler.prototype.STORE_LOCAL=function(c){var e;return e=this.stack.get(),"locals[locals_offset+"+c+"] = "+e+" ; // STORE_LOCAL"},Transpiler.prototype.POP=function(){return this.stack.pop(),""},Transpiler.prototype.CREATE_PROPERTY=function(c){var e;return e=this.stack.get(-2)+"["+this.stack.get(-1)+"] = "+this.stack.get()+" ;",this.stack.pop(),this.stack.pop(),e},Transpiler.prototype.LOAD_PROPERTY=function(c){var e,t;return t=this.createVariable(),e="let "+t+" = "+this.stack.get(-1)+"["+this.stack.get()+`] ; // LOAD_PROPERTY
if (`+t+" == null) { "+t+" = 0 ; }",this.stack.pop(),this.stack.pop(),this.stack.push(t),e},Transpiler.prototype.LOAD_PROPERTY_ATOP=function(c){var e,t;return t=this.createVariable(),e="let "+t+" = "+this.stack.get(-1)+"["+this.stack.get()+`] ; // LOAD_PROPERTY_ATOP
if (`+t+" == null) { "+t+" = 0 ; }",this.stack.push(t),e},Transpiler.prototype.NEW_OBJECT=function(){var c;return c=this.createVariable(),this.stack.push(c),"let "+c+" = {} ;"},Transpiler.prototype.NEW_ARRAY=function(){var c;return c=this.createVariable(),this.stack.push(c),"let "+c+" = [] ;"},Transpiler.prototype.MAKE_OBJECT=function(){var c,e;return e=this.createVariable(),c="let "+e+" = "+this.stack.get()+` ;
if (typeof `+e+' != "object") '+e+" = {} ; ",this.stack.pop(),this.stack.push(e),c},Transpiler.prototype.STORE_VARIABLE=function(c){return this.variables[c]!=null?this.variables[c]+' = object["'+c+'"] = '+this.stack.get()+" ; // STORE_VARIABLE":'object["'+c+'"] = '+this.stack.get()+" ; // STORE_VARIABLE"},Transpiler.prototype.STORE_PROPERTY=function(c){var e,t;return t=this.createVariable(),e="let "+t+" = "+this.stack.get(-2)+"["+this.stack.get(-1)+"] = "+this.stack.get(0)+" ; // STORE_PROPERTY",this.stack.pop(),this.stack.pop(),this.stack.pop(),this.stack.push(t),e},Transpiler}(),this.Stack=function(){function c(){this.stack=["stack[stack_index]"],this.index=0,this.touched={}}return c.prototype.push=function(e){return this.stack[++this.index]=e,this.touched[this.index]=!0},c.prototype.pop=function(){var e;return this.index>=0?e=this.stack.splice(this.index,1)[0]:this.stack[this.index]!=null?e=this.stack[this.index]:e="stack[stack_index-"+this.index+"]",this.index-=1,e},c.prototype.get=function(e){var t;return e==null&&(e=0),t=this.index+e,t>=0?this.stack[t]:this.stack[t]!=null?this.stack[t]:"stack[stack_index-"+-t+"]"},c}(),CanvasRenderingContext2D.prototype.roundRect=function(c,e,t,n,o){return t<2*o&&(o=t/2),n<2*o&&(o=n/2),this.beginPath(),this.moveTo(c+o,e),this.arcTo(c+t,e,c+t,e+n,o),this.arcTo(c+t,e+n,c,e+n,o),this.arcTo(c,e+n,c,e,o),this.arcTo(c,e,c+t,e,o),this.closePath()},CanvasRenderingContext2D.prototype.fillRoundRect=function(c,e,t,n,o){return this.roundRect(c,e,t,n,o),this.fill()},CanvasRenderingContext2D.prototype.strokeRoundRect=function(c,e,t,n,o){return this.roundRect(c,e,t,n,o),this.stroke()};var Random;Random=function(){function c(e,t){this._seed=e??Math.random(),t==null&&(t=!0),this._seed===0&&(this._seed=Math.random()),this._seed<1&&(this._seed*=1<<30),this.a=13971,this.b=12345,this.size=1<<30,this.mask=this.size-1,this.norm=1/this.size,t&&(this.nextSeed(),this.nextSeed(),this.nextSeed())}return c.prototype.next=function(){return this._seed=this._seed*this.a+this.b&this.mask,this._seed*this.norm},c.prototype.nextInt=function(e){return Math.floor(this.next()*e)},c.prototype.nextSeed=function(){return this._seed=this._seed*this.a+this.b&this.mask},c.prototype.seed=function(e){return this._seed=e??Math.random(),this._seed<1&&(this._seed*=1<<30),this.nextSeed(),this.nextSeed(),this.nextSeed()},c.prototype.clone=function(e){return e!=null?new c(e):(e=this._seed,new c(e,!1))},c}(),this.MPServerConnection=class{constructor(e){var t;this.status="connecting",t=new MPServerConnectionImpl(this,e),this.send=n=>{var o;try{return t.sendMessage(n),"sent"}catch(a){return o=a,console.error(o),o.toString()}},this.close=()=>{var n;try{return t.close()}catch(o){return n=o,console.error(n)}},this.messages=[]}},this.MPServerConnectionImpl=class{constructor(e,t){var n;if(this.interface=e,this.address=t,this.status="connecting",this.buffer=[],this.address)this.connect(this.address);else try{this.getRelay(o=>this.connect(o))}catch(o){n=o,console.error(n)}this.messages=[],player.runtime.addConnection(this)}getRelay(e){return player.client.sendRequest({name:"get_relay_server"},t=>{var n;return t.name==="error"?(this.interface.status="error",this.interface.error=t.error):(n=t.address,n==="self"&&(n=location.origin.replace("http","ws")),e(n))})}connect(e){return this.socket=new WebSocket(e),this.socket.onmessage=t=>{var n;try{switch(t=JSON.parse(t.data),t.name){case"mp_server_message":return this.messages.push(t.data)}}catch(o){return n=o,console.error(n)}},this.socket.onopen=()=>{var t,n,o,a;for(this.interface.status="connected",this.send({name:"mp_client_connection",server_id:ms_project_id}),a=this.buffer,t=0,n=a.length;t<n;t++)o=a[t],this.sendMessage(o);return this.buffer=[]},this.socket.onclose=()=>this.interface.status="disconnected"}update(){if(this.messages.length>0||this.interface.messages.length>0)return this.interface.messages=this.messages,this.messages=[]}sendMessage(e){return this.socket!=null&&this.socket.readyState===1?this.send({name:"mp_client_message",data:e}):this.buffer.push(e)}send(e){return this.socket.send(JSON.stringify(e))}close(){return this.socket.close()}},this.MicroVM=class{constructor(e={},t={},n="/microstudio",o=!1){var a,h;this.namespace=n,this.preserve_ls=o,e.print==null&&(e.print=u=>(typeof u=="object"&&this.runner!=null&&(u=this.runner.toString(u)),console.info(u))),Array.prototype.insert=function(u){return this.splice(0,0,u),u},Array.prototype.insertAt=function(u,p){return p>=0&&p<this.length?this.splice(p,0,u):this.push(u),u},Array.prototype.remove=function(u){return u>=0&&u<this.length?this.splice(u,1)[0]:0},Array.prototype.removeAt=function(u){return u>=0&&u<this.length?this.splice(u,1)[0]:0},Array.prototype.removeElement=function(u){var p;return p=this.indexOf(u),p>=0?this.splice(p,1)[0]:0},Array.prototype.contains=function(u){return this.indexOf(u)>=0?1:0},e.round=function(u){return Math.round(u)},e.floor=function(u){return Math.floor(u)},e.ceil=function(u){return Math.ceil(u)},e.abs=function(u){return Math.abs(u)},e.min=function(u,p){return Math.min(u,p)},e.max=function(u,p){return Math.max(u,p)},e.sqrt=function(u){return Math.sqrt(u)},e.pow=function(u,p){return Math.pow(u,p)},e.sin=function(u){return Math.sin(u)},e.cos=function(u){return Math.cos(u)},e.tan=function(u){return Math.tan(u)},e.acos=function(u){return Math.acos(u)},e.asin=function(u){return Math.asin(u)},e.atan=function(u){return Math.atan(u)},e.atan2=function(u,p){return Math.atan2(u,p)},e.sind=function(u){return Math.sin(u/180*Math.PI)},e.cosd=function(u){return Math.cos(u/180*Math.PI)},e.tand=function(u){return Math.tan(u/180*Math.PI)},e.acosd=function(u){return Math.acos(u)*180/Math.PI},e.asind=function(u){return Math.asin(u)*180/Math.PI},e.atand=function(u){return Math.atan(u)*180/Math.PI},e.atan2d=function(u,p){return Math.atan2(u,p)*180/Math.PI},e.log=function(u){return Math.log(u)},e.exp=function(u){return Math.exp(u)},e.random=new Random(0),e.PI=Math.PI,e.true=1,e.false=0,t.system={time:Date.now,language:navigator.language,update_rate:60,inputs:{keyboard:1,mouse:1,touch:"ontouchstart"in window?1:0,gamepad:0},prompt:(u,p)=>setTimeout(()=>{var d,g;if(t.mouse.pressed=0,t.touch.touching=0,g=window.prompt(u),p!=null&&typeof p=="function")return d=[g!=null?1:0,g],this.context.timeout=Date.now()+1e3,p.apply(null,d)},0),say:u=>setTimeout(()=>window.alert(u),0)};try{t.system.inputs.keyboard=window.matchMedia("(pointer:fine)").matches?1:0,t.system.inputs.mouse=window.matchMedia("(any-hover:none)").matches?0:1}catch(u){h=u}this.storage_service=this.createStorageService(),t.storage=this.storage_service.api,e.global=t,this.context={meta:e,global:t,local:t,object:t,breakable:0,continuable:0,returnable:0,stack_size:0},a=this.context,Array.prototype.sortList=function(u){var p;return u!=null&&u instanceof Program.Function?p=function(d,g){return u.call(a,[d,g],!0)}:u!=null&&typeof u=="function"&&(p=u),this.sort(p)},this.clearWarnings(),this.runner=new Runner(this)}clearWarnings(){return this.context.warnings={using_undefined_variable:{},assigning_field_to_undefined:{},invoking_non_function:{},assigning_api_variable:{},assignment_as_condition:{}}}setMeta(e,t){return this.context.meta[e]=t}setGlobal(e,t){return this.context.global[e]=t}run(e,t=3e3,n="",o){var a,h;this.program=e,this.error_info=null,this.context.timeout=Date.now()+t,this.context.stack_size=0;try{return h=this.runner.run(this.program,n,o),this.storage_service.check(),h!=null?this.runner.toString(h):null}catch(u){return a=u,a.type!=null&&a.line!=null&&a.error!=null?this.error_info=a:this.context.location!=null&&this.context.location.token!=null?(this.error_info={error:this.context.location.token.error_text||a,file:n,line:this.context.location.token.line,column:this.context.location.token.column},console.info(`Error at line: ${this.context.location.token.line} column: ${this.context.location.token.column}`)):this.error_info={error:a,file:n},console.error(a),this.storage_service.check()}}call(e,t=[],n=3e3){var o,a;this.error_info=null,this.context.timeout=Date.now()+n,this.context.stack_size=0;try{return a=this.runner.call(e,t),this.storage_service.check(),a}catch(h){return o=h,console.error(o),this.context.location!=null&&this.context.location.token!=null?this.error_info={error:this.context.location.token.error_text||o,line:this.context.location.token.line,column:this.context.location.token.column,file:this.context.location.token.file}:this.error_info={error:o},this.context.location!=null&&this.context.location.token!=null&&console.info(`Error at line: ${this.context.location.token.line} column: ${this.context.location.token.column}`),this.storage_service.check()}}createStorageService(){var e,t,n,o,a,h,u,p;try{n=window.localStorage}catch(d){return t=d,console.info("localStorage not available"),h={api:{set:function(){},get:function(){return 0}},check:function(){}}}if(!this.preserve_ls)try{delete window.localStorage}catch(d){e=d}u={},p=!1,o=this.namespace;try{a=n.getItem(`ms${o}`),a&&(u=JSON.parse(a))}catch(d){e=d}return h={api:{set:(d,g)=>(g=this.storableObject(g),d!=null&&g!=null&&(u[d]=g,p=!0),g),get:d=>d!=null&&u[d]!=null?u[d]:0},check:()=>{if(p){p=!1;try{return n.setItem(`ms${o}`,JSON.stringify(u))}catch(d){e=d}}}}}storableObject(e){var t;return t=[this.context.global.screen,this.context.global.system,this.context.global.keyboard,this.context.global.audio,this.context.global.gamepad,this.context.global.touch,this.context.global.mouse,this.context.global.sprites,this.context.global.maps],this.makeStorableObject(e,t)}makeStorableObject(e,t){var n,o,a,h,u,p;if(e==null)return e;if(!(typeof e=="function"||typeof Program<"u"&&Program!==null&&e instanceof Program.Function||typeof Routine<"u"&&Routine!==null&&e instanceof Routine))if(typeof e=="object"){if(t.indexOf(e)>=0)return;if(t=t.slice(),t.push(e),Array.isArray(e)){for(u=[],n=o=0,h=e.length;o<h;n=++o)p=e[n],p=this.makeStorableObject(p,t),p!=null&&(u[n]=p);return u}else{u={};for(a in e)p=e[a],a!=="class"&&(p=this.makeStorableObject(p,t),p!=null&&(u[a]=p));return u}}else return e}};var arrayBufferToBase64,loadFile,loadLameJSLib,loadWaveFileLib,saveFile,writeProjectFile;this.Runtime=class{constructor(e,t,n,o){this.url=e,this.sources=t,this.resources=n,this.listener=o,this.screen=new Screen(this),this.audio=new AudioCore(this),this.keyboard=new Keyboard,this.gamepad=new Gamepad,this.asset_manager=new AssetManager(this),this.sprites={},this.maps={},this.sounds={},this.music={},this.assets={},this.touch={},this.mouse=this.screen.mouse,this.previous_init=null,this.random=new Random(0),this.orientation=window.orientation,this.aspect=window.aspect,this.report_errors=!0,this.log=a=>this.listener.log(a),this.update_memory={},this.time_machine=new TimeMachine(this),this.createDropFeature(),window.ms_async_load=!1,this.connections=[]}addConnection(e){return this.connections.push(e)}updateSource(e,t,n=!1){var o,a;if(this.vm==null||t===this.update_memory[e])return!1;this.update_memory[e]=t,this.audio.cancelBeeps(),this.screen.clear();try{return this.vm.run(t,3e3,e),this.listener.postMessage({name:"compile_success",file:e}),this.reportWarnings(),this.vm.error_info!=null?(o=this.vm.error_info,o.type="init",o.file=e,this.listener.reportError(o),!1):(this.vm.runner.getFunctionSource!=null&&(a=this.vm.runner.getFunctionSource("init"),a!=null&&a!==this.previous_init&&n&&(this.previous_init=a,this.vm.call("init"),this.vm.error_info!=null&&(o=this.vm.error_info,o.type="init",this.listener.reportError(o)))),!0)}catch(h){if(o=h,this.report_errors)return console.error(o),o.file=e,this.listener.reportError(o),!1}}start(){var e,t,n,o,a,h,u,p,d,g,P,v,O,y,x,A,I,S,C,G,Y,L,J;for(window.ms_async_load&&this.startReady(),A=this.resources.images,n=0,u=A.length;n<u;n++)t=A[n],L=LoadSprite(this.url+"sprites/"+t.file+"?v="+t.version,t.properties,()=>(this.updateMaps(),this.checkStartReady())),y=t.file.split(".")[0].replace(/-/g,"/"),L.name=y,this.sprites[y]=L;if(Array.isArray(this.resources.maps))for(I=this.resources.maps,o=0,p=I.length;o<p;o++)v=I[o],y=v.file.split(".")[0].replace(/-/g,"/"),this.maps[y]=LoadMap(this.url+`maps/${v.file}?v=${v.version}`,()=>this.checkStartReady()),this.maps[y].name=y;else if(this.resources.maps!=null){window.player==null&&(window.player=this.listener),S=this.resources.maps;for(a in S)J=S[a],this.updateMap(a,0,J)}for(C=this.resources.sounds,h=0,d=C.length;h<d;h++)L=C[h],y=L.file.split(".")[0],L=new Sound(this.audio,this.url+"sounds/"+L.file+"?v="+L.version),L.name=y,this.sounds[y]=L;for(G=this.resources.music,O=0,g=G.length;O<g;O++)v=G[O],y=v.file.split(".")[0],v=new Music(this.audio,this.url+"music/"+v.file+"?v="+v.version),v.name=y,this.music[y]=v;for(Y=this.resources.assets,x=0,P=Y.length;x<P;x++)e=Y[x],y=e.file.split(".")[0],y=y.replace(/-/g,"/"),e.name=y,this.assets[y]=e}checkStartReady(){var e,t,n,o,a,h,u;e=0,o=0,a=this.sprites;for(t in a)u=a[t],e+=1,u.ready&&(o+=1);h=this.maps;for(t in h)u=h[t],e+=1,u.ready&&(o+=1);if(o<e){if((this.loading_bar_time==null||Date.now()>this.loading_bar_time+16)&&(this.loading_bar_time=Date.now(),this.screen.fillRect!=null&&(this.screen.clear(),this.screen.drawRect(0,0,100,10,"#DDD"),n=o/e,this.screen.fillRect(-(1-n)*48,0,n*96,6,"#DDD")),window.ms_async_load&&this.vm!=null&&(this.vm.context.global.system.loading=Math.floor(o/e*100))),!window.ms_async_load)return}else window.ms_async_load&&this.vm!=null&&(this.vm.context.global.system.loading=100);if(!this.started)return this.startReady()}startReady(){var e,t,n,o,a,h,u,p,d,g,P,v;for(this.started=!0,p={print:O=>((typeof O=="object"||typeof O=="function")&&this.vm!=null&&(O=this.vm.runner.toString(O)),this.listener.log(O))},n={screen:this.screen.getInterface(),audio:this.audio.getInterface(),keyboard:this.keyboard.keyboard,gamepad:this.gamepad.status,sprites:this.sprites,sounds:this.sounds,music:this.music,assets:this.assets,asset_manager:this.asset_manager.getInterface(),maps:this.maps,touch:this.touch,mouse:this.mouse,fonts:window.fonts,Sound:Sound.createSoundClass(this.audio),Image:msImage,Sprite,Map:MicroMap},window.graphics==="M3D"?(n.M3D=M3D,M3D.runtime=this):window.graphics==="M2D"?(n.M2D=M2D,M2D.runtime=this):window.graphics.toLowerCase().startsWith("pixi")?(n.PIXI=PIXI,PIXI.runtime=this):window.graphics.toLowerCase().startsWith("babylon")&&(n.BABYLON=BABYLON,BABYLON.runtime=this),g=window.ms_libs,a=0,h=g.length;a<h;a++)switch(u=g[a],u=u.split("_")[0],u){case"matterjs":n.Matter=Matter;break;case"cannonjs":n.CANNON=CANNON}d=location.pathname,this.vm=new MicroVM(p,n,d,location.hash==="#transpiler"),window.ms_use_server&&(this.vm.context.global.ServerConnection=MPServerConnection),this.vm.context.global.system.pause=()=>this.listener.codePaused(),this.vm.context.global.system.exit=()=>this.exit(),window.ms_async_load||(this.vm.context.global.system.loading=100),this.vm.context.global.system.file=System.file,this.vm.context.global.system.javascript=System.javascript,window.ms_in_editor&&(this.vm.context.global.system.project=new ProjectInterface(this).interface),System.runtime=this,P=this.sources;for(t in P)v=P[t],this.updateSource(t,v,!1);return this.vm.runner.getFunctionSource!=null?(o=this.vm.runner.getFunctionSource("init"),o!=null&&(this.previous_init=o,this.vm.call("init"),this.vm.error_info!=null&&(e=this.vm.error_info,e.type="draw",this.listener.reportError(e)))):(this.vm.call("init"),this.vm.error_info!=null&&(e=this.vm.error_info,e.type="draw",this.listener.reportError(e))),this.dt=1e3/60,this.last_time=Date.now(),this.current_frame=0,this.floating_frame=0,requestAnimationFrame(()=>this.timer()),this.screen.startControl(),this.listener.postMessage({name:"started"})}updateMaps(){var e,t,n;n=this.maps;for(e in n)t=n[e],t.needs_update=!0}runCommand(e,t){var n,o,a;try{return a=this.vm.context.warnings,this.vm.clearWarnings(),o=this.vm.run(e,void 0,void 0,t),this.reportWarnings(),this.vm.context.warnings=a,this.vm.error_info!=null&&(n=this.vm.error_info,n.type="exec",this.listener.reportError(n)),this.watchStep(),t==null?o:(o!=null&&t(o),null)}catch(h){return n=h,this.listener.reportError(n)}}projectFileUpdated(e,t,n,o,a){switch(e){case"sprites":return this.updateSprite(t,n,o,a);case"maps":return this.updateMap(t,n,o);case"ms":return this.updateCode(t,n,o)}}projectFileDeleted(e,t){switch(e){case"sprites":return delete this.sprites[t.substring(0,t.length-4).replace(/-/g,"/")];case"maps":return delete this.maps[t.substring(0,t.length-5).replace(/-/g,"/")]}}projectOptionsUpdated(e){return this.orientation=e.orientation,this.aspect=e.aspect,this.screen.resize()}updateSprite(e,t,n,o){var a,h;return h=e,e=e.replace(/-/g,"/"),n!=null?(n="data:image/png;base64,"+n,this.sprites[e]!=null?(a=new Image,a.crossOrigin="Anonymous",a.src=n,a.onload=()=>(UpdateSprite(this.sprites[e],a,o),this.updateMaps())):(this.sprites[e]=LoadSprite(n,o,()=>this.updateMaps()),this.sprites[e].name=e)):this.sprites[e]!=null?(a=new Image,a.crossOrigin="Anonymous",a.src=this.url+"sprites/"+h+`.png?v=${t}`,a.onload=()=>(UpdateSprite(this.sprites[e],a,o),this.updateMaps())):(this.sprites[e]=LoadSprite(this.url+"sprites/"+h+`.png?v=${t}`,o,()=>this.updateMaps()),this.sprites[e].name=e)}updateMap(e,t,n){var o,a;return e=e.replace(/-/g,"/"),n!=null?(o=this.maps[e],o!=null?(UpdateMap(o,n),o.needs_update=!0):(o=new MicroMap(1,1,1,1),UpdateMap(o,n),this.maps[e]=o,this.maps[e].name=e)):(a=this.url+`maps/${e}.json?v=${t}`,o=this.maps[e],o!=null?o.loadFile(a):(this.maps[e]=LoadMap(a),this.maps[e].name=e))}updateCode(e,t,n){var o,a;return n!=null?(this.sources[e]=n,this.vm!=null&&n!==this.update_memory[e]&&this.vm.clearWarnings(),this.updateSource(e,n,!0)):(a=this.url+`ms/${e}.ms?v=${t}`,o=new XMLHttpRequest,o.onreadystatechange=h=>{if(o.readyState===XMLHttpRequest.DONE&&o.status===200)return this.sources[e]=o.responseText,this.updateSource(e,this.sources[e],!0)},o.open("GET",a),o.send())}stop(){return this.stopped=!0,this.audio.cancelBeeps()}stepForward(){if(this.stopped)return this.updateCall(),this.drawCall(),this.vm.runner.tick!=null&&this.vm.runner.tick(),this.watchStep()}resume(){if(this.stopped)return this.stopped=!1,requestAnimationFrame(()=>this.timer())}timer(){var e,t,n,o,a,h,u,p;if(!this.stopped){for(requestAnimationFrame(()=>this.timer()),u=Date.now(),Math.abs(u-this.last_time)>160&&(this.last_time=u-16),t=u-this.last_time,this.dt=this.dt*.9+t*.1,this.last_time=u,this.vm.context.global.system.fps=Math.round(n=1e3/this.dt),p=this.vm.context.global.system.update_rate,(p==null||!(p>0)||!isFinite(p))&&(p=60),this.floating_frame+=this.dt*p/1e3,e=Math.min(10,Math.round(this.floating_frame-this.current_frame)),(e===0||e===2)&&p===60&&Math.abs(n-60)<2&&(e=1,this.floating_frame=this.current_frame+1),o=a=1,h=e;a<=h;o=a+=1)this.updateCall(),o<e&&this.vm.runner.tick!=null&&this.vm.runner.tick();if(this.current_frame+=e,this.drawCall(),this.vm.runner.tick!=null&&this.vm.runner.tick(),e>0)return this.watchStep()}}updateCall(){var e;this.vm.runner.triggers_controls_update?this.vm.runner.updateControls==null&&(this.vm.runner.updateControls=()=>this.updateControls()):this.updateControls();try{if(this.vm.call("update"),this.time_machine.step(),this.reportWarnings(),this.vm.error_info!=null)return e=this.vm.error_info,e.type="update",this.listener.reportError(e)}catch(t){if(e=t,this.report_errors)return this.listener.reportError(e)}}drawCall(){var e;try{if(this.screen.initDraw(),this.screen.updateInterface(),this.vm.call("draw"),this.reportWarnings(),this.vm.error_info!=null)return e=this.vm.error_info,e.type="draw",this.listener.reportError(e)}catch(t){if(e=t,this.report_errors)return this.listener.reportError(e)}}reportWarnings(){var e,t,n,o,a,h,u;if(this.vm!=null){t=this.vm.context.warnings.invoking_non_function;for(e in t)u=t[e],u.reported||(u.reported=!0,this.listener.reportError({error:"",type:"non_function",expression:u.expression,line:u.line,column:u.column,file:u.file}));n=this.vm.context.warnings.using_undefined_variable;for(e in n)u=n[e],u.reported||(u.reported=!0,this.listener.reportError({error:"",type:"undefined_variable",expression:u.expression,line:u.line,column:u.column,file:u.file}));o=this.vm.context.warnings.assigning_field_to_undefined;for(e in o)u=o[e],u.reported||(u.reported=!0,this.listener.reportError({error:"",type:"assigning_undefined",expression:u.expression,line:u.line,column:u.column,file:u.file}));a=this.vm.context.warnings.assigning_api_variable;for(e in a)u=a[e],u.reported||(u.reported=!0,this.listener.reportError({error:"",type:"assigning_api_variable",expression:u.expression,line:u.line,column:u.column,file:u.file}));h=this.vm.context.warnings.assignment_as_condition;for(e in h)u=h[e],u.reported||(u.reported=!0,this.listener.reportError({error:"",type:"assignment_as_condition",line:u.line,column:u.column,file:u.file}))}}updateControls(){var e,t,n,o,a,h,u,p,d,g;for(p=this.connections,n=0,h=p.length;n<h;n++)e=p[n],e.update();for(g=Object.keys(this.screen.touches),this.touch.touching=g.length>0?1:0,this.touch.touches=[],o=0,u=g.length;o<u;o++)a=g[o],d=this.screen.touches[a],this.touch.x=d.x,this.touch.y=d.y,this.touch.touches.push({x:d.x,y:d.y,id:a});this.mouse.pressed&&!this.previous_mouse_pressed?(this.previous_mouse_pressed=!0,this.mouse.press=1):this.mouse.press=0,!this.mouse.pressed&&this.previous_mouse_pressed?(this.previous_mouse_pressed=!1,this.mouse.release=1):this.mouse.release=0,this.mouse.wheel=this.screen.wheel||0,this.screen.wheel=0,this.touch.touching&&!this.previous_touch?(this.previous_touch=!0,this.touch.press=1):this.touch.press=0,!this.touch.touching&&this.previous_touch?(this.previous_touch=!1,this.touch.release=1):this.touch.release=0,this.vm.context.global.system.file.dropped=0,this.files_dropped!=null&&(this.vm.context.global.system.file.dropped=this.files_dropped,delete this.files_dropped),this.vm.context.global.system.file.loaded=0,this.files_loaded!=null&&(this.vm.context.global.system.file.loaded=this.files_loaded,delete this.files_loaded),this.gamepad.update(),this.keyboard.update();try{this.vm.context.global.system.inputs.gamepad=this.gamepad.count>0?1:0}catch(P){t=P}}getAssetURL(e){return this.url+"assets/"+e+".glb"}getWatcher(){return this.watcher||(this.watcher=new Watcher(this))}watch(e){return this.getWatcher().watch(e)}watchStep(){return this.getWatcher().step()}stopWatching(){return this.getWatcher().stop()}exit(){var e;this.stop(),this.screen.clear!=null&&setTimeout(()=>this.screen.clear(),1);try{this.listener.exit()}catch(t){e=t}try{navigator.app!=null&&navigator.app.exitApp!=null&&navigator.app.exitApp()}catch(t){e=t}try{return window.close()}catch(t){e=t}}createDropFeature(){return document.addEventListener("dragenter",e=>e.stopPropagation()),document.addEventListener("dragleave",e=>e.stopPropagation()),document.addEventListener("dragover",e=>{if(e.preventDefault(),player.runtime.screen.mouseMove!=null)return player.runtime.screen.mouseMove(e)}),document.addEventListener("drop",e=>{var t,n,o,a,h,u,p,d,g,P,v;e.preventDefault(),e.stopPropagation();try{for(d=[],o=[],P=e.dataTransfer.items,u=0,p=P.length;u<p;u++)a=P[u],a.kind==="file"&&(n=a.getAsFile(),o.push(n));return v=[],h=0,g=function(){var O;if(h<o.length)return O=o[h++],loadFile(O,function(y){return v.push({name:O.name,size:O.size,content:y,file_type:O.type}),g()});if(player.runtime.files_dropped=v,typeof window.dropHandler=="function")return window.dropHandler(v)},g()}catch(O){return t=O,console.error(t)}})}},saveFile=function(c,e,t){var n,o,a;return n=document.createElement("a"),document.body.appendChild(n),n.style="display: none",o=new Blob([c],{type:t}),a=window.URL.createObjectURL(o),n.href=a,n.download=e,n.click(),window.URL.revokeObjectURL(a)},loadWaveFileLib=function(c){var e;return typeof wavefile<"u"&&wavefile!==null?c():(e=document.createElement("script"),e.src=location.origin+"/lib/wavefile/wavefile.js",document.head.appendChild(e),e.onload=function(){return c()})},loadLameJSLib=function(c){var e;return typeof lamejs<"u"&&lamejs!==null?c():(e=document.createElement("script"),e.src=location.origin+"/lib/lamejs/lame.min.js",document.head.appendChild(e),e.onload=function(){return c()})},writeProjectFile=function(c,e,t){return window.player.postMessage({name:"write_project_file",filename:c,content:e,thumbnail:t})},arrayBufferToBase64=function(c){var e,t,n,o,a,h;for(e="",t=new Uint8Array(c),a=t.byteLength,n=o=0,h=a-1;o<=h;n=o+=1)e+=String.fromCharCode(t[n]);return window.btoa(e)},loadFile=function(c,e){var t;switch(c.type){case"image/png":case"image/jpeg":return t=new FileReader,t.onload=function(){var n;return n=new Image,n.onload=function(){var o;return o=new msImage(n),e(o)},n.src=t.result},t.readAsDataURL(c);case"audio/wav":case"audio/x-wav":case"audio/mp3":return t=new FileReader,t.onload=function(){return player.runtime.audio.getContext().decodeAudioData(t.result,function(n){return e(new Sound(player.runtime.audio,n))})},t.readAsArrayBuffer(c);case"application/json":return t=new FileReader,t.onload=function(){var n,o;o=t.result;try{o=JSON.parse(t.result)}catch(a){n=a}return e(o)},t.readAsText(c);default:return t=new FileReader,t.onload=function(){return e(t.result)},t.readAsText(c)}},this.System={javascript:function(s){var err,f,res;try{f=eval(`res = function(global) { ${s} }`),res=f.call(player.runtime.vm.context.global,player.runtime.vm.context.global)}catch(c){err=c,console.error(err)}return res??0},file:{save:function(c,e,t,n){var o,a;if(c instanceof MicroSound)return loadWaveFileLib(function(){var h,u,p,d,g,P,v,O,y,x;for(x=new wavefile.WaveFile,p=[],g=P=0,O=c.length-1;P<=O;g=P+=1)p[g]=Math.round(Math.min(1,Math.max(-1,c.read(0,g)))*32767);if(c.channels===2){for(d=[],g=v=0,y=c.length-1;v<=y;g=v+=1)d[g]=Math.round(Math.min(1,Math.max(-1,c.read(1,g)))*32767);u=[p,d]}else u=[p];return x.fromScratch(u.length,c.sampleRate,"16",u),h=x.toBuffer(),typeof e!="string"?e="sound.wav":e.endsWith(".wav")||(e+=".wav"),saveFile(h,e,"octet/stream")});if(c instanceof msImage)return a=c.canvas,typeof e!="string"&&(e="image"),t=typeof t=="string"&&t.toLowerCase()==="jpg"?"jpg":"png",e.endsWith(`.${t}`)||(e+=`.${t}`),o=document.createElement("a"),document.body.appendChild(o),o.style="display: none",a.toBlob(h=>{var u;return u=window.URL.createObjectURL(h),o.href=u,o.download=e,o.click(),window.URL.revokeObjectURL(u)},t==="png"?"image/png":"image/jpeg",n);if(typeof c=="object")return c=System.runtime.vm.storableObject(c),c=JSON.stringify(c,null,2),typeof e!="string"&&(e="data"),e.endsWith(".json")||(e+=".json"),saveFile(c,e,"text/json");if(typeof c=="string")return typeof e!="string"&&(e="text"),e.endsWith(".txt")||(e+=".txt"),saveFile(c,e,"text/plain")},load:function(c,e){var t,n,o,a,h;if(typeof c=="string"||Array.isArray(c)?t=c:t=c.extensions||null,o=document.createElement("input"),c.multiple&&(o.multiple=!0),o.type="file",typeof t=="string")o.accept=`.${t}`;else if(Array.isArray(t)){for(n=a=0,h=t.length-1;0<=h?a<=h:a>=h;n=0<=h?++a:--a)t[n]=`.${t[n]}`;o.accept=t.join(",")}return o.addEventListener("change",u=>{var p,d,g,P;return p=u.target.files,P=[],d=0,g=function(){var v;if(d<p.length)return v=p[d++],loadFile(v,function(O){return P.push({name:v.name,size:v.size,content:O,file_type:v.type}),g()});if(player.runtime.files_loaded=P,typeof e=="function")return e(P)},g()}),o.click()},setDropHandler:function(c){return window.dropHandler=c}}},this.Watcher=class{constructor(e){this.runtime=e,this.vm=this.runtime.vm}update(){if(this.watching_variables)return this.step()}watch(e){return this.watching=!0,this.watching_variables=e,this.exclusion_list=[this.vm.context.global.screen,this.vm.context.global.system,this.vm.context.global.keyboard,this.vm.context.global.audio,this.vm.context.global.gamepad,this.vm.context.global.touch,this.vm.context.global.mouse,this.vm.context.global.sprites,this.vm.context.global.maps,this.vm.context.global.sounds,this.vm.context.global.music,this.vm.context.global.assets,this.vm.context.global.asset_manager,this.vm.context.global.fonts,this.vm.context.global.storage],this.vm.context.global.Function!=null&&this.exclusion_list.push(this.vm.context.global.Function),this.vm.context.global.String!=null&&this.exclusion_list.push(this.vm.context.global.String),this.vm.context.global.List!=null&&this.exclusion_list.push(this.vm.context.global.List),this.vm.context.global.Number!=null&&this.exclusion_list.push(this.vm.context.global.Number),this.vm.context.global.Object!=null&&this.exclusion_list.push(this.vm.context.global.Object),this.vm.context.global.Image!=null&&this.exclusion_list.push(this.vm.context.global.Image),this.vm.context.global.Sound!=null&&this.exclusion_list.push(this.vm.context.global.Sound),this.vm.context.global.Sprite!=null&&this.exclusion_list.push(this.vm.context.global.Sprite),this.vm.context.global.Map!=null&&this.exclusion_list.push(this.vm.context.global.Map),this.vm.context.global.random!=null&&this.exclusion_list.push(this.vm.context.global.random),this.vm.context.global.print!=null&&this.exclusion_list.push(this.vm.context.global.print),this.step()}stop(){return this.watching=!1}step(e=this.watching_variables){var t,n,o,a,h,u,p;if(this.watching){for(a={},n=0,o=e.length;n<o;n++){if(h=e[n],h==="global")u=this.vm.context.global;else for(p=h.split("."),u=this.vm.context.global,t=0;t<p.length&&u!=null;)u=u[p[t++]];u!=null&&this.exclusion_list.indexOf(u)<0&&(a[h]=this.exploreValue(u,1,10))}return this.runtime.listener.postMessage({name:"watch_update",data:a})}}exploreValue(e,t=1,n=10){var o,a,h,u,p,d;if(e==null)return{type:"number",value:0};if(typeof e=="function"||e instanceof Program.Function||typeof Routine<"u"&&Routine!==null&&e instanceof Routine)return{type:"function",value:""};if(typeof e=="object")if(Array.isArray(e)){if(t===0)return{type:"list",value:"",length:e.length};for(p=[],o=a=0,u=e.length;a<u&&(d=e[o],!(o>=100));o=++a)this.exclusion_list.indexOf(d)<0&&(p[o]=this.exploreValue(d,t-1,n));return p}else{if(t===0)return d="",e.classname&&(d="class "+e.classname),e.class!=null&&e.class.classname!=null&&(d=e.class.classname),{type:"object",value:d};p={};for(h in e)d=e[h],this.exclusion_list.indexOf(d)<0&&(p[h]=this.exploreValue(d,t-1,n));return p}else return typeof e=="string"?{type:"string",value:e.length<43?e:e.substring(0,40)+"..."}:typeof e=="number"?{type:"number",value:isFinite(e)?e:0}:typeof e=="boolean"?{type:"number",value:e?1:0}:{type:"unknown",value:e}}},this.ProjectInterface=function(){function c(e){this.runtime=e,this.interface={listFiles:function(t){return function(n,o){return t.listFiles(n,o)}}(this),readFile:function(t){return function(n,o){return t.readFile(n,o)}}(this),writeFile:function(t){return function(n,o,a,h){return t.writeFile(n,o,a,h)}}(this),deleteFile:function(t){return function(n,o){return t.deleteFile(n,o)}}(this)}}return c.prototype.callback=function(e,t,n,o){if(o!=null){if(n.error=o,n.ready=1,typeof e=="function")return e(0,o)}else if(n.data=t,n.ready=1,typeof e=="function")return e(t)},c.prototype.writeFile=function(e,t,n,o){var a;switch(a=e.split("/")[0],a){case"source":return this.writeSourceFile(t,e,n,o);case"sprites":return this.writeSpriteFile(t,e,n,o);case"maps":return this.writeMapFile(t,e,n,o);case"sounds":return this.writeSoundFile(t,e,n,o);case"music":return this.writeMusicFile(t,e,n,o);case"assets":return this.writeAssetFile(t,e,n,o);default:return o(0,"Root folder "+a+" does not exist")}},c.prototype.writeSourceFile=function(e,t,n,o){var a,h;return h={ready:0},typeof e!="string"?this.callback(o,0,h,"Incorrect object type, expected string"):(a={name:"write_project_file",path:t,content:e,options:n},this.runtime.listener.postRequest(a,function(u){return function(p){return u.callback(o,p.content,h,p.error)}}(this))),h},c.prototype.writeSpriteFile=function(e,t,n,o){var a,h,u,p,d,g,P,v,O;if(O={ready:0},e instanceof msImage)P={name:"write_project_file",path:t,content:e.canvas.toDataURL().split(",")[1],options:n},this.runtime.listener.postRequest(P,function(y){return function(x){return y.callback(o,x.content,O,x.error)}}(this));else if(e instanceof Sprite){if(u=e.fps,e.frames.length===1)a=e.frames[0].canvas,p=1;else{for(a=document.createElement("canvas"),a.width=e.width,a.height=e.height*e.frames.length,h=a.getContext("2d"),d=g=0,v=e.frames.length-1;0<=v?g<=v:g>=v;d=0<=v?++g:--g)h.drawImage(e.frames[d].canvas,0,d*e.height);p=e.frames.length}P={name:"write_project_file",path:t,content:a.toDataURL().split(",")[1],fps:u,frames:p,options:n},this.runtime.listener.postRequest(P,function(y){return function(x){return y.callback(o,x.content,O,x.error)}}(this))}else this.callback(o,0,O,"Incorrect object type, expected Image or Sprite");return O},c.prototype.writeMapFile=function(e,t,n,o){var a,h;return h={ready:0},e instanceof MicroMap?(a={name:"write_project_file",path:t,content:SaveMap(e),options:n},this.runtime.listener.postRequest(a,function(u){return function(p){return u.callback(o,p.content,h,p.error)}}(this))):this.callback(o,0,h,"Incorrect object type, expected Map"),h},c.prototype.writeSoundFile=function(e,t,n,o){var a;return a={ready:0},e instanceof MicroSound?loadWaveFileLib(function(h){return function(){var u,p,d,g,P,v,O,y,x,A,I,S;for(S=new wavefile.WaveFile,d=[],v=O=0,A=e.length-1;O<=A;v=O+=1)d[v]=Math.round(Math.min(1,Math.max(-1,e.read(0,v)))*32767);if(e.channels===2){for(g=[],v=y=0,I=e.length-1;y<=I;v=y+=1)g[v]=Math.round(Math.min(1,Math.max(-1,e.read(1,v)))*32767);p=[d,g]}else p=[d];return S.fromScratch(p.length,e.sampleRate,"16",p),u=S.toBuffer(),P=arrayBufferToBase64(u),x={name:"write_project_file",path:t,content:P,options:n},h.runtime.listener.postRequest(x,function(C){return h.callback(o,C.content,a,C.error)})}}(this)):this.callback(o,0,a,"Incorrect object type, expected Sound"),a},c.prototype.writeMusicFile=function(e,t,n,o){var a;return a={ready:0},e instanceof MicroSound?loadLameJSLib(function(h){return function(){var u,p,d,g,P,v,O,y,x,A,I,S,C,G,Y,L,J,Q,U,N,V,X;for(O=128,S=new lamejs.Mp3Encoder(e.channels,e.sampleRate,O),g=0,U=1152,N=new Int16Array(U),V=new Int16Array(U),A=[];g<e.length;){for(X=Math.min(U-1,e.length-g-1),d=P=0,C=X;P<=C;d=P+=1)N[d]=Math.round(32767*Math.max(-1,Math.min(1,e.read(0,g+d))));if(e.channels===2)for(d=v=0,G=X;v<=G;d=v+=1)V[d]=Math.round(32767*Math.max(-1,Math.min(1,e.read(1,g+d))));for(d=y=Y=X+1,L=U-1;y<=L;d=y+=1)N[d]=0;if(e.channels===2)for(d=x=J=X+1,Q=U-1;x<=Q;d=x+=1)V[d]=0;g+=U,e.channels===2?I=S.encodeBuffer(N,V):I=S.encodeBuffer(N),I.length>0&&A.push(I)}return I=S.flush(),I.length>0&&A.push(I),u=new Blob(A,{type:"audio/mp3"}),p=new FileReader,p.onload=function(lt){var st;return st={name:"write_project_file",path:t,content:p.result.split(",")[1],options:n},h.runtime.listener.postRequest(st,function(ht){return h.callback(o,ht.content,a,ht.error)})},p.readAsDataURL(u)}}(this)):this.callback(o,0,a,"Incorrect object type, expected Sound"),a},c.prototype.writeAssetFile=function(e,t,n,o){var a,h,u,p,d,g;return g={ready:0},e instanceof msImage||e instanceof Sprite?(e instanceof Sprite&&(e=e.frames[0]),(p=n.ext)==="jpg"||p==="png"?a=n.ext:a="png",h=a==="jpg"?"image/jpeg":"image/png",u={name:"write_project_file",path:t,content:e.canvas.toDataURL(h),ext:a,options:n},this.runtime.listener.postRequest(u,function(P){return function(v){return P.callback(o,v.content,g,v.error)}}(this))):typeof e=="string"?((d=n.ext)==="txt"||d==="csv"||d==="obj"?a=n.ext:a="txt",u={name:"write_project_file",path:t,content:e,ext:a,options:n},this.runtime.listener.postRequest(u,function(P){return function(v){return P.callback(o,v.content,g,v.error)}}(this))):typeof e=="object"?(e=this.runtime.vm.storableObject(e),u={name:"write_project_file",path:t,content:e,ext:"json",options:n},this.runtime.listener.postRequest(u,function(P){return function(v){return P.callback(o,v.content,g,v.error)}}(this))):this.callback(o,0,g,"Unrecognized object type"),g},c.prototype.listFiles=function(e,t){var n,o;return n={name:"list_project_files",path:e},o={ready:0},this.runtime.listener.postRequest(n,function(a){if(o.ready=1,a.list&&(o.list=a.list),a.error&&(o.error=a.error),typeof t=="function")return t(a.list,a.error)}),o},c.prototype.readFile=function(e,t){var n,o,a;return o={name:"read_project_file",path:e},a={ready:0},n=e.split("/")[0],this.runtime.listener.postRequest(o,function(h){return function(u){var p,d,g;if(a.ready=1,u.error){if(a.error=u.error,typeof t=="function")return t(0,u.error)}else switch(n){case"sprites":g=LoadSprite(u.content.data,{fps:u.content.fps,frames:u.content.frames},function(){if(a.result=g,typeof t=="function")return t(a.result,0)});break;case"maps":d=new MicroMap(1,1,1,1),UpdateMap(d,u.content),a.result=d,typeof t=="function"&&t(a.result,0);break;case"sounds":case"music":g=new Sound(h.runtime.audio,u.content),a.result=g,typeof t=="function"&&t(g,0);break;case"assets":switch(u.content.type){case"text":a.result=u.content.data,t(a.result,0);break;case"json":a.result=u.content.data,t(a.result,0);break;case"image":p=new Image,p.src=u.content.data,p.onload=function(){var P;return P=new msImage(p),a.result=P,t(a.result,0)}}break;default:if(a.result=u.content.toString(),typeof t=="function")return t(a.result,0)}}}(this)),a},c.prototype.deleteFile=function(e,t){var n,o;return n={name:"delete_project_file",path:e},o={ready:0},this.runtime.listener.postRequest(n,function(a){if(o.ready=1,o.result=a.content||0,a.error&&(o.error=a.error),typeof t=="function")return t(o.result,a.error)}),o},c}(),this.TimeMachine=class{constructor(e){this.runtime=e,this.history=[],this.record_index=0,this.replay_position=0,this.recording=!1,this.max_length=60*30,this.record_length=0,this.loop_length=60*4}step(){var e,t,n,o,a,h,u,p,d;if(this.recording)try{if(this.replay_position!==0){for(n=[],d=this.record_length,e=this.replay_position+1,o=h=u=d,p=e;h>=p;o=h+=-1)a=(this.record_index-o+this.max_length)%this.max_length,n.push(this.history[a]);this.looping&&(this.loop_start=this.loop_length),this.history=n,this.record_index=this.history.length,this.record_length=this.history.length,this.replay_position=0}return this.history[this.record_index++]=this.storableHistory(this.runtime.vm.context.global),this.record_length=Math.min(this.record_length+1,this.max_length),this.record_index>=this.max_length&&(this.record_index=0),this.sendStatus()}catch(g){return t=g,console.error(t)}}messageReceived(e){var t;switch(e.command){case"start_recording":if(!this.recording)return this.recording=!0,this.record_index=0,this.replay_position=0,this.record_length=0,this.history=[],this.sendStatus();break;case"stop_recording":if(this.recording)return this.recording=!1,this.sendStatus();break;case"step_backward":return this.stepBackward();case"step_forward":return this.stepForward();case"replay_position":return t=Math.round(e.position),this.replay_position=Math.max(2,Math.min(this.record_length-1,t)),this.looping&&(this.loop_start=this.replay_position,this.loop_index=0),this.replay(),this.sendStatus();case"start_looping":return this.record_length===0?void 0:(this.looping=!0,this.recording=!1,this.loop_start=Math.max(this.replay_position,1),this.loop_index=0,this.loop());case"stop_looping":return this.stopLooping()}}stopLooping(){if(this.looping)return this.looping=!1,this.replay_position=this.loop_start,this.sendStatus()}loop(){if(this.looping)return requestAnimationFrame(()=>this.loop()),this.loop_index===0?(this.replay_position=this.loop_start,this.replay(!0),this.loop_index+=1):(this.loop_index+=1,this.loop_index>this.loop_length&&(this.loop_index=0),this.replay_position=this.loop_start-this.loop_index,this.replayControls(),this.runtime.updateCall(),this.runtime.drawCall(),this.runtime.watchStep(),this.resetControls()),this.sendStatus()}stepBackward(){if(!(this.replay_position+1>=this.record_length))return this.stopLooping(),this.replay_position+=1,this.replay(),this.sendStatus()}stepForward(){if(!(this.replay_position<=1))return this.stopLooping(),this.replay_position--,this.replay(),this.sendStatus()}replayControls(){var e;if(!(this.replay_position>=this.record_length)&&!(this.replay_position<=0))return e=(this.record_index-this.replay_position+this.max_length)%this.max_length,this.copyGlobal(this.history[e].keyboard,this.runtime.vm.context.global.keyboard),this.copyGlobal(this.history[e].gamepad,this.runtime.vm.context.global.gamepad),this.copyGlobal(this.history[e].touch,this.runtime.vm.context.global.touch),this.copyGlobal(this.history[e].mouse,this.runtime.vm.context.global.mouse)}resetControls(){var e,t;return this.runtime.keyboard.reset(),t=this.runtime.vm.context.global.touch,t.touching=0,t.touches=[],e=this.runtime.vm.context.global.mouse,e.pressed=0,e.left=0,e.right=0,e.middle=0}replay(e=!1){var t;return t=(this.record_index-this.replay_position+this.max_length)%this.max_length,this.copyGlobal(e?this.storableHistory(this.history[t]):this.history[t],this.runtime.vm.context.global),this.runtime.vm.call("draw"),this.runtime.vm.runner.tick!=null&&this.runtime.vm.runner.tick(),this.runtime.watchStep()}copyGlobal(e,t){var n,o;for(n in e)o=e[n],!(n==="keyboard"||n==="gamepad"||n==="touch"||n==="mouse")&&(typeof Routine>"u"||Routine===null||!(o instanceof Routine))&&!(o instanceof Program.Function)&&typeof o!="function"&&o.classname==null&&(t[n]=o);for(n in t)e[n]==null&&delete t[n]}sendStatus(){return this.runtime.listener.postMessage({name:"time_machine",command:"status",length:this.record_length,head:this.record_length-this.replay_position,max:this.max_length})}storableHistory(e){var t,n,o;return n=this.runtime.vm.context.global,this.excluded=[n.screen,n.system,n.audio,n.sprites,n.maps,n.sounds,n.music,n.assets,n.asset_manager,n.fonts,n.storage,window],n.PIXI!=null&&this.excluded.push(n.PIXI),n.BABYLON!=null&&this.excluded.push(n.BABYLON),n.M2D!=null&&this.excluded.push(n.M2D),n.M3D!=null&&this.excluded.push(n.M3D),n.Matter!=null&&this.excluded.push(n.Matter),n.CANNON!=null&&this.excluded.push(n.CANNON),n.Object!=null&&this.excluded.push(n.Object),n.List!=null&&this.excluded.push(n.List),n.String!=null&&this.excluded.push(n.String),n.Number!=null&&this.excluded.push(n.Number),n.Function!=null&&this.excluded.push(n.Function),n.random!=null&&this.excluded.push(n.random),o=[],t=[],this.makeStorableObject(e,o,t)}makeStorableObject(e,t,n){var o,a,h,u,p,d,g;if(e==null||typeof e=="function"||e instanceof Program.Function||typeof Routine<"u"&&Routine!==null&&e instanceof Routine)return e;if(typeof e=="object"){if(this.excluded.indexOf(e)>=0||e instanceof Sprite||e instanceof MicroMap||e instanceof msImage||e instanceof MicroSound||e.classname!=null)return e;if(a=t.indexOf(e),a>=0)return n[a];if(Array.isArray(e)){for(d=[],t.push(e),n.push(d),o=h=0,p=e.length;h<p;o=++h)g=e[o],g=this.makeStorableObject(g,t,n),g!=null&&(d[o]=g);return d}else{d={},t.push(e),n.push(d);for(u in e)g=e[u],g=this.makeStorableObject(g,t,n),g!=null&&(d[u]=g);return d}}else return e}},this.Screen=class{constructor(e){this.runtime=e,this.canvas=document.createElement("canvas"),this.canvas.width=1080,this.canvas.height=1920,this.touches={},this.mouse={x:-1e4,y:-1e4,pressed:0,left:0,middle:0,right:0,wheel:0},this.alpha=1,this.pixelated=1,this.line_width=1,this.translation_x=0,this.translation_y=0,this.rotation=0,this.scale_x=1,this.scale_y=1,this.screen_transform=!1,this.object_rotation=0,this.object_scale_x=1,this.object_scale_y=1,this.anchor_x=0,this.anchor_y=0,this.supersampling=this.previous_supersampling=1,this.font="BitCell",this.font_load_requested={},this.font_loaded={},this.loadFont(this.font),this.initContext(),this.cursor="default",this.canvas.addEventListener("mousemove",()=>{if(this.last_mouse_move=Date.now(),this.cursor!=="default"&&this.cursor_visibility==="auto")return this.cursor="default",this.canvas.style.cursor="default"}),setInterval(()=>this.checkMouseCursor(),1e3),this.cursor_visibility="auto"}checkMouseCursor(){if(Date.now()>this.last_mouse_move+4e3&&this.cursor_visibility==="auto"&&this.cursor!=="none")return this.cursor="none",this.canvas.style.cursor="none"}setCursorVisible(e){return this.cursor_visibility=e,e?(this.cursor="default",this.canvas.style.cursor="default"):(this.cursor="none",this.canvas.style.cursor="none")}initContext(){var e,t,n,o,a,h;for(t=this.canvas.getContext("2d",{alpha:!1}),t!==this.context?this.context=t:this.context.restore(),this.context.save(),this.context.translate(this.canvas.width/2,this.canvas.height/2),a=Math.min(this.canvas.width/200,this.canvas.height/200),this.context.scale(a,a),this.width=this.canvas.width/a,this.height=this.canvas.height/a,this.context.lineCap="round",this.blending={normal:"source-over",additive:"lighter"},h=["source-over","source-in","source-out","source-atop","destination-over","destination-in","destination-out","destination-atop","lighter","copy","xor","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"],n=0,o=h.length;n<o;n++)e=h[n],this.blending[e]=e}getInterface(){var e;return this.interface!=null?this.interface:(e=this,this.interface={width:this.width,height:this.height,clear:function(t){return e.clear(t)},setColor:function(t){return e.setColor(t)},setAlpha:function(t){return e.setAlpha(t)},setPixelated:function(t){return e.setPixelated(t)},setBlending:function(t){return e.setBlending(t)},setLinearGradient:function(t,n,o,a,h,u){return e.setLinearGradient(t,n,o,a,h,u)},setRadialGradient:function(t,n,o,a,h){return e.setRadialGradient(t,n,o,a,h)},setFont:function(t){return e.setFont(t)},setTranslation:function(t,n){return e.setTranslation(t,n)},setScale:function(t,n){return e.setScale(t,n)},setRotation:function(t){return e.setRotation(t)},setDrawAnchor:function(t,n){return e.setDrawAnchor(t,n)},setDrawRotation:function(t){return e.setDrawRotation(t)},setDrawScale:function(t,n){return e.setDrawScale(t,n)},fillRect:function(t,n,o,a,h){return e.fillRect(t,n,o,a,h)},fillRoundRect:function(t,n,o,a,h,u){return e.fillRoundRect(t,n,o,a,h,u)},fillRound:function(t,n,o,a,h){return e.fillRound(t,n,o,a,h)},drawRect:function(t,n,o,a,h){return e.drawRect(t,n,o,a,h)},drawRoundRect:function(t,n,o,a,h,u){return e.drawRoundRect(t,n,o,a,h,u)},drawRound:function(t,n,o,a,h){return e.drawRound(t,n,o,a,h)},drawSprite:function(t,n,o,a,h){return e.drawSprite(t,n,o,a,h)},drawImage:function(t,n,o,a,h){return e.drawSprite(t,n,o,a,h)},drawSpritePart:function(t,n,o,a,h,u,p,d,g){return e.drawSpritePart(t,n,o,a,h,u,p,d,g)},drawImagePart:function(t,n,o,a,h,u,p,d,g){return e.drawSpritePart(t,n,o,a,h,u,p,d,g)},drawMap:function(t,n,o,a,h){return e.drawMap(t,n,o,a,h)},drawText:function(t,n,o,a,h){return e.drawText(t,n,o,a,h)},drawTextOutline:function(t,n,o,a,h){return e.drawTextOutline(t,n,o,a,h)},textWidth:function(t,n){return e.textWidth(t,n)},setLineWidth:function(t){return e.setLineWidth(t)},setLineDash:function(t){return e.setLineDash(t)},drawLine:function(t,n,o,a,h){return e.drawLine(t,n,o,a,h)},drawPolygon:function(){return e.drawPolygon(arguments)},drawPolyline:function(){return e.drawPolyline(arguments)},fillPolygon:function(){return e.fillPolygon(arguments)},drawQuadCurve:function(){return e.drawQuadCurve(arguments)},drawBezierCurve:function(){return e.drawBezierCurve(arguments)},drawArc:function(t,n,o,a,h,u,p){return e.drawArc(t,n,o,a,h,u,p)},fillArc:function(t,n,o,a,h,u,p){return e.fillArc(t,n,o,a,h,u,p)},setCursorVisible:function(t){return e.setCursorVisible(t)},loadFont:function(t){return e.loadFont(t)},isFontReady:function(t){return e.isFontReady(t)}})}updateInterface(){return this.interface.width=this.width,this.interface.height=this.height}clear(e){var t,n,o;return n=this.context.fillStyle,o=this.context.strokeStyle,t=this.context.globalCompositeOperation,this.context.globalAlpha=1,this.context.globalCompositeOperation="source-over",e!=null?this.setColor(e):this.context.fillStyle="#000",this.context.fillRect(-this.width/2,-this.height/2,this.width,this.height),this.context.fillStyle=n,this.context.strokeStyle=o,this.context.globalCompositeOperation=t}initDraw(){if(this.alpha=1,this.line_width=1,this.supersampling!==this.previous_supersampling)return this.resize(),this.previous_supersampling=this.supersampling}setColor(e){var t,n,o,a;if(e!=null)if(Number.isNaN(Number.parseInt(e))){if(typeof e=="string")return this.context.fillStyle=e,this.context.strokeStyle=e}else return a=Math.floor(e/100)%10/9*255,o=Math.floor(e/10)%10/9*255,t=Math.floor(e)%10/9*255,n=4278190080,n+=a<<16,n+=o<<8,n+=t,n="#"+n.toString(16).substring(2,8),this.context.fillStyle=n,this.context.strokeStyle=n}setAlpha(e){this.alpha=e}setPixelated(e){this.pixelated=e}setBlending(e){return e=this.blending[e||"normal"]||"source-over",this.context.globalCompositeOperation=e}setLineWidth(e){this.line_width=e}setLineDash(e){return Array.isArray(e)?this.context.setLineDash(e):this.context.setLineDash([])}setLinearGradient(e,t,n,o,a,h){var u;return u=this.context.createLinearGradient(e,-t,n,-o),u.addColorStop(0,a),u.addColorStop(1,h),this.context.fillStyle=u,this.context.strokeStyle=u}setRadialGradient(e,t,n,o,a){var h;return h=this.context.createRadialGradient(e,-t,0,e,-t,n),h.addColorStop(0,o),h.addColorStop(1,a),this.context.fillStyle=h,this.context.strokeStyle=h}setFont(e){return this.font=e||"Verdana",this.loadFont(this.font)}loadFont(e="BitCell"){var t;if(!this.font_load_requested[e]){this.font_load_requested[e]=!0;try{document.fonts!=null&&document.fonts.load!=null&&document.fonts.load(`16pt ${e}`)}catch(n){t=n}}return 1}isFontReady(e=this.font){var t,n;if(this.font_loaded[e])return 1;try{if(document.fonts!=null&&document.fonts.check!=null)return n=document.fonts.check(`16pt ${e}`),n&&(this.font_loaded[e]=n),n?1:0}catch(o){t=o}return 1}setTranslation(e,t){return this.translation_x=e,this.translation_y=t,isFinite(this.translation_x)||(this.translation_x=0),isFinite(this.translation_y)||(this.translation_y=0),this.updateScreenTransform()}setScale(e,t){return this.scale_x=e,this.scale_y=t,(!isFinite(this.scale_x)||this.scale_x===0)&&(this.scale_x=1),(!isFinite(this.scale_y)||this.scale_y===0)&&(this.scale_y=1),this.updateScreenTransform()}setRotation(e){return this.rotation=e,isFinite(this.rotation)||(this.rotation=0),this.updateScreenTransform()}updateScreenTransform(){return this.screen_transform=this.translation_x!==0||this.translation_y!==0||this.scale_x!==1||this.scale_y!==1||this.rotation!==0}setDrawAnchor(e,t){if(this.anchor_x=e,this.anchor_y=t,typeof this.anchor_x!="number"&&(this.anchor_x=0),typeof this.anchor_y!="number")return this.anchor_y=0}setDrawRotation(e){this.object_rotation=e}setDrawScale(e,t=this.object_scale_x){this.object_scale_x=e,this.object_scale_y=t}initDrawOp(e,t,n=!0){var o;return o=!1,this.screen_transform&&(this.context.save(),o=!0,this.context.translate(this.translation_x,-this.translation_y),this.context.scale(this.scale_x,this.scale_y),this.context.rotate(-this.rotation/180*Math.PI),this.context.translate(e,t)),n&&(this.object_rotation!==0||this.object_scale_x!==1||this.object_scale_y!==1)&&(o||(this.context.save(),o=!0,this.context.translate(e,t)),this.object_rotation!==0&&this.context.rotate(-this.object_rotation/180*Math.PI),(this.object_scale_x!==1||this.object_scale_y!==1)&&this.context.scale(this.object_scale_x,this.object_scale_y)),o}closeDrawOp(e,t){return this.context.restore()}fillRect(e,t,n,o,a){return this.setColor(a),this.context.globalAlpha=this.alpha,this.initDrawOp(e,-t)?(this.context.fillRect(-n/2-this.anchor_x*n/2,-o/2+this.anchor_y*o/2,n,o),this.closeDrawOp(e,-t)):this.context.fillRect(e-n/2-this.anchor_x*n/2,-t-o/2+this.anchor_y*o/2,n,o)}fillRoundRect(e,t,n,o,a=10,h){return this.setColor(h),this.context.globalAlpha=this.alpha,this.initDrawOp(e,-t)?(this.context.fillRoundRect(-n/2-this.anchor_x*n/2,-o/2+this.anchor_y*o/2,n,o,a),this.closeDrawOp(e,-t)):this.context.fillRoundRect(e-n/2-this.anchor_x*n/2,-t-o/2+this.anchor_y*o/2,n,o,a)}fillRound(e,t,n,o,a){return this.setColor(a),this.context.globalAlpha=this.alpha,n=Math.abs(n),o=Math.abs(o),this.initDrawOp(e,-t)?(this.context.beginPath(),this.context.ellipse(-this.anchor_x*n/2,0+this.anchor_y*o/2,n/2,o/2,0,0,Math.PI*2,!1),this.context.fill(),this.closeDrawOp(e,-t)):(this.context.beginPath(),this.context.ellipse(e-this.anchor_x*n/2,-t+this.anchor_y*o/2,n/2,o/2,0,0,Math.PI*2,!1),this.context.fill())}drawRect(e,t,n,o,a){return this.setColor(a),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,this.initDrawOp(e,-t)?(this.context.strokeRect(-n/2-this.anchor_x*n/2,-o/2+this.anchor_y*o/2,n,o),this.closeDrawOp(e,-t)):this.context.strokeRect(e-n/2-this.anchor_x*n/2,-t-o/2+this.anchor_y*o/2,n,o)}drawRoundRect(e,t,n,o,a=10,h){return this.setColor(h),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,this.initDrawOp(e,-t)?(this.context.strokeRoundRect(-n/2-this.anchor_x*n/2,-o/2+this.anchor_y*o/2,n,o,a),this.closeDrawOp(e,-t)):this.context.strokeRoundRect(e-n/2-this.anchor_x*n/2,-t-o/2+this.anchor_y*o/2,n,o,a)}drawRound(e,t,n,o,a){return this.setColor(a),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,n=Math.abs(n),o=Math.abs(o),this.initDrawOp(e,-t)?(this.context.beginPath(),this.context.ellipse(0-this.anchor_x*n/2,0+this.anchor_y*o/2,n/2,o/2,0,0,Math.PI*2,!1),this.context.stroke(),this.closeDrawOp(e,-t)):(this.context.beginPath(),this.context.ellipse(e-this.anchor_x*n/2,-t+this.anchor_y*o/2,n/2,o/2,0,0,Math.PI*2,!1),this.context.stroke())}drawLine(e,t,n,o,a){var h;if(this.setColor(a),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,h=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(e,-t),this.context.lineTo(n,-o),this.context.stroke(),h)return this.closeDrawOp()}drawPolyline(e){var t,n,o,a,h;if(e.length>0&&e.length%2===1&&typeof e[e.length-1]=="string"&&this.setColor(e[e.length-1]),Array.isArray(e[0])&&(e[1]!=null&&typeof e[1]=="string"&&this.setColor(e[1]),e=e[0]),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,!(e.length<4)){for(o=Math.floor(e.length/2),h=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(e[0],-e[1]),t=n=1,a=o-1;1<=a?n<=a:n>=a;t=1<=a?++n:--n)this.context.lineTo(e[t*2],-e[t*2+1]);if(this.context.stroke(),h)return this.closeDrawOp()}}drawPolygon(e){var t,n,o,a,h;if(e.length>0&&e.length%2===1&&typeof e[e.length-1]=="string"&&this.setColor(e[e.length-1]),Array.isArray(e[0])&&(e[1]!=null&&typeof e[1]=="string"&&this.setColor(e[1]),e=e[0]),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,!(e.length<4)){for(o=Math.floor(e.length/2),h=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(e[0],-e[1]),t=n=1,a=o-1;1<=a?n<=a:n>=a;t=1<=a?++n:--n)this.context.lineTo(e[t*2],-e[t*2+1]);if(this.context.closePath(),this.context.stroke(),h)return this.closeDrawOp()}}fillPolygon(e){var t,n,o,a,h;if(e.length>0&&e.length%2===1&&typeof e[e.length-1]=="string"&&this.setColor(e[e.length-1]),Array.isArray(e[0])&&(e[1]!=null&&typeof e[1]=="string"&&this.setColor(e[1]),e=e[0]),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,!(e.length<4)){for(o=Math.floor(e.length/2),h=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(e[0],-e[1]),t=n=1,a=o-1;1<=a?n<=a:n>=a;t=1<=a?++n:--n)this.context.lineTo(e[t*2],-e[t*2+1]);if(this.context.fill(),h)return this.closeDrawOp()}}drawQuadCurve(e){var t,n,o;if(e.length>0&&e.length%2===1&&typeof e[e.length-1]=="string"&&this.setColor(e[e.length-1]),Array.isArray(e[0])&&(e[1]!=null&&typeof e[1]=="string"&&this.setColor(e[1]),e=e[0]),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,!(e.length<4)){for(n=Math.floor(e.length/2),o=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(e[0],-e[1]),t=2;t<=e.length-4;)this.context.quadraticCurveTo(e[t],-e[t+1],e[t+2],-e[t+3]),t+=4;if(this.context.stroke(),o)return this.closeDrawOp()}}drawBezierCurve(e){var t,n,o;if(e.length>0&&e.length%2===1&&typeof e[e.length-1]=="string"&&this.setColor(e[e.length-1]),Array.isArray(e[0])&&(e[1]!=null&&typeof e[1]=="string"&&this.setColor(e[1]),e=e[0]),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,!(e.length<4)){for(n=Math.floor(e.length/2),o=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(e[0],-e[1]),t=2;t<=e.length-6;)this.context.bezierCurveTo(e[t],-e[t+1],e[t+2],-e[t+3],e[t+4],-e[t+5]),t+=6;if(this.context.stroke(),o)return this.closeDrawOp()}}drawArc(e,t,n,o,a,h,u){return this.setColor(u),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,this.initDrawOp(e,-t)?(this.context.beginPath(),this.context.arc(0,0,n,-o/180*Math.PI,-a/180*Math.PI,h),this.context.stroke(),this.closeDrawOp(e,-t)):(this.context.beginPath(),this.context.arc(e,-t,n,-o/180*Math.PI,-a/180*Math.PI,h),this.context.stroke())}fillArc(e,t,n,o,a,h,u){return this.setColor(u),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,this.initDrawOp(e,-t)?(this.context.beginPath(),this.context.arc(0,0,n,-o/180*Math.PI,-a/180*Math.PI,h),this.context.fill(),this.closeDrawOp(e,-t)):(this.context.beginPath(),this.context.arc(e,-t,n,-o/180*Math.PI,-a/180*Math.PI,h),this.context.fill())}textWidth(e,t){return this.context.font=`${t}pt ${this.font}`,this.context.measureText(e).width}drawText(e,t,n,o,a){var h,u;return this.setColor(a),this.context.globalAlpha=this.alpha,this.context.font=`${o}pt ${this.font}`,this.context.textAlign="center",this.context.textBaseline="middle",u=this.context.measureText(e).width,h=o,this.initDrawOp(t,-n)?(this.context.fillText(e,0-this.anchor_x*u/2,0+this.anchor_y*h/2),this.closeDrawOp(t,-n)):this.context.fillText(e,t-this.anchor_x*u/2,-n+this.anchor_y*h/2)}drawTextOutline(e,t,n,o,a){var h,u;return this.setColor(a),this.context.globalAlpha=this.alpha,this.context.font=`${o}pt ${this.font}`,this.context.lineWidth=this.line_width,this.context.textAlign="center",this.context.textBaseline="middle",u=this.context.measureText(e).width,h=o,this.initDrawOp(t,-n)?(this.context.strokeText(e,0-this.anchor_x*u/2,0+this.anchor_y*h/2),this.closeDrawOp(t,-n)):this.context.strokeText(e,t-this.anchor_x*u/2,-n+this.anchor_y*h/2)}getSpriteFrame(e){var t,n,o;if(n=null,typeof e=="string")o=this.runtime.sprites[e],o!=null?e=o:(o=e.split("."),o.length>1&&(e=this.runtime.sprites[o[0]],n=o[1]|0));else if(e instanceof msImage)return e.canvas||e.image;return e==null||!e.ready?null:e.frames.length>1?(n==null&&(t=1e3/e.fps,n=Math.floor((Date.now()-e.animation_start)/t)%e.frames.length),n>=0&&n<e.frames.length?e.frames[n].canvas:e.frames[0].canvas):e.frames[0]!=null?e.frames[0].canvas:null}drawSprite(e,t,n,o,a){var h;if(h=this.getSpriteFrame(e),h!=null)return o==null&&(o=h.width),a||(a=o/h.width*h.height),this.context.globalAlpha=this.alpha,this.context.imageSmoothingEnabled=!this.pixelated,this.initDrawOp(t,-n)?(this.context.drawImage(h,-o/2-this.anchor_x*o/2,-a/2+this.anchor_y*a/2,o,a),this.closeDrawOp(t,-n)):this.context.drawImage(h,t-o/2-this.anchor_x*o/2,-n-a/2+this.anchor_y*a/2,o,a)}drawSpritePart(e,t,n,o,a,h,u,p,d){var g;if(g=this.getSpriteFrame(e),g!=null)return p==null&&(p=o),d||(d=p/o*a),this.context.globalAlpha=this.alpha,this.context.imageSmoothingEnabled=!this.pixelated,this.initDrawOp(h,-u)?(this.context.drawImage(g,t,n,o,a,-p/2-this.anchor_x*p/2,-d/2+this.anchor_y*d/2,p,d),this.closeDrawOp(h,-u)):this.context.drawImage(g,t,n,o,a,h-p/2-this.anchor_x*p/2,-u-d/2+this.anchor_y*d/2,p,d)}drawMap(e,t,n,o,a){if(typeof e=="string"&&(e=this.runtime.maps[e]),!(e==null||!e.ready))return this.context.globalAlpha=this.alpha,this.context.imageSmoothingEnabled=!this.pixelated,this.initDrawOp(t,-n)?(e.draw(this.context,-o/2-this.anchor_x*o/2,-a/2+this.anchor_y*a/2,o,a),this.closeDrawOp(t,-n)):e.draw(this.context,t-o/2-this.anchor_x*o/2,-n-a/2+this.anchor_y*a/2,o,a)}resize(){var e,t,n,o,a,h,u,p,d;if(n=window.innerWidth,t=window.innerHeight,p={"4x3":4/3,"16x9":16/9,"2x1":2/1,"1x1":1/1,">4x3":4/3,">16x9":16/9,">2x1":2/1,">1x1":1/1}[this.runtime.aspect],h=this.runtime.aspect.startsWith(">"),p!=null){if(h)switch(this.runtime.orientation){case"portrait":p=Math.max(p,t/n);break;case"landscape":p=Math.max(p,n/t);break;default:t>n?p=Math.max(p,t/n):p=Math.max(p,n/t)}switch(this.runtime.orientation){case"portrait":u=Math.min(n,t/p)/n,d=n*u,a=n*u*p;break;case"landscape":u=Math.min(n/p,t)/t,d=t*u*p,a=t*u;break;default:n>t?(u=Math.min(n/p,t)/t,d=t*u*p,a=t*u):(u=Math.min(n,t/p)/n,d=n*u,a=n*u*p)}}else d=n,a=t;return this.canvas.style["margin-top"]=Math.round((t-a)/2)+"px",this.canvas.style.width=Math.round(d)+"px",this.canvas.style.height=Math.round(a)+"px",o=window.devicePixelRatio||1,e=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1,this.ratio=o/e*Math.max(1,Math.min(2,this.supersampling)),this.width=d*this.ratio,this.height=a*this.ratio,this.canvas.width=this.width,this.canvas.height=this.height,this.initContext()}startControl(e){var t,n;return this.element=e,document.addEventListener("touchstart",o=>this.touchStart(o)),document.addEventListener("touchmove",o=>this.touchMove(o)),document.addEventListener("touchend",o=>this.touchRelease(o)),document.addEventListener("touchcancel",o=>this.touchRelease(o)),document.addEventListener("mousedown",o=>this.mouseDown(o)),document.addEventListener("mousemove",o=>this.mouseMove(o)),document.addEventListener("mouseup",o=>this.mouseUp(o)),document.addEventListener("mousewheel",o=>this.mouseWheel(o)),document.addEventListener("DOMMouseScroll",o=>this.mouseWheel(o)),n=window.devicePixelRatio||1,t=this.context.webkitBackingStorePixelRatio||this.context.mozBackingStorePixelRatio||this.context.msBackingStorePixelRatio||this.context.oBackingStorePixelRatio||this.context.backingStorePixelRatio||1,this.ratio=n/t}touchStart(e){var t,n,o,a,h,u,p,d;for(e.preventDefault(),e.stopPropagation(),t=this.canvas.getBoundingClientRect(),n=o=0,h=e.changedTouches.length-1;o<=h;n=o+=1)u=e.changedTouches[n],a=Math.min(this.canvas.clientWidth,this.canvas.clientHeight),p=(u.clientX-t.left-this.canvas.clientWidth/2)/a*200,d=(this.canvas.clientHeight/2-(u.clientY-t.top))/a*200,this.touches[u.identifier]={x:p,y:d},this.mouse.x=p,this.mouse.y=d,this.mouse.pressed=1,this.mouse.left=1;return!1}touchMove(e){var t,n,o,a,h,u,p,d;for(e.preventDefault(),e.stopPropagation(),t=this.canvas.getBoundingClientRect(),n=o=0,h=e.changedTouches.length-1;o<=h;n=o+=1)u=e.changedTouches[n],this.touches[u.identifier]!=null&&(a=Math.min(this.canvas.clientWidth,this.canvas.clientHeight),p=(u.clientX-t.left-this.canvas.clientWidth/2)/a*200,d=(this.canvas.clientHeight/2-(u.clientY-t.top))/a*200,this.touches[u.identifier].x=p,this.touches[u.identifier].y=d,this.mouse.x=p,this.mouse.y=d);return!1}touchRelease(e){var t,n,o,a,h,u;for(t=n=0,o=e.changedTouches.length-1;n<=o;t=n+=1)a=e.changedTouches[t],h=(a.clientX-this.canvas.offsetLeft)*this.ratio,u=(a.clientY-this.canvas.offsetTop)*this.ratio,delete this.touches[a.identifier],this.mouse.pressed=0,this.mouse.left=0,this.mouse.right=0,this.mouse.middle=0;return!1}mouseDown(e){var t,n,o,a;switch(this.mousepressed=!0,t=this.canvas.getBoundingClientRect(),n=Math.min(this.canvas.clientWidth,this.canvas.clientHeight),o=(e.clientX-t.left-this.canvas.clientWidth/2)/n*200,a=(this.canvas.clientHeight/2-(e.clientY-t.top))/n*200,this.touches.mouse={x:o,y:a},this.mouse.x=o,this.mouse.y=a,e.button){case 0:this.mouse.left=1;break;case 1:this.mouse.middle=1;break;case 2:this.mouse.right=1}return this.mouse.pressed=Math.min(1,this.mouse.left+this.mouse.right+this.mouse.middle),!1}mouseMove(e){var t,n,o,a;return e.preventDefault(),t=this.canvas.getBoundingClientRect(),n=Math.min(this.canvas.clientWidth,this.canvas.clientHeight),o=(e.clientX-t.left-this.canvas.clientWidth/2)/n*200,a=(this.canvas.clientHeight/2-(e.clientY-t.top))/n*200,this.touches.mouse!=null&&(this.touches.mouse.x=o,this.touches.mouse.y=a),this.mouse.x=o,this.mouse.y=a,!1}mouseUp(e){var t,n,o,a;switch(delete this.touches.mouse,t=this.canvas.getBoundingClientRect(),n=Math.min(this.canvas.clientWidth,this.canvas.clientHeight),o=(e.clientX-t.left-this.canvas.clientWidth/2)/n*200,a=(this.canvas.clientHeight/2-(e.clientY-t.top))/n*200,this.mouse.x=o,this.mouse.y=a,e.button){case 0:this.mouse.left=0;break;case 1:this.mouse.middle=0;break;case 2:this.mouse.right=0}return this.mouse.pressed=Math.min(1,this.mouse.left+this.mouse.right+this.mouse.middle),!1}mouseWheel(e){return e.wheelDelta<0||e.detail>0?this.wheel=-1:this.wheel=1}takePicture(e){return e(this.canvas.toDataURL())}},this.AssetManager=class{constructor(e){this.runtime=e,this.interface={loadFont:t=>this.loadFont(t),loadModel:(t,n,o)=>this.loadModel(t,n,o),loadImage:(t,n)=>this.loadImage(t,n),loadJSON:(t,n)=>this.loadJSON(t,n),loadText:(t,n)=>this.loadText(t,n),loadCSV:(t,n)=>this.loadCSV(t,n),loadMarkdown:(t,n)=>this.loadMarkdown(t,n)}}getInterface(){return this.interface}loadFont(e){var t,n,o,a;if(typeof e=="string"){n=e.replace(/\//g,"-"),a=n.split("-"),o=a[a.length-1];try{return e=new FontFace(o,`url(assets/${n}.ttf)`),e.load().then(()=>document.fonts.add(e))}catch(h){return t=h,console.error(t)}}}loadModel(e,t,n){var o;if(!(typeof BABYLON>"u"||BABYLON===null))return o={ready:0},this.runtime.assets[e]!=null?e=this.runtime.assets[e].file:(e=e.replace(/\//g,"-"),e+=".glb"),BABYLON.SceneLoader.LoadAssetContainer("",`assets/${e}`,t,a=>{if(o.container=a,o.ready=1,n)return n(a)})}loadImage(e,t){var n,o;return o={ready:0},this.runtime.assets[e]!=null&&(e=this.runtime.assets[e].file),n=new Image,n.src=`assets/${e}`,n.onload=()=>{var a;if(a=new msImage(n),o.image=a,o.ready=1,t)return t(a)},o}loadJSON(e,t){var n;return e=e.replace(/\//g,"-"),e=`assets/${e}.json`,n={ready:0},fetch(e).then(o=>o.json().then(a=>{if(n.data=a,n.ready=1,t)return t(a)})),n}loadText(e,t,n="txt"){var o;return e=e.replace(/\//g,"-"),e=`assets/${e}.${n}`,o={ready:0},fetch(e).then(a=>a.text().then(h=>{if(o.text=h,o.ready=1,t)return t(h)})),o}loadCSV(e,t){return this.loadText(e,t,"csv")}loadMarkdown(e,t){return this.loadText(e,t,"md")}},this.Keyboard=function(){function c(){document.addEventListener("keydown",function(e){return function(t){return e.keydown(t)}}(this)),document.addEventListener("keyup",function(e){return function(t){return e.keyup(t)}}(this)),this.keyboard={press:{},release:{}},this.previous={}}return c.prototype.convertCode=function(e){var t,n,o,a,h,u;for(u="",a=!1,n=o=0,h=e.length-1;0<=h?o<=h:o>=h;n=0<=h?++o:--o)t=e.charAt(n),t===t.toUpperCase()&&a?(u+="_",a=!1):a=!0,u+=t.toUpperCase();return u},c.prototype.keydown=function(e){var t,n;return!e.altKey&&!e.ctrlKey&&!e.metaKey&&!/Escape|(F\d+)/.test(e.key)&&e.preventDefault(),t=e.code,n=e.key,this.keyboard[this.convertCode(t)]=1,this.keyboard[n.toUpperCase()]=1,this.updateDirectional()},c.prototype.keyup=function(e){var t,n;return t=e.code,n=e.key,this.keyboard[this.convertCode(t)]=0,this.keyboard[n.toUpperCase()]=0,this.updateDirectional()},c.prototype.updateDirectional=function(){return this.keyboard.UP=this.keyboard.KEY_W||this.keyboard.ARROW_UP,this.keyboard.DOWN=this.keyboard.KEY_S||this.keyboard.ARROW_DOWN,this.keyboard.LEFT=this.keyboard.KEY_A||this.keyboard.ARROW_LEFT,this.keyboard.RIGHT=this.keyboard.KEY_D||this.keyboard.ARROW_RIGHT},c.prototype.update=function(){var e;for(e in this.keyboard.press)this.keyboard.press[e]=0;for(e in this.keyboard.release)this.keyboard.release[e]=0;for(e in this.previous)this.previous[e]&&!this.keyboard[e]&&(this.keyboard.release[e]=1);for(e in this.keyboard)e==="press"||e==="release"||this.keyboard[e]&&!this.previous[e]&&(this.keyboard.press[e]=1);for(e in this.previous)this.previous[e]=0;for(e in this.keyboard)e==="press"||e==="release"||(this.previous[e]=this.keyboard[e])},c.prototype.reset=function(){var e;for(e in this.keyboard)e==="press"||e==="release"||(this.keyboard[e]=0)},c}(),this.Gamepad=function(){function c(e,t){var n,o;this.listener=e,this.index=t??0;try{navigator.getGamepads!=null&&(o=navigator.getGamepads(),this.index<o.length&&o[this.index]!=null&&(this.pad=o[this.index]))}catch(a){n=a,console.error(n)}this.buttons_map={0:"A",1:"B",2:"X",3:"Y",4:"LB",5:"RB",8:"VIEW",9:"MENU",10:"LS",11:"RS",12:"DPAD_UP",13:"DPAD_DOWN",14:"DPAD_LEFT",15:"DPAD_RIGHT"},this.triggers_map={6:"LT",7:"RT"},this.status={press:{},release:{}},this.previous={global:{},0:{},1:{},2:{},3:{}}}return c.prototype.update=function(){var e,t,n,o,a,h,u,p,d,g,P,v,O,y,x,A,I,S,C,G,Y,L,J,Q,U,N,V;try{A=navigator.getGamepads()}catch(X){t=X;return}for(x=0,n=o=0,p=A.length;o<p&&(y=A[n],y!=null);n=++o){x++,this.status[n]||(this.status[n]={press:{},release:{}}),S=this.buttons_map;for(h in S)U=S[h],y.buttons[h]!=null&&(this.status[n][U]=y.buttons[h].pressed?1:0);C=this.triggers_map;for(h in C)U=C[h],y.buttons[h]!=null&&(this.status[n][U]=y.buttons[h].value);y.axes.length>=2&&(N=y.axes[0],V=-y.axes[1],I=Math.sqrt(N*N+V*V),e=Math.floor((Math.atan2(V,N)+Math.PI*2)%(Math.PI*2)/(Math.PI*2)*360),this.status[n].LEFT_STICK_ANGLE=e,this.status[n].LEFT_STICK_AMOUNT=I,this.status[n].LEFT_STICK_UP=V>.5,this.status[n].LEFT_STICK_DOWN=V<-.5,this.status[n].LEFT_STICK_LEFT=N<-.5,this.status[n].LEFT_STICK_RIGHT=N>.5),y.axes.length>=4&&(N=y.axes[2],V=-y.axes[3],I=Math.sqrt(N*N+V*V),e=Math.floor((Math.atan2(V,N)+Math.PI*2)%(Math.PI*2)/(Math.PI*2)*360),this.status[n].RIGHT_STICK_ANGLE=e,this.status[n].RIGHT_STICK_AMOUNT=I,this.status[n].RIGHT_STICK_UP=V>.5,this.status[n].RIGHT_STICK_DOWN=V<-.5,this.status[n].RIGHT_STICK_LEFT=N<-.5,this.status[n].RIGHT_STICK_RIGHT=N>.5)}G=this.buttons_map;for(h in G)for(U=G[h],this.status[U]=0,a=0,d=A.length;a<d&&(y=A[a],y!=null);a++)y.buttons[h]!=null&&y.buttons[h].pressed&&(this.status[U]=1);Y=this.triggers_map;for(h in Y)for(U=Y[h],this.status[U]=0,u=0,g=A.length;u<g&&(y=A[u],y!=null);u++)y.buttons[h]!=null&&(this.status[U]=y.buttons[h].value);for(this.status.UP=0,this.status.DOWN=0,this.status.LEFT=0,this.status.RIGHT=0,this.status.LEFT_STICK_UP=0,this.status.LEFT_STICK_DOWN=0,this.status.LEFT_STICK_LEFT=0,this.status.LEFT_STICK_RIGHT=0,this.status.RIGHT_STICK_UP=0,this.status.RIGHT_STICK_DOWN=0,this.status.RIGHT_STICK_LEFT=0,this.status.RIGHT_STICK_RIGHT=0,this.status.LEFT_STICK_ANGLE=0,this.status.LEFT_STICK_AMOUNT=0,this.status.RIGHT_STICK_ANGLE=0,this.status.RIGHT_STICK_AMOUNT=0,this.status.RT=0,this.status.LT=0,n=P=0,L=x-1;P<=L;n=P+=1)this.status[n].UP=this.status[n].DPAD_UP||this.status[n].LEFT_STICK_UP||this.status[n].RIGHT_STICK_UP,this.status[n].DOWN=this.status[n].DPAD_DOWN||this.status[n].LEFT_STICK_DOWN||this.status[n].RIGHT_STICK_DOWN,this.status[n].LEFT=this.status[n].DPAD_LEFT||this.status[n].LEFT_STICK_LEFT||this.status[n].RIGHT_STICK_LEFT,this.status[n].RIGHT=this.status[n].DPAD_RIGHT||this.status[n].LEFT_STICK_RIGHT||this.status[n].RIGHT_STICK_RIGHT,this.status[n].UP&&(this.status.UP=1),this.status[n].DOWN&&(this.status.DOWN=1),this.status[n].LEFT&&(this.status.LEFT=1),this.status[n].RIGHT&&(this.status.RIGHT=1),this.status[n].LEFT_STICK_UP&&(this.status.LEFT_STICK_UP=1),this.status[n].LEFT_STICK_DOWN&&(this.status.LEFT_STICK_DOWN=1),this.status[n].LEFT_STICK_LEFT&&(this.status.LEFT_STICK_LEFT=1),this.status[n].LEFT_STICK_RIGHT&&(this.status.LEFT_STICK_RIGHT=1),this.status[n].RIGHT_STICK_UP&&(this.status.RIGHT_STICK_UP=1),this.status[n].RIGHT_STICK_DOWN&&(this.status.RIGHT_STICK_DOWN=1),this.status[n].RIGHT_STICK_LEFT&&(this.status.RIGHT_STICK_LEFT=1),this.status[n].RIGHT_STICK_RIGHT&&(this.status.RIGHT_STICK_RIGHT=1),this.status[n].LT&&(this.status.LT=this.status[n].LT),this.status[n].RT&&(this.status.RT=this.status[n].RT),this.status[n].LEFT_STICK_AMOUNT>this.status.LEFT_STICK_AMOUNT&&(this.status.LEFT_STICK_AMOUNT=this.status[n].LEFT_STICK_AMOUNT,this.status.LEFT_STICK_ANGLE=this.status[n].LEFT_STICK_ANGLE),this.status[n].RIGHT_STICK_AMOUNT>this.status.RIGHT_STICK_AMOUNT&&(this.status.RIGHT_STICK_AMOUNT=this.status[n].RIGHT_STICK_AMOUNT,this.status.RIGHT_STICK_ANGLE=this.status[n].RIGHT_STICK_ANGLE);for(n=v=J=x;v<=3;n=v+=1)delete this.status[n];for(this.count=x,this.updateChanges(this.status,this.previous.global),n=O=0,Q=x-1;O<=Q;n=O+=1)this.updateChanges(this.status[n],this.previous[n])},c.prototype.updateChanges=function(e,t){var n;for(n in e.press)e.press[n]=0;for(n in e.release)e.release[n]=0;for(n in t)t[n]&&!e[n]&&(e.release[n]=1);for(n in e)n==="press"||n==="release"||e[n]&&!t[n]&&(e.press[n]=1);for(n in t)t[n]=0;for(n in e)n==="press"||n==="release"||(t[n]=e[n])},c}(),this.Sprite=class{constructor(e,t){this.width=e,this.height=t,this.name="",this.frames=[],this.animation_start=0,this.fps=5,this.width>0&&this.height>0&&(this.frames.push(new msImage(this.width,this.height)),this.ready=1)}setFPS(e){var t,n;return t=1e3/this.fps,n=(Date.now()-this.animation_start)/t%this.frames.length,this.fps=e,t=1e3/e,this.animation_start=Date.now()-n*t,e}setFrame(e){return this.animation_start=Date.now()-1e3/this.fps*e}getFrame(){var e;return e=1e3/this.fps,Math.floor((Date.now()-this.animation_start)/e)%this.frames.length}},this.LoadSprite=function(c,e,t){var n,o;return o=new Sprite(0,0),o.ready=0,n=new Image,location.protocol!=="file:"&&(n.crossOrigin="Anonymous"),n.src=c,n.onload=()=>{var a,h,u,p,d;if(o.ready=!0,n.width>0&&n.height>0){for(p=1,e!=null&&e.frames!=null&&(p=e.frames),e.fps!=null&&(o.fps=e.fps),o.width=n.width,o.height=Math.round(n.height/p),o.frames=[],h=u=0,d=p-1;0<=d?u<=d:u>=d;h=0<=d?++u:--u)a=new msImage(o.width,o.height),a.initContext(),a.context.drawImage(n,0,-h*o.height),o.frames.push(a);o.ready=!0}if(t!=null)return t()},n.onerror=()=>o.ready=1,o},this.UpdateSprite=function(c,e,t){var n,o,a,h,u;if(e.width>0&&e.height>0){for(h=1,t!=null&&t.frames!=null&&(h=t.frames),t!=null&&t.fps!=null&&(c.fps=t.fps),c.width=e.width,c.height=Math.round(e.height/h),c.frames=[],o=a=0,u=h-1;0<=u?a<=u:a>=u;o=0<=u?++a:--a)n=new msImage(c.width,c.height),n.initContext(),n.context.drawImage(e,0,-o*c.height),c.frames.push(n);return c.ready=!0}};var b,j,len1,ref;for(this.msImage=function(){class c{constructor(t,n,o=!1){this.width=t,this.height=n,this.centered=o,this.class=c,this.width instanceof Image?(this.image=this.width,this.width=this.image.width,this.height=this.image.height):this.width instanceof HTMLCanvasElement?(this.canvas=this.width,this.width=this.canvas.width,this.height=this.canvas.height):(this.canvas=document.createElement("canvas"),this.canvas.width=this.width=Math.round(this.width),this.canvas.height=this.height=Math.round(this.height))}setRGB(t,n,o,a,h){return this.initContext(),this.pixeldata==null&&(this.pixeldata=this.context.getImageData(0,0,1,1)),o.R!=null?(this.pixeldata.data[0]=o.R,this.pixeldata.data[1]=o.G,this.pixeldata.data[2]=o.B):(this.pixeldata.data[0]=o,this.pixeldata.data[1]=a,this.pixeldata.data[2]=h),this.pixeldata.data[3]=255,this.context.putImageData(this.pixeldata,t,n)}setRGBA(t,n,o,a,h,u){return this.initContext(),this.pixeldata==null&&(this.pixeldata=this.context.getImageData(0,0,1,1)),o.R!=null?(this.pixeldata.data[0]=o.R,this.pixeldata.data[1]=o.G,this.pixeldata.data[2]=o.B,this.pixeldata.data[3]=o.A!=null?o.A:255):(this.pixeldata.data[0]=o,this.pixeldata.data[1]=a,this.pixeldata.data[2]=h,this.pixeldata.data[3]=u),this.context.putImageData(this.pixeldata,t,n)}getRGB(t,n,o={}){var a;return this.initContext(),a=this.context.getImageData(t,n,1,1),o.R=a.data[0],o.G=a.data[1],o.B=a.data[2],o}getRGBA(t,n,o={}){var a;return this.initContext(),a=this.context.getImageData(t,n,1,1),o.R=a.data[0],o.G=a.data[1],o.B=a.data[2],o.A=a.data[3],o}initContext(){if(this.context==null)return this.canvas==null&&this.image!=null&&(this.canvas=document.createElement("canvas"),this.canvas.width=this.image.width,this.canvas.height=this.image.height,this.context=this.canvas.getContext("2d"),this.context.drawImage(this.image,0,0),this.image=null),this.alpha=1,this.pixelated=1,this.line_width=1,this.context=this.canvas.getContext("2d"),this.context.lineCap="round",this.centered?(this.translation_x=this.width/2,this.translation_y=this.height/2,this.rotation=0,this.scale_x=1,this.scale_y=-1,this.image_transform=!0,this.anchor_x=0,this.anchor_y=0,this.object_scale_y=-1):(this.translation_x=0,this.translation_y=0,this.rotation=0,this.scale_x=1,this.scale_y=1,this.image_transform=!1,this.anchor_x=-1,this.anchor_y=1,this.object_scale_y=1),this.object_rotation=0,this.object_scale_x=1,this.font="BitCell"}clear(t){var n,o,a;return this.initContext(),o=this.context.fillStyle,a=this.context.strokeStyle,n=this.context.globalCompositeOperation,this.context.globalAlpha=1,this.context.globalCompositeOperation="source-over",t!=null?this.setColor(t):this.context.fillStyle="#000",this.context.fillRect(0,0,this.width,this.height),this.context.fillStyle=o,this.context.strokeStyle=a,this.context.globalCompositeOperation=n}setColor(t){if(this.initContext(),t!=null&&typeof t=="string")return this.context.fillStyle=t,this.context.strokeStyle=t}setAlpha(t){return this.initContext(),this.alpha=t}setPixelated(t){return this.initContext(),this.pixelated=t}setBlending(t){return this.initContext(),t=BLENDING_MODES[t||"normal"]||"source-over",this.context.globalCompositeOperation=t}setLineWidth(t){return this.initContext(),this.line_width=t}setLineDash(t){return this.initContext(),Array.isArray(t)?this.context.setLineDash(t):this.context.setLineDash([])}setLinearGradient(t,n,o,a,h,u){var p;return this.initContext(),p=this.context.createLinearGradient(t,n,o,a),p.addColorStop(0,h),p.addColorStop(1,u),this.context.fillStyle=p,this.context.strokeStyle=p}setRadialGradient(t,n,o,a,h){var u;return this.initContext(),u=this.context.createRadialGradient(t,n,0,t,n,o),u.addColorStop(0,a),u.addColorStop(1,h),this.context.fillStyle=u,this.context.strokeStyle=u}setFont(t){return this.font=t||"Verdana"}setTranslation(t,n){return this.initContext(),this.translation_x=t,this.translation_y=n,isFinite(this.translation_x)||(this.translation_x=0),isFinite(this.translation_y)||(this.translation_y=0),this.updateScreenTransform()}setScale(t,n){return this.initContext(),this.scale_x=t,this.scale_y=n,(!isFinite(this.scale_x)||this.scale_x===0)&&(this.scale_x=1),(!isFinite(this.scale_y)||this.scale_y===0)&&(this.scale_y=1),this.updateScreenTransform()}setRotation(t){return this.initContext(),this.rotation=t,isFinite(this.rotation)||(this.rotation=0),this.updateScreenTransform()}updateScreenTransform(){return this.image_transform=this.translation_x!==0||this.translation_y!==0||this.scale_x!==1||this.scale_y!==1||this.rotation!==0}setDrawAnchor(t,n){if(this.initContext(),this.anchor_x=t,this.anchor_y=n,typeof this.anchor_x!="number"&&(this.anchor_x=0),typeof this.anchor_y!="number")return this.anchor_y=0}setDrawRotation(t){return this.initContext(),this.object_rotation=t}setDrawScale(t,n=t){return this.initContext(),this.object_scale_x=t,this.object_scale_y=n}initDrawOp(t,n,o=!0){var a;return a=!1,this.image_transform&&(this.context.save(),a=!0,this.context.translate(this.translation_x,this.translation_y),this.context.scale(this.scale_x,this.scale_y),this.context.rotate(this.rotation/180*Math.PI),this.context.translate(t,n)),o&&(this.object_rotation!==0||this.object_scale_x!==1||this.object_scale_y!==1)&&(a||(this.context.save(),a=!0,this.context.translate(t,n)),this.object_rotation!==0&&this.context.rotate(this.object_rotation/180*Math.PI),(this.object_scale_x!==1||this.object_scale_y!==1)&&this.context.scale(this.object_scale_x,this.object_scale_y)),a}closeDrawOp(t,n){return this.context.restore()}fillRect(t,n,o,a,h){return this.initContext(),this.setColor(h),this.context.globalAlpha=this.alpha,this.initDrawOp(t,n)?(this.context.fillRect(-o/2-this.anchor_x*o/2,-a/2+this.anchor_y*a/2,o,a),this.closeDrawOp(t,n)):this.context.fillRect(t-o/2-this.anchor_x*o/2,n-a/2+this.anchor_y*a/2,o,a)}fillRoundRect(t,n,o,a,h=10,u){return this.initContext(),this.setColor(u),this.context.globalAlpha=this.alpha,this.initDrawOp(t,n)?(this.context.fillRoundRect(-o/2-this.anchor_x*o/2,-a/2+this.anchor_y*a/2,o,a,h),this.closeDrawOp(t,n)):this.context.fillRoundRect(t-o/2-this.anchor_x*o/2,n-a/2+this.anchor_y*a/2,o,a,h)}fillRound(t,n,o,a,h){return this.initContext(),this.setColor(h),this.context.globalAlpha=this.alpha,o=Math.abs(o),a=Math.abs(a),this.initDrawOp(t,n)?(this.context.beginPath(),this.context.ellipse(-this.anchor_x*o/2,0+this.anchor_y*a/2,o/2,a/2,0,0,Math.PI*2,!1),this.context.fill(),this.closeDrawOp(t,n)):(this.context.beginPath(),this.context.ellipse(t-this.anchor_x*o/2,n+this.anchor_y*a/2,o/2,a/2,0,0,Math.PI*2,!1),this.context.fill())}drawRect(t,n,o,a,h){return this.initContext(),this.setColor(h),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,this.initDrawOp(t,n)?(this.context.strokeRect(-o/2-this.anchor_x*o/2,-a/2+this.anchor_y*a/2,o,a),this.closeDrawOp(t,n)):this.context.strokeRect(t-o/2-this.anchor_x*o/2,n-a/2+this.anchor_y*a/2,o,a)}drawRoundRect(t,n,o,a,h=10,u){return this.initContext(),this.setColor(u),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,this.initDrawOp(t,n)?(this.context.strokeRoundRect(-o/2-this.anchor_x*o/2,-a/2+this.anchor_y*a/2,o,a,h),this.closeDrawOp(t,n)):this.context.strokeRoundRect(t-o/2-this.anchor_x*o/2,n-a/2+this.anchor_y*a/2,o,a,h)}drawRound(t,n,o,a,h){return this.initContext(),this.setColor(h),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,o=Math.abs(o),a=Math.abs(a),this.initDrawOp(t,n)?(this.context.beginPath(),this.context.ellipse(0-this.anchor_x*o/2,0+this.anchor_y*a/2,o/2,a/2,0,0,Math.PI*2,!1),this.context.stroke(),this.closeDrawOp(t,n)):(this.context.beginPath(),this.context.ellipse(t-this.anchor_x*o/2,n+this.anchor_y*a/2,o/2,a/2,0,0,Math.PI*2,!1),this.context.stroke())}drawLine(t,n,o,a,h){var u;if(this.initContext(),this.setColor(h),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,u=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(t,n),this.context.lineTo(o,a),this.context.stroke(),u)return this.closeDrawOp()}drawPolyline(){var t,n,o,a,h,u;if(t=arguments,this.initContext(),t.length>0&&t.length%2===1&&typeof t[t.length-1]=="string"&&this.setColor(t[t.length-1]),Array.isArray(t[0])&&(t[1]!=null&&typeof t[1]=="string"&&this.setColor(t[1]),t=t[0]),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,!(t.length<4)){for(a=Math.floor(t.length/2),u=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(t[0],t[1]),n=o=1,h=a-1;1<=h?o<=h:o>=h;n=1<=h?++o:--o)this.context.lineTo(t[n*2],t[n*2+1]);if(this.context.stroke(),u)return this.closeDrawOp()}}drawPolygon(){var t,n,o,a,h,u;if(t=arguments,this.initContext(),t.length>0&&t.length%2===1&&typeof t[t.length-1]=="string"&&this.setColor(t[t.length-1]),Array.isArray(t[0])&&(t[1]!=null&&typeof t[1]=="string"&&this.setColor(t[1]),t=t[0]),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,!(t.length<4)){for(a=Math.floor(t.length/2),u=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(t[0],t[1]),n=o=1,h=a-1;1<=h?o<=h:o>=h;n=1<=h?++o:--o)this.context.lineTo(t[n*2],t[n*2+1]);if(this.context.closePath(),this.context.stroke(),u)return this.closeDrawOp()}}fillPolygon(){var t,n,o,a,h,u;if(t=arguments,this.initContext(),t.length>0&&t.length%2===1&&typeof t[t.length-1]=="string"&&this.setColor(t[t.length-1]),Array.isArray(t[0])&&(t[1]!=null&&typeof t[1]=="string"&&this.setColor(t[1]),t=t[0]),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,!(t.length<4)){for(a=Math.floor(t.length/2),u=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(t[0],t[1]),n=o=1,h=a-1;1<=h?o<=h:o>=h;n=1<=h?++o:--o)this.context.lineTo(t[n*2],t[n*2+1]);if(this.context.fill(),u)return this.closeDrawOp()}}drawQuadCurve(){var t,n,o,a;if(t=arguments,this.initContext(),t.length>0&&t.length%2===1&&typeof t[t.length-1]=="string"&&this.setColor(t[t.length-1]),Array.isArray(t[0])&&(t[1]!=null&&typeof t[1]=="string"&&this.setColor(t[1]),t=t[0]),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,!(t.length<4)){for(o=Math.floor(t.length/2),a=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(t[0],t[1]),n=2;n<=t.length-4;)this.context.quadraticCurveTo(t[n],t[n+1],t[n+2],t[n+3]),n+=4;if(this.context.stroke(),a)return this.closeDrawOp()}}drawBezierCurve(){var t,n,o,a;if(t=arguments,this.initContext(),t.length>0&&t.length%2===1&&typeof t[t.length-1]=="string"&&this.setColor(t[t.length-1]),Array.isArray(t[0])&&(t[1]!=null&&typeof t[1]=="string"&&this.setColor(t[1]),t=t[0]),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,!(t.length<4)){for(o=Math.floor(t.length/2),a=this.initDrawOp(0,0,!1),this.context.beginPath(),this.context.moveTo(t[0],t[1]),n=2;n<=t.length-6;)this.context.bezierCurveTo(t[n],t[n+1],t[n+2],t[n+3],t[n+4],t[n+5]),n+=6;if(this.context.stroke(),a)return this.closeDrawOp()}}drawArc(t,n,o,a,h,u,p){return this.initContext(),this.setColor(p),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,this.initDrawOp(t,n)?(this.context.beginPath(),this.context.arc(0,0,o,a/180*Math.PI,h/180*Math.PI,u),this.context.stroke(),this.closeDrawOp(t,-n)):(this.context.beginPath(),this.context.arc(t,n,o,a/180*Math.PI,h/180*Math.PI,u),this.context.stroke())}fillArc(t,n,o,a,h,u,p){return this.initContext(),this.setColor(p),this.context.globalAlpha=this.alpha,this.context.lineWidth=this.line_width,this.initDrawOp(t,n)?(this.context.beginPath(),this.context.arc(0,0,o,a/180*Math.PI,h/180*Math.PI,u),this.context.fill(),this.closeDrawOp(t,-n)):(this.context.beginPath(),this.context.arc(t,n,o,a/180*Math.PI,h/180*Math.PI,u),this.context.fill())}textWidth(t,n){return this.initContext(),this.context.font=`${n}pt ${this.font}`,this.context.measureText(t).width}drawText(t,n,o,a,h){var u,p;return this.initContext(),this.setColor(h),this.context.globalAlpha=this.alpha,this.context.font=`${a}pt ${this.font}`,this.context.textAlign="center",this.context.textBaseline="middle",p=this.context.measureText(t).width,u=a,this.initDrawOp(n,o)?(this.context.fillText(t,0-this.anchor_x*p/2,0+this.anchor_y*u/2),this.closeDrawOp(n,o)):this.context.fillText(t,n-this.anchor_x*p/2,o+this.anchor_y*u/2)}drawTextOutline(t,n,o,a,h){var u,p;return this.initContext(),this.setColor(h),this.context.globalAlpha=this.alpha,this.context.font=`${a}pt ${this.font}`,this.context.lineWidth=this.line_width,this.context.textAlign="center",this.context.textBaseline="middle",p=this.context.measureText(t).width,u=a,this.initDrawOp(n,o)?(this.context.strokeText(t,0-this.anchor_x*p/2,0+this.anchor_y*u/2),this.closeDrawOp(n,o)):this.context.strokeText(t,n-this.anchor_x*p/2,o+this.anchor_y*u/2)}getSpriteFrame(t){var n,o,a;if(o=null,typeof t=="string")a=window.player.runtime.sprites[t],a!=null?t=a:(a=t.split("."),a.length>1&&(t=window.player.runtime.sprites[a[0]],o=a[1]|0));else if(t instanceof c)return t.canvas||t.image;return t==null||!t.ready?null:t.frames.length>1?(o==null&&(n=1e3/t.fps,o=Math.floor((Date.now()-t.animation_start)/n)%t.frames.length),o>=0&&o<t.frames.length?t.frames[o].canvas:t.frames[0].canvas):t.frames[0]!=null?t.frames[0].canvas:null}drawImage(t,n,o,a,h){return this.drawSprite(t,n,o,a,h)}drawSprite(t,n,o,a,h){var u;if(this.initContext(),u=this.getSpriteFrame(t),u!=null)return a==null&&(a=u.width),h||(h=a/u.width*u.height),this.context.globalAlpha=this.alpha,this.context.imageSmoothingEnabled=!this.pixelated,this.initDrawOp(n,o)?(this.context.drawImage(u,-a/2-this.anchor_x*a/2,-h/2+this.anchor_y*h/2,a,h),this.closeDrawOp(n,o)):this.context.drawImage(u,n-a/2-this.anchor_x*a/2,o-h/2+this.anchor_y*h/2,a,h)}drawImagePart(t,n,o,a,h,u,p,d,g){return this.drawSpritePart(t,n,o,a,h,u,p,d,g)}drawSpritePart(t,n,o,a,h,u,p,d,g){var P;if(this.initContext(),P=this.getSpriteFrame(t),P!=null)return d==null&&(d=P.width),g||(g=d/a*h),this.context.globalAlpha=this.alpha,this.context.imageSmoothingEnabled=!this.pixelated,this.initDrawOp(u,p)?(this.context.drawImage(P,n,o,a,h,-d/2-this.anchor_x*d/2,-g/2+this.anchor_y*g/2,d,g),this.closeDrawOp(u,p)):this.context.drawImage(P,n,o,a,h,u-d/2-this.anchor_x*d/2,p-g/2+this.anchor_y*g/2,d,g)}drawMap(t,n,o,a,h){if(this.initContext(),typeof t=="string"&&(t=window.player.runtime.maps[t]),!(t==null||!t.ready))return this.context.globalAlpha=this.alpha,this.context.imageSmoothingEnabled=!this.pixelated,this.initDrawOp(n,o)?(t.draw(this.context,-a/2-this.anchor_x*a/2,-h/2+this.anchor_y*h/2,a,h),this.closeDrawOp(n,o)):t.draw(this.context,n-a/2-this.anchor_x*a/2,o-h/2+this.anchor_y*h/2,a,h)}}return c.classname="Image",c}.call(this),this.BLENDING_MODES={normal:"source-over",additive:"lighter"},ref=["source-over","source-in","source-out","source-atop","destination-over","destination-in","destination-out","destination-atop","lighter","copy","xor","multiply","screen","overlay","darken","lighten","color-dodge","color-burn","hard-light","soft-light","difference","exclusion","hue","saturation","color","luminosity"],j=0,len1=ref.length;j<len1;j++)b=ref[j],this.BLENDING_MODES[b]=b;this.MicroMap=function(){function c(e,t,n,o){this.width=e,this.height=t,this.block_width=n,this.block_height=o,this.sprites=window.player.runtime.sprites,this.map=[],this.ready=!0,this.clear()}return c.prototype.clear=function(){var e,t,n,o,a,h;for(t=n=0,a=this.height-1;n<=a;t=n+=1)for(e=o=0,h=this.width-1;o<=h;e=o+=1)this.map[e+t*this.width]=null},c.prototype.set=function(e,t,n){if(e>=0&&e<this.width&&t>=0&&t<this.height)return typeof n=="string"&&(n=n.replace(/\//g,"-")),this.map[e+t*this.width]=n,this.needs_update=!0},c.prototype.get=function(e,t){var n;return e<0||t<0||e>=this.width||t>=this.height?0:(n=this.map[e+t*this.width],typeof n=="string"&&(n=n.replace(/-/g,"/")),n||0)},c.prototype.getCanvas=function(){return(this.canvas==null||this.needs_update)&&this.update(),this.canvas},c.prototype.draw=function(e,t,n,o,a){var h,u,p,d,g,P,v,O;if(this.animated!=null&&this.animated.length>0){for(O=Date.now(),(this.buffer==null||this.buffer.width!==this.block_width*this.width||this.buffer.height!==this.block_height*this.height)&&(console.info("creating buffer"),this.buffer=document.createElement("canvas"),this.buffer.width=this.block_width*this.width,this.buffer.height=this.block_height*this.height),p=this.buffer.getContext("2d"),p.clearRect(0,0,this.buffer.width,this.buffer.height),p.drawImage(this.getCanvas(),0,0),v=this.animated,d=0,P=v.length;d<P;d++)h=v[d],g=h.sprite.frames.length,u=h.sprite.frames[Math.floor(O/1e3*h.sprite.fps)%g].canvas,h.tx!=null?p.drawImage(u,h.tx,h.ty,this.block_width,this.block_height,h.x,h.y,this.block_width,this.block_height):p.drawImage(u,h.x,h.y,this.block_width,this.block_height);e.drawImage(this.buffer,t,n,o,a)}else e.drawImage(this.getCanvas(),t,n,o,a)},c.prototype.update=function(){var e,t,n,o,a,h,u,p,d,g,P,v,O,y,x;for(this.needs_update=!1,this.canvas==null&&(this.canvas=document.createElement("canvas")),(this.canvas.width!==this.width*this.block_width||this.canvas.height!==this.height*this.block_height)&&(this.canvas.width=this.width*this.block_width,this.canvas.height=this.height*this.block_height),n=this.canvas.getContext("2d"),n.clearRect(0,0,this.canvas.width,this.canvas.height),this.animated=[],h=u=0,d=this.height-1;u<=d;h=u+=1)for(o=p=0,g=this.width-1;p<=g;o=p+=1)if(a=o+(this.height-1-h)*this.width,P=this.map[a],P!=null&&P.length>0&&(P=P.split(":"),v=this.sprites[P[0]],v==null&&(v=this.sprites[P[0].replace(/-/g,"/")]),v!=null&&v.frames[0]!=null)){if(v.frames.length>1){e={x:this.block_width*o,y:this.block_height*h,w:this.block_width,h:this.block_height,sprite:v},P[1]!=null&&(x=P[1].split(","),e.tx=x[0]*this.block_width,e.ty=x[1]*this.block_height),this.animated.push(e);continue}P[1]!=null?(x=P[1].split(","),O=x[0]*this.block_width,y=x[1]*this.block_height,t=v.frames[0].canvas,t!=null&&t.width>0&&t.height>0&&n.drawImage(t,O,y,this.block_width,this.block_height,this.block_width*o,this.block_height*h,this.block_width,this.block_height)):(t=v.frames[0].canvas,t!=null&&t.width>0&&t.height>0&&n.drawImage(t,this.block_width*o,this.block_height*h))}},c.prototype.loadFile=function(e){var t;return t=new XMLHttpRequest,t.onreadystatechange=function(n){return function(o){if(t.readyState===XMLHttpRequest.DONE&&t.status===200)return n.load(t.responseText,n.sprites),n.update()}}(this),t.open("GET",e),t.send()},c.prototype.load=function(e,t){var n,o,a,h,u,p,d;for(e=JSON.parse(e),this.width=e.width,this.height=e.height,this.block_width=e.block_width,this.block_height=e.block_height,o=a=0,u=e.height-1;a<=u;o=a+=1)for(n=h=0,p=e.width-1;h<=p;n=h+=1)d=e.data[n+o*e.width],d>0?this.map[n+o*e.width]=e.sprites[d]:this.map[n+o*e.width]=null},c.prototype.clone=function(){var e,t,n,o,a,h,u;for(a=new c(this.width,this.height,this.block_width,this.block_height,this.sprites),t=n=0,h=this.height-1;n<=h;t=n+=1)for(e=o=0,u=this.width-1;o<=u;e=o+=1)a.map[e+t*this.width]=this.map[e+t*this.width];return a.needs_update=!0,a},c.prototype.copyFrom=function(e){var t,n,o,a,h,u;for(this.width=e.width,this.height=e.height,this.block_width=e.block_width,this.block_height=e.block_height,n=o=0,h=this.height-1;o<=h;n=o+=1)for(t=a=0,u=this.width-1;a<=u;t=a+=1)this.map[t+n*this.width]=e.map[t+n*this.width];return this.update(),this},c}(),this.LoadMap=function(c,e){var t,n;return t=new MicroMap(1,1,1,1),t.ready=!1,n=new XMLHttpRequest,n.onreadystatechange=function(o){return function(a){if(n.readyState===XMLHttpRequest.DONE&&(t.ready=!0,n.status===200&&UpdateMap(t,n.responseText),t.needs_update=!0,e!=null))return e()}}(this),n.open("GET",c),n.send(),t},this.UpdateMap=function(c,e){var t,n,o,a,h,u,p;for(e=JSON.parse(e),c.width=e.width,c.height=e.height,c.block_width=e.block_width,c.block_height=e.block_height,n=o=0,h=e.height-1;o<=h;n=o+=1)for(t=a=0,u=e.width-1;a<=u;t=a+=1)p=e.data[t+n*e.width],p>0?c.map[t+n*e.width]=e.sprites[p]:c.map[t+n*e.width]=null;return c.needs_update=!0,c},this.SaveMap=function(c){var e,t,n,o,a,h,u,p,d,g,P,v,O,y,x,A;for(n=1,u=[0],A={},o=a=0,P=c.height-1;a<=P;o=a+=1)for(t=h=0,v=c.width-1;h<=v;t=h+=1)x=c.map[t+o*c.width],x!=null&&x.length>0&&A[x]==null&&(u.push(x),A[x]=n++);for(p=[],o=d=0,O=c.height-1;d<=O;o=d+=1)for(t=g=0,y=c.width-1;g<=y;t=g+=1)x=c.map[t+o*c.width],p[t+o*c.width]=x!=null&&x.length>0?A[x]:0;return e={width:c.width,height:c.height,block_width:c.block_width,block_height:c.block_height,sprites:u,data:p},JSON.stringify(e)},this.AudioCore=function(){function AudioCore(c){this.runtime=c,this.buffer=[],this.getContext(),this.playing=[],this.wakeup_list=[]}return AudioCore.prototype.isStarted=function(){return this.context.state==="running"},AudioCore.prototype.addToWakeUpList=function(c){return this.wakeup_list.push(c)},AudioCore.prototype.getInterface=function(){var c;return c=this,this.interface={beep:function(e){return c.beep(e)},cancelBeeps:function(){return c.cancelBeeps()},playSound:function(e,t,n,o,a){return c.playSound(e,t,n,o,a)},playMusic:function(e,t,n){return c.playMusic(e,t,n)}}},AudioCore.prototype.playSound=function(c,e,t,n,o){var a;return e==null&&(e=1),t==null&&(t=1),n==null&&(n=0),o==null&&(o=0),typeof c=="string"&&(a=this.runtime.sounds[c.replace(/\//g,"-")],a!=null)?a.play(e,t,n,o):0},AudioCore.prototype.playMusic=function(c,e,t){var n;return e==null&&(e=1),t==null&&(t=0),typeof c=="string"&&(n=this.runtime.music[c.replace(/\//g,"-")],n!=null)?n.play(e,t):0},AudioCore.prototype.start=function(){var blob,src;return this.script_processor=this.context.createScriptProcessor(4096,2,2),this.processor_funk=function(c){return function(e){return c.onAudioProcess(e)}}(this),this.script_processor.onaudioprocess=this.processor_funk,this.script_processor.connect(this.context.destination),src=`class AudioWorkletProcessor {
  constructor() {
    this.port = {} ;

    var _this = this ;

    this.port.postMessage = function(data) {
      var event = { data: data } ;
      _this.port.onmessage(event) ;
    }
  }

} ;
registerProcessor = function(a,b) {
  return new MyWorkletProcessor()
} ;
`,src+=AudioCore.processor,this.node=eval(src),this.flushBuffer(),this.bufferizer=new AudioBufferizer(this.node)},AudioCore.prototype.flushBuffer=function(){var c;for(c=[];this.buffer.length>0;)c.push(this.node.port.postMessage(this.buffer.splice(0,1)[0]));return c},AudioCore.prototype.onAudioProcess=function(c){var e,t,n;e=c.outputBuffer.getChannelData(0),n=c.outputBuffer.getChannelData(1),t=[[e,n]],this.bufferizer.flush(t)},AudioCore.prototype.getContext=function(){var c;return this.context==null&&(this.context=new(window.AudioContext||window.webkitAudioContext),this.context.state!=="running"?(c=function(e){return function(){var t,n,o,a;for(console.info("resuming context"),e.context.resume(),e.beeper!=null&&e.start(),a=e.wakeup_list,n=0,o=a.length;n<o;n++)t=a[n],t.wakeUp();return document.body.removeEventListener("touchend",c),document.body.removeEventListener("mouseup",c)}}(this),document.body.addEventListener("touchend",c),document.body.addEventListener("mouseup",c)):this.beeper!=null&&this.start()),this.context},AudioCore.prototype.getBeeper=function(){return this.beeper==null&&(this.beeper=new Beeper(this),this.context.state==="running"&&this.start()),this.beeper},AudioCore.prototype.beep=function(c){return this.getBeeper().beep(c)},AudioCore.prototype.addBeeps=function(c){var e,t,n;for(t=0,n=c.length;t<n;t++)e=c[t],e.duration*=this.context.sampleRate,e.increment=e.frequency/this.context.sampleRate;return this.node!=null?this.node.port.postMessage(JSON.stringify({name:"beep",sequence:c})):this.buffer.push(JSON.stringify({name:"beep",sequence:c}))},AudioCore.prototype.cancelBeeps=function(){return this.node!=null?this.node.port.postMessage(JSON.stringify({name:"cancel_beeps"})):this.buffer.push(JSON.stringify({name:"cancel_beeps"})),this.stopAll()},AudioCore.prototype.addPlaying=function(c){return this.playing.push(c)},AudioCore.prototype.removePlaying=function(c){var e;if(e=this.playing.indexOf(c),e>=0)return this.playing.splice(e,1)},AudioCore.prototype.stopAll=function(){var c,e,t,n,o;for(o=this.playing,e=0,t=o.length;e<t;e++){n=o[e];try{n.stop()}catch(a){c=a,console.error(c)}}return this.playing=[]},AudioCore.processor=`class MyWorkletProcessor extends AudioWorkletProcessor {
  constructor() {
    super();
    this.beeps = [] ;
    this.last = 0 ;
    this.port.onmessage = (event) => {
      let data = JSON.parse(event.data) ;
      if (data.name == "cancel_beeps")
      {
        this.beeps = [] ;
      }
      else if (data.name == "beep")
      {
        let seq = data.sequence ;
        for (let i=0;i<seq.length;i++)
        {
          let note = seq[i] ;
          if (i>0)
          {
            seq[i-1].next = note ;
          }

          if (note.loopto != null)
          {
            note.loopto = seq[note.loopto] ;
          }

          note.phase = 0 ;
          note.time = 0 ;
        }

        this.beeps.push(seq[0]) ;
      }
    } ;
  }

  process(inputs, outputs, parameters) {
    var output = outputs[0] ;
    var phase ;
    for (var i=0;i<output.length;i++)
    {
      var channel = output[i] ;
      if (i>0)
      {
        for (var j=0;j<channel.length;j++)
        {
          channel[j] = output[0][j]
        }
      }
      else
      {
        for (var j=0;j<channel.length;j++)
        {
          let sig = 0 ;
          for (var k=this.beeps.length-1;k>=0;k--)
          {
            let b = this.beeps[k];
            let volume = b.volume ;
            if (b.time/b.duration>b.span)
              {
                volume = 0 ;
              }
            if (b.waveform == "square")
            {
              sig += b.phase>.5? volume : -volume ;
            }
            else if (b.waveform == "saw")
            {
              sig += (b.phase*2-1)*volume ;
            }
            else if (b.waveform == "noise")
            {
              sig += (Math.random()*2-1)*volume ;
            }
            else
            {
              sig += Math.sin(b.phase*Math.PI*2)*volume ;
            }

            b.phase = (b.phase+b.increment)%1 ;
            b.time += 1 ;
            if (b.time>=b.duration)
            {
              b.time = 0 ;
              if (b.loopto != null)
              {
                if (b.repeats != null && b.repeats>0)
                {
                  if (b.loopcount == null)
                  {
                    b.loopcount = 0 ;
                  }
                  b.loopcount++ ;
                  if (b.loopcount>=b.repeats)
                  {
                    b.loopcount = 0 ;
                    if (b.next != null)
                    {
                      b.next.phase = b.phase ;
                      b = b.next ;
                      this.beeps[k] = b ;
                    }
                    else
                    {
                      this.beeps.splice(k,1) ;
                    }
                  }
                  else
                  {
                    b.loopto.phase = b.phase ;
                    b = b.loopto ;
                    this.beeps[k] = b ;
                  }
                }
                else
                {
                  b.loopto.phase = b.phase ;
                  b = b.loopto ;
                  this.beeps[k] = b ;
                }
              }
              else if (b.next != null)
              {
                b.next.phase = b.phase ;
                b = b.next ;
                this.beeps[k] = b ;
              }
              else
              {
                this.beeps.splice(k,1) ;
              }
            }
          }
          this.last = this.last*.9+sig*.1 ;
          channel[j] = this.last ;
        }
      }
    }
    return true ;
  }
}

registerProcessor('my-worklet-processor', MyWorkletProcessor);`,AudioCore}(),this.AudioBufferizer=function(){function c(e){var t,n,o,a,h,u;for(this.node=e,this.buffer_size=4096,this.chunk_size=512,this.chunks=[],this.nb_chunks=this.buffer_size/this.chunk_size,t=n=0,h=this.nb_chunks-1;n<=h;t=n+=1)a=function(){var p,d,g;for(g=[],o=p=0,d=this.chunk_size-1;0<=d?p<=d:p>=d;o=0<=d?++p:--p)g.push(0);return g}.call(this),u=function(){var p,d,g;for(g=[],o=p=0,d=this.chunk_size-1;0<=d?p<=d:p>=d;o=0<=d?++p:--p)g.push(0);return g}.call(this),this.chunks[t]=[[a,u]];this.current=0,setInterval(function(p){return function(){return p.step()}}(this),this.chunk_size/44100*1e3)}return c.prototype.step=function(){this.current>=this.chunks.length||(this.node.process(null,this.chunks[this.current],null),this.current++)},c.prototype.flush=function(e){for(var t,n,o,a,h,u,p,d,g,P,v,O;this.current<this.chunks.length;)this.step();for(this.current=0,p=e[0][0],O=e[0][1],o=0,t=0,n=a=0,P=this.chunks.length-1;0<=P?a<=P:a>=P;n=0<=P?++a:--a)for(t=this.chunks[n],u=t[0][0],g=t[0][1],h=d=0,v=u.length-1;0<=v?d<=v:d>=v;h=0<=v?++d:--d)p[o]=u[h],O[o]=g[h],o+=1},c}(),this.Beeper=function(){function c(e){var t,n,o,a,h,u,p,d,g,P,v;for(this.audio=e,this.notes={},this.plain_notes={},v=[["C","DO"],["C#","DO#","Db","REb"],["D","RE"],["D#","RE#","Eb","MIb"],["E","MI"],["F","FA"],["F#","FA#","Gb","SOLb"],["G","SOL"],["G#","SOL#","Ab","LAb"],["A","LA"],["A#","LA#","Bb","SIb"],["B","SI"]],t=n=0;n<=127;t=n+=1){for(this.notes[t]=t,d=Math.floor(t/12)-1,g=v[t%12],o=0,h=g.length;o<h;o++)p=g[o],this.notes[p+d]=t;if(d===-1)for(P=v[t%12],a=0,u=P.length;a<u;a++)p=P[a],this.plain_notes[p]=t}this.current_octave=5,this.current_duration=.5,this.current_volume=.5,this.current_span=1,this.current_waveform="square"}return c.prototype.beep=function(e){var t,n,o,a,h,u,p,d,g,P,v,O,y,x,A;for(A="loop 0 square tempo 120 duration 500 volume 50 span 50 DO2 DO - FA SOL SOL FA -",y="normal",O=[],h=[],g=e.split(" "),n=0,a=g.length;n<a;n++)if(x=g[n],x!=="")switch(y){case"normal":this.notes[x]!=null?(d=this.notes[x],this.current_octave=Math.floor(d/12),O.push({frequency:440*Math.pow(Math.pow(2,1/12),d-69),volume:this.current_volume,span:this.current_span,duration:this.current_duration,waveform:this.current_waveform})):this.plain_notes[x]!=null?(d=this.plain_notes[x]+this.current_octave*12,O.push({frequency:440*Math.pow(Math.pow(2,1/12),d-69),volume:this.current_volume,span:this.current_span,duration:this.current_duration,waveform:this.current_waveform})):x==="square"||x==="sine"||x==="saw"||x==="noise"?this.current_waveform=x:x==="tempo"||x==="duration"||x==="volume"||x==="span"||x==="loop"||x==="to"?y=x:x==="-"?O.push({frequency:440,volume:0,span:this.current_span,duration:this.current_duration,waveform:this.current_waveform}):x==="end"&&h.length>0&&O.length>0&&(O.push({frequency:440,volume:0,span:this.current_span,duration:0,waveform:this.current_waveform}),u=h.splice(h.length-1,1)[0],O[O.length-1].loopto=u.start,O[O.length-1].repeats=u.repeats);break;case"tempo":y="normal",x=Number.parseFloat(x),!Number.isNaN(x)&&x>0&&(this.current_duration=60/x);break;case"duration":y="normal",x=Number.parseFloat(x),!Number.isNaN(x)&&x>0&&(this.current_duration=x/1e3);break;case"volume":y="normal",x=Number.parseFloat(x),Number.isNaN(x)||(this.current_volume=x/100);break;case"span":y="normal",x=Number.parseFloat(x),Number.isNaN(x)||(this.current_span=x/100);break;case"loop":y="normal",h.push({start:O.length}),x=Number.parseFloat(x),Number.isNaN(x)||(h[h.length-1].repeats=x);break;case"to":if(y="normal",d!=null&&(p=null,this.notes[x]!=null?p=this.notes[x]:this.plain_notes[x]!=null&&(p=this.plain_notes[x]+this.current_octave*12),p!=null&&p!==d)){for(t=o=P=d,v=p;P<=v?o<=v:o>=v;t=P<=v?++o:--o)t!==d&&O.push({frequency:440*Math.pow(Math.pow(2,1/12),t-69),volume:this.current_volume,span:this.current_span,duration:this.current_duration,waveform:this.current_waveform});d=p}}return h.length>0&&O.length>0&&(u=h.splice(h.length-1,1)[0],O.push({frequency:440,volume:0,span:this.current_span,duration:0,waveform:this.current_waveform}),O[O.length-1].loopto=u.start,O[O.length-1].repeats=u.repeats),this.audio.addBeeps(O)},c}(),this.Sound=class Ft{constructor(e,t){var n;this.audio=e,this.url=t,typeof MicroSound<"u"&&MicroSound!==null&&(this.class=MicroSound),this.url instanceof AudioBuffer?(this.buffer=this.url,this.ready=1):(this.ready=0,n=new XMLHttpRequest,n.open("GET",this.url,!0),n.responseType="arraybuffer",n.onload=()=>this.audio.context.decodeAudioData(n.response,o=>(this.buffer=o,this.ready=1)),n.send())}play(e=1,t=1,n=0,o=!1){var a,h,u,p,d;if(this.buffer!=null)return d=this.audio.context.createBufferSource(),d.playbackRate.value=t,d.buffer=this.buffer,o&&(d.loop=!0),a=this.audio.context.createGain(),a.gain.value=e,h=this.audio.context.createPanner(),h.panningModel="equalpower",h.setPan=function(g){return h.setPosition(g,0,1-Math.abs(g))},h.setPan(n),d.connect(a),a.connect(h),h.connect(this.audio.context.destination),d.start(),u=null,o&&(u={stop:()=>d.stop()},this.audio.addPlaying(u)),p={stop:()=>(d.stop(),u&&this.audio.removePlaying(u),1),setVolume:function(g){return a.gain.value=Math.max(0,Math.min(1,g))},setPitch:function(g){return d.playbackRate.value=Math.max(.001,Math.min(1e3,g))},setPan:function(g){return h.setPan(Math.max(-1,Math.min(1,g)))},getDuration:function(){return d.buffer.duration},finished:!1},d.onended=function(){return p.finished=!0},p}static createSoundClass(e){return window.MicroSound=function(){var t;return t=class{constructor(n,o,a=44100){var h,u,p,d;this.class=MicroSound,n=n===1?1:2,(!(o>1)||!(o<44100*1e3))&&(o=44100),(!(a>=8e3)||!(a<=96e3))&&(a=44100),h=e.context.createBuffer(n,o,a),d=new Ft(e,h),this.channels=n,this.length=o,this.sampleRate=a,u=h.getChannelData(0),n===2&&(p=h.getChannelData(1)),this.play=function(g,P,v,O){return d.play(g,P,v,O)},this.write=function(g,P,v){if(g===0)return u=h.getChannelData(0),u[P]=v;if(n===2)return p=h.getChannelData(1),p[P]=v},this.read=function(g,P){return g===0?(u=h.getChannelData(0),u[P]):n===2?(p=h.getChannelData(1),p[P]):0}}},t.classname="Sound",t}.call(this)}},this.Music=function(){function c(e,t){this.audio=e,this.url=t,this.tag=new Audio(this.url),this.playing=!1}return c.prototype.play=function(e,t){return e==null&&(e=1),t==null&&(t=!1),this.playing=!0,this.tag.loop=!!t,this.tag.volume=e,this.audio.isStarted()?this.tag.play():this.audio.addToWakeUpList(this),this.audio.addPlaying(this),{play:function(n){return function(){return n.tag.play()}}(this),stop:function(n){return function(){return n.playing=!1,n.tag.pause(),n.audio.removePlaying(n)}}(this),setVolume:function(n){return function(o){return n.tag.volume=Math.max(0,Math.min(1,o))}}(this),getPosition:function(n){return function(){return n.tag.currentTime}}(this),getDuration:function(n){return function(){return n.tag.duration}}(this),setPosition:function(n){return function(o){if(n.tag.pause(),n.tag.currentTime=Math.max(0,Math.min(n.tag.duration,o)),n.playing)return n.tag.play()}}(this)}},c.prototype.wakeUp=function(){if(this.playing)return this.tag.play()},c.prototype.stop=function(){return this.playing=!1,this.tag.pause()},c}(),this.Player=function(){function c(e){var t,n,o,a;if(this.listener=e,this.source_count=0,this.sources={},this.resources=resources,this.request_id=1,this.pending_requests={},resources.sources!=null)for(o=resources.sources,t=0,n=o.length;t<n;t++)a=o[t],this.loadSource(a);else this.sources.main=document.getElementById("code").innerText,this.start()}return c.prototype.loadSource=function(e){var t;return t=new XMLHttpRequest,t.onreadystatechange=function(n){return function(o){var a;if(t.readyState===XMLHttpRequest.DONE&&t.status===200&&(a=e.file.split(".")[0],n.sources[a]=t.responseText,n.source_count++,n.source_count>=resources.sources.length&&n.runtime==null))return n.start()}}(this),t.open("GET",location.origin+location.pathname+("ms/"+e.file+"?v="+e.version)),t.send()},c.prototype.start=function(){var e,t,n;return this.runtime=new Runtime(window.exported_project?"":location.origin+location.pathname,this.sources,resources,this),this.client=new PlayerClient(this),n=document.getElementById("canvaswrapper"),n.appendChild(this.runtime.screen.canvas),window.addEventListener("resize",function(o){return function(){return o.resize()}}(this)),this.resize(),t=function(o){return function(a){return a.preventDefault(),o.runtime.screen.canvas.removeEventListener("touchstart",t),!0}}(this),e=function(o){return function(a){return o.setFullScreen(),!0}}(this),this.runtime.screen.canvas.addEventListener("touchstart",t),this.runtime.screen.canvas.addEventListener("touchend",e),this.runtime.start(),window.addEventListener("message",function(o){return function(a){return o.messageReceived(a)}}(this)),this.postMessage({name:"focus"})},c.prototype.resize=function(){var e,t,n,o;if(this.runtime.screen.resize(),this.runtime.vm!=null){if(this.runtime.vm.context.global.draw==null){this.runtime.update_memory={},t=this.runtime.sources,n=[];for(e in t)o=t[e],n.push(this.runtime.updateSource(e,o,!1));return n}else if(this.runtime.stopped)return this.runtime.drawCall()}},c.prototype.setFullScreen=function(){var e;if(document.documentElement.webkitRequestFullScreen!=null&&!document.webkitIsFullScreen?document.documentElement.webkitRequestFullScreen():document.documentElement.requestFullScreen!=null&&!document.fullScreen?document.documentElement.requestFullScreen():document.documentElement.mozRequestFullScreen!=null&&!document.mozFullScreen&&document.documentElement.mozRequestFullScreen(),window.screen!=null&&window.screen.orientation!=null&&((e=window.orientation)==="portrait"||e==="landscape"))return window.screen.orientation.lock(window.orientation).then(null,function(t){})},c.prototype.reportError=function(e){return this.postMessage({name:"error",data:e})},c.prototype.log=function(e){return this.postMessage({name:"log",data:e})},c.prototype.codePaused=function(){return this.postMessage({name:"code_paused"})},c.prototype.exit=function(){return this.postMessage({name:"exit"})},c.prototype.messageReceived=function(e){var t,n,o,a;n=e.data;try{switch(n=JSON.parse(n),n.name){case"command":return this.runtime.runCommand(n.line,function(h){return function(u){if(!n.line.trim().startsWith("print"))return h.postMessage({name:"output",data:u,id:n.id})}}(this));case"pause":return this.runtime.stop();case"step_forward":return this.runtime.stepForward();case"resume":return this.runtime.resume();case"code_updated":return t=n.code,a=n.file.split(".")[0],this.runtime.vm!=null&&this.runtime.vm.clearWarnings(),this.runtime.updateSource(a,t,!0);case"sprite_updated":return a=n.file,this.runtime.updateSprite(a,0,n.data,n.properties);case"map_updated":return a=n.file,this.runtime.updateMap(a,0,n.data);case"take_picture":if(this.runtime.screen.takePicture(function(h){return function(u){return h.postMessage({name:"picture_taken",data:u})}}(this)),this.runtime.stopped)return this.runtime.drawCall();break;case"time_machine":return this.runtime.time_machine.messageReceived(n);case"watch":return this.runtime.watch(n.list);case"stop_watching":return this.runtime.stopWatching();default:if(n.request_id!=null&&this.pending_requests[n.request_id]!=null)return this.pending_requests[n.request_id](n),delete this.pending_requests[n.request_id]}}catch(h){return o=h,console.error(o)}},c.prototype.call=function(e,t){if(this.runtime!=null&&this.runtime.vm!=null)return this.runtime.vm.call(e,t)},c.prototype.setGlobal=function(e,t){if(this.runtime!=null&&this.runtime.vm!=null)return this.runtime.vm.context.global[e]=t},c.prototype.exec=function(e,t){if(this.runtime!=null)return this.runtime.runCommand(e,t)},c.prototype.postMessage=function(e){var t;if(window!==window.parent&&window.parent.postMessage(JSON.stringify(e),"*"),this.listener!=null)try{return this.listener(e)}catch(n){return t=n,console.error(t)}},c.prototype.postRequest=function(e,t){return e.request_id=this.request_id,this.pending_requests[this.request_id++]=t,this.postMessage(e)},c}(),navigator.serviceWorker!=null&&!window.skip_service_worker&&navigator.serviceWorker.register("sw.js",{scope:location.pathname}).then(function(c){return console.log("Registration succeeded. Scope is"+c.scope)}).catch(function(c){return console.log("Registration failed with"+c)}),this.PlayerClient=class{constructor(e){var t;if(this.player=e,this.pending_requests={},this.request_id=0,this.version_checked=!1,this.reconnect_delay=1e3,location.protocol.startsWith("http")&&!window.exported_project){try{this.connect()}catch(n){t=n,console.error(t)}setInterval(()=>{if(this.socket!=null)return this.sendRequest({name:"ping"})},3e4)}}connect(){return this.socket=new WebSocket(window.location.origin.replace("http","ws")),this.socket.onmessage=e=>{var t;console.info("received: "+e.data);try{if(e=JSON.parse(e.data),e.request_id!=null&&this.pending_requests[e.request_id]!=null&&(this.pending_requests[e.request_id](e),delete this.pending_requests[e.request_id]),e.name==="project_file_updated"&&this.player.runtime.projectFileUpdated(e.type,e.file,e.version,e.data,e.properties),e.name==="project_file_deleted"&&this.player.runtime.projectFileDeleted(e.type,e.file),e.name==="project_options_updated")return this.player.runtime.projectOptionsUpdated(e)}catch(n){return t=n,console.error(t)}},this.socket.onopen=()=>{var e,t,n,o,a,h,u,p,d,g,P,v,O,y,x,A,I,S,C;if(this.reconnect_delay=1e3,C=location.pathname.split("/")[1],P=location.pathname.split("/")[2],this.buffer!=null){for(v=this.buffer,e=0,a=v.length;e<a;e++)d=v[e],this.send(d);delete this.buffer}if(this.send({name:"listen_to_project",user:C,project:P}),!this.version_checked){for(this.version_checked=!0,S={},g={},I={},O=this.player.resources.images,t=0,h=O.length;t<h;t++)A=O[t],S[A.file.split(".")[0]]=A.version;for(y=this.player.resources.maps,n=0,u=y.length;n<u;n++)A=y[n],g[A.file.split(".")[0]]=A.version;for(x=this.player.resources.sources,o=0,p=x.length;o<p;o++)A=x[o],I[A.file.split(".")[0]]=A.version;return this.sendRequest({name:"get_file_versions",user:C,project:P},G=>{var Y,L,J,Q,U,N,V;J=G.data.sources;for(L in J)Y=J[L],V=I[L],(V==null||V!==Y.version)&&this.player.runtime.projectFileUpdated("ms",L,Y.version,null,Y.properties);Q=G.data.sprites;for(L in Q)Y=Q[L],V=S[L],(V==null||V!==Y.version)&&this.player.runtime.projectFileUpdated("sprites",L,Y.version,null,Y.properties);U=G.data.maps,N=[];for(L in U)Y=U[L],V=g[L],V==null||V!==Y.version?N.push(this.player.runtime.projectFileUpdated("maps",L,Y.version,null,Y.properties)):N.push(void 0);return N})}},this.socket.onclose=()=>(setTimeout(()=>this.connect(),this.reconnect_delay),this.reconnect_delay+=1e3)}send(e){return this.socket.readyState!==1?(this.buffer==null&&(this.buffer=[]),this.buffer.push(e)):this.socket.send(JSON.stringify(e))}sendRequest(e,t){return e.request_id=this.request_id++,this.pending_requests[e.request_id]=t,this.send(e)}};
